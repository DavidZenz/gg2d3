---
title: "Getting started with gg2d3"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Getting started with gg2d3}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  eval = FALSE
)
```

gg2d3 renders ggplot2 plots as interactive D3.js SVG widgets in the browser.
Pass any ggplot object to `gg2d3()` and get an htmlwidget you can view in
RStudio, R Markdown, Shiny, or any web page.

## Basic usage

```{r}
library(ggplot2)
library(gg2d3)

p <- ggplot(mtcars, aes(wt, mpg, color = factor(cyl))) +
  geom_point() +
  ggtitle("Motor Trend Cars")

gg2d3(p)
```

The widget size defaults to the viewer/container size. Override with `width`
and `height` (in pixels or CSS units):

```{r}
gg2d3(p, width = 800, height = 500)
```

## Supported geoms

gg2d3 supports 15 geom types. All aesthetics that ggplot2 maps (color, fill,
size, shape, alpha, linewidth) are carried through to D3.

### Points, lines, and paths

```{r}
# Scatter plot
ggplot(iris, aes(Sepal.Length, Sepal.Width, color = Species)) +
  geom_point(size = 3) |>
  gg2d3()

# Line chart (connects points in x order)
ggplot(economics, aes(date, unemploy)) +
  geom_line() |>
  gg2d3()

# Path (connects points in data order)
ggplot(data.frame(x = cos(1:50), y = sin(1:50)), aes(x, y)) +
  geom_path() |>
  gg2d3()
```

### Bars and columns

```{r}
# geom_bar (counts)
ggplot(mpg, aes(class, fill = class)) +
  geom_bar() |>
  gg2d3()

# geom_col (values) with stacking
ggplot(mpg, aes(class, fill = drv)) +
  geom_bar(position = "stack") |>
  gg2d3()
```

### Rectangles, tiles, and text

```{r}
# Heatmap with geom_tile
ggplot(faithfuld, aes(waiting, eruptions, fill = density)) +
  geom_tile() |>
  gg2d3()

# Text labels
ggplot(mtcars, aes(wt, mpg, label = rownames(mtcars))) +
  geom_text(size = 3) |>
  gg2d3()
```

### Area and ribbon

```{r}
# Area chart
ggplot(economics, aes(date, unemploy)) +
  geom_area(fill = "steelblue", alpha = 0.5) |>
  gg2d3()

# Ribbon (confidence band)
ggplot(economics, aes(date, unemploy)) +
  geom_ribbon(aes(ymin = unemploy - 500, ymax = unemploy + 500),
              alpha = 0.3) +
  geom_line() |>
  gg2d3()
```

### Segments and reference lines

```{r}
ggplot(mtcars, aes(wt, mpg)) +
  geom_point() +
  geom_hline(yintercept = 20, linetype = "dashed", color = "red") +
  geom_vline(xintercept = 3, linetype = "dotted", color = "blue") |>
  gg2d3()
```

`geom_segment` and `geom_abline` are also supported.

### Statistical geoms

These geoms are pre-computed in R (via ggplot2's stat system) and rendered
by D3. No JavaScript statistics are needed.

```{r}
# Boxplot
ggplot(mpg, aes(class, hwy)) +
  geom_boxplot() |>
  gg2d3()

# Violin
ggplot(mpg, aes(class, hwy, fill = class)) +
  geom_violin() |>
  gg2d3()

# Density
ggplot(diamonds, aes(price, fill = cut)) +
  geom_density(alpha = 0.5) |>
  gg2d3()

# Smooth (loess or lm)
ggplot(mpg, aes(displ, hwy)) +
  geom_point() +
  geom_smooth(method = "loess") |>
  gg2d3()
```

## Scales

### Continuous transforms

Log, sqrt, and reverse transforms work as expected:

```{r}
ggplot(diamonds, aes(carat, price)) +
  geom_point(alpha = 0.1) +
  scale_y_log10() |>
  gg2d3()
```

### Date and datetime scales

Date and POSIXct columns are automatically detected and rendered with
temporal D3 scales. Axis tick labels use the format from ggplot2's
`date_labels` argument:

```{r}
df <- data.frame(
  date = seq(as.Date("2024-01-01"), as.Date("2024-12-31"), by = "month"),
  value = cumsum(rnorm(12))
)

ggplot(df, aes(date, value)) +
  geom_line() +
  geom_point() +
  scale_x_date(date_labels = "%b %Y") |>
  gg2d3()
```

POSIXct (datetime) works the same way:

```{r}
df <- data.frame(
  time = as.POSIXct("2024-01-01") + (0:23) * 3600,
  temp = 15 + 5 * sin(seq(0, 2 * pi, length.out = 24)) + rnorm(24, sd = 0.5)
)

ggplot(df, aes(time, temp)) +
  geom_line() +
  scale_x_datetime(date_labels = "%H:%M") |>
  gg2d3()
```

Timezone information from `scale_x_datetime(timezone = ...)` is preserved in
tooltips.

## Coordinates

### coord_flip

Swaps x and y axes. All geoms and scales adapt automatically:

```{r}
ggplot(mpg, aes(class, hwy)) +
  geom_boxplot() +
  coord_flip() |>
  gg2d3()
```

### coord_fixed

Enforces a fixed aspect ratio between x and y units:

```{r}
ggplot(mtcars, aes(wt, mpg)) +
  geom_point() +
  coord_fixed(ratio = 1) |>
  gg2d3()
```

## Faceting

### facet_wrap

Wraps panels into rows by one or more variables:

```{r}
ggplot(mpg, aes(displ, hwy)) +
  geom_point() +
  facet_wrap(~class) |>
  gg2d3()
```

With free scales:

```{r}
ggplot(mpg, aes(displ, hwy)) +
  geom_point() +
  facet_wrap(~class, scales = "free") |>
  gg2d3()
```

### facet_grid

Lays out panels in a grid defined by row and column variables:

```{r}
ggplot(mpg, aes(displ, hwy)) +
  geom_point() +
  facet_grid(drv ~ cyl) |>
  gg2d3()
```

Free scales work per-row (`"free_y"`) or per-column (`"free_x"`):

```{r}
ggplot(mpg, aes(displ, hwy)) +
  geom_point() +
  facet_grid(drv ~ cyl, scales = "free") |>
  gg2d3()
```

## Legends

Legends are generated automatically from mapped aesthetics. All standard
legend types are supported:

- **Discrete color/fill** — color swatches with labels
- **Continuous colorbar** — gradient bar for continuous color/fill scales
- **Size** — graduated circles
- **Shape** — different point shapes
- **Alpha** — opacity levels

Legends can be positioned with `theme(legend.position = ...)`:

```{r}
ggplot(iris, aes(Sepal.Length, Sepal.Width, color = Species)) +
  geom_point() +
  theme(legend.position = "bottom") |>
  gg2d3()
```

Use `theme(legend.position = "none")` to hide legends entirely.

When multiple aesthetics share the same variable, guides are merged into a
single legend automatically.

## Theming

gg2d3 translates ggplot2 theme elements to SVG styling:

```{r}
ggplot(mtcars, aes(wt, mpg)) +
  geom_point() +
  theme_minimal() +
  ggtitle("Minimal theme") +
  labs(subtitle = "Rendered with D3", caption = "Source: mtcars") |>
  gg2d3()
```

Theme elements that are translated include:

- Plot, panel, and legend backgrounds
- Major and minor grid lines
- Axis lines, ticks, and text
- Plot title, subtitle, and caption
- Legend title and text styling

## Interactivity

gg2d3 provides a composable pipe-based API for adding interactivity.
Each function takes a widget and returns a widget, so they chain naturally:

```{r}
ggplot(iris, aes(Sepal.Length, Sepal.Width, color = Species)) +
  geom_point(size = 3) |>
  gg2d3() |>
  d3_tooltip() |>
  d3_hover() |>
  d3_zoom() |>
  d3_brush()
```

You can use any combination — they are all optional and independent.

### Tooltips

`d3_tooltip()` shows data values on hover. By default it displays all mapped
aesthetics.

```{r}
# Default: show all aesthetics
gg2d3(p) |> d3_tooltip()

# Show specific fields only
gg2d3(p) |> d3_tooltip(fields = c("wt", "mpg"))

# Custom JavaScript formatter
gg2d3(p) |> d3_tooltip(formatter = "function(d) { return d.mpg + ' mpg'; }")
```

Tooltips automatically format date/datetime values using the browser's locale.

### Hover highlighting

`d3_hover()` dims non-hovered elements so the hovered group stands out.

```{r}
# Default: dim others to 70% opacity
gg2d3(p) |> d3_hover()

# Stronger dimming with highlight stroke
gg2d3(p) |> d3_hover(opacity = 0.3, stroke = "black", stroke_width = 2)
```

When a brush selection is active, hover highlighting is automatically
disabled to avoid visual conflicts.

### Zoom and pan

`d3_zoom()` enables scroll-to-zoom and drag-to-pan. Double-click resets
to the original view.

```{r}
# Default: zoom both axes, 1x to 8x
gg2d3(p) |> d3_zoom()

# Zoom x-axis only, up to 20x
gg2d3(p) |> d3_zoom(direction = "x", scale_extent = c(1, 20))
```

Axes update dynamically during zoom. Temporal axes preserve their date
formatting.

### Brush selection

`d3_brush()` lets users drag to select a rectangular region. Selected
elements stay at full opacity while others dim.

```{r}
# Default: 2D brush with blue overlay
gg2d3(p) |> d3_brush()

# Horizontal brush only
gg2d3(p) |> d3_brush(direction = "x")

# Custom callback receiving selected data
gg2d3(p) |> d3_brush(
  on_brush = "function(data) { console.log(data.length + ' points selected'); }"
)
```

Double-click clears the brush selection.

### Linked views with Crosstalk

gg2d3 supports [crosstalk](https://rstudio.github.io/crosstalk/) for
linking multiple widgets. Brushing in one widget highlights the same
observations in all linked widgets.

```{r}
library(crosstalk)

shared <- SharedData$new(iris)

p1 <- ggplot(shared, aes(Sepal.Length, Sepal.Width, color = Species)) +
  geom_point()

p2 <- ggplot(shared, aes(Petal.Length, Petal.Width, color = Species)) +
  geom_point()

# Display side by side (e.g. in R Markdown or Shiny)
w1 <- gg2d3(p1) |> d3_tooltip() |> d3_brush()
w2 <- gg2d3(p2) |> d3_tooltip() |> d3_brush()
```

Crosstalk works in static HTML documents — no Shiny server required.

## Combining features

A realistic example combining multiple features:

```{r}
ggplot(mpg, aes(displ, hwy, color = class)) +
  geom_point(size = 2) +
  geom_smooth(method = "loess", se = TRUE) +
  facet_wrap(~year) +
  scale_color_brewer(palette = "Set2") +
  labs(
    title = "Engine displacement vs highway MPG",
    subtitle = "By vehicle class and model year",
    x = "Displacement (L)",
    y = "Highway MPG"
  ) +
  theme_minimal() |>
  gg2d3() |>
  d3_tooltip() |>
  d3_hover() |>
  d3_zoom()
```

## Tips

- **Pipe from ggplot directly:** `ggplot(...) + geom_point() |> gg2d3()`
  works because the pipe binds tighter than `+`.
- **Inspect the IR:** Use `gg2d3:::as_d3_ir(p)` to see exactly what data
  is sent to D3. Useful for debugging unexpected rendering.
- **Widget sizing:** In R Markdown, set chunk options `fig.width` and
  `fig.height` or pass `width`/`height` to `gg2d3()`.
- **Performance:** For large datasets (>10k points), consider using
  `alpha` to reduce overdraw and limit interactivity features to what
  you need.
