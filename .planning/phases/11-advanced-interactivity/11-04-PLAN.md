---
phase: 11-advanced-interactivity
plan: 04
type: execute
wave: 2
depends_on: ["11-01", "11-02", "11-03"]
files_modified:
  - tests/testthat/test-zoom-brush.R
  - tests/testthat/test-crosstalk.R
autonomous: false

must_haves:
  truths:
    - "Unit tests verify d3_zoom() pipe function correctness"
    - "Unit tests verify d3_brush() pipe function correctness"
    - "Unit tests verify crosstalk SharedData detection"
    - "Visual verification confirms zoom, brush, and linked views work in browser"
    - "All three features can be composed: gg2d3(p) |> d3_zoom() |> d3_brush() |> d3_tooltip()"
  artifacts:
    - path: "tests/testthat/test-zoom-brush.R"
      provides: "Unit tests for zoom and brush pipe functions"
      min_lines: 40
    - path: "tests/testthat/test-crosstalk.R"
      provides: "Unit tests for crosstalk integration"
      min_lines: 20
  key_links:
    - from: "tests/testthat/test-zoom-brush.R"
      to: "R/d3_zoom.R"
      via: "Tests d3_zoom() pipe function output structure"
      pattern: "d3_zoom|interactivity.*zoom"
    - from: "tests/testthat/test-zoom-brush.R"
      to: "R/d3_brush.R"
      via: "Tests d3_brush() pipe function output structure"
      pattern: "d3_brush|interactivity.*brush"
    - from: "tests/testthat/test-crosstalk.R"
      to: "R/gg2d3.R"
      via: "Tests SharedData detection and key extraction"
      pattern: "SharedData|crosstalk"
---

<objective>
Comprehensive testing and visual verification for all Phase 11 features: zoom, brush, crosstalk, and Shiny integration.

Purpose: Ensure all advanced interactivity features work correctly individually and when composed together. Visual verification catches browser-specific issues that unit tests cannot detect (per Phase 10 lesson).

Output: Unit test files, visual verification confirmation.
</objective>

<execution_context>
@/Users/davidzenz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davidzenz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-advanced-interactivity/11-RESEARCH.md
@.planning/phases/11-advanced-interactivity/11-01-SUMMARY.md
@.planning/phases/11-advanced-interactivity/11-02-SUMMARY.md
@.planning/phases/11-advanced-interactivity/11-03-SUMMARY.md
@.planning/phases/10-interactivity-foundation/10-03-SUMMARY.md
@tests/testthat/test-interactivity.R
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create unit tests for zoom, brush, and crosstalk</name>
  <files>tests/testthat/test-zoom-brush.R, tests/testthat/test-crosstalk.R</files>
  <action>
**Create tests/testthat/test-zoom-brush.R** following the pattern from tests/testthat/test-interactivity.R:

Test d3_zoom():
- `d3_zoom() requires gg2d3 widget` - errors on non-widget input
- `d3_zoom() stores zoom config with defaults` - check widget$x$interactivity$zoom has enabled=TRUE, scale_extent=c(1,8), direction="both"
- `d3_zoom() stores custom scale_extent` - verify custom values stored correctly
- `d3_zoom() stores x-only direction` - direction="x" stored
- `d3_zoom() stores y-only direction` - direction="y" stored
- `d3_zoom() validates scale_extent` - errors on non-numeric, length != 2, min < 1
- `d3_zoom() is pipe-composable with d3_tooltip` - gg2d3(p) |> d3_zoom() |> d3_tooltip() has both configs
- `d3_zoom() preserves widget class` - result still inherits "gg2d3"
- `d3_zoom() adds onRender callback` - widget has onRender in htmlwidgets attrs

Test d3_brush():
- `d3_brush() requires gg2d3 widget` - errors on non-widget input
- `d3_brush() stores brush config with defaults` - check widget$x$interactivity$brush has enabled=TRUE, direction="xy", fill="#3b82f6", opacity=0.15
- `d3_brush() stores x-only direction` - direction="x" stored
- `d3_brush() stores y-only direction` - direction="y" stored
- `d3_brush() stores custom fill and opacity` - custom values stored
- `d3_brush() is pipe-composable with d3_zoom` - both configs present
- `d3_brush() preserves widget class` - result still inherits "gg2d3"
- `Full composition works` - gg2d3(p) |> d3_zoom() |> d3_brush() |> d3_tooltip() |> d3_hover() has all four configs

**Create tests/testthat/test-crosstalk.R:**

Test crosstalk detection (conditional on crosstalk availability):
- Wrap tests in `skip_if_not_installed("crosstalk")`
- `gg2d3() detects SharedData` - create SharedData, build ggplot from it, pass to gg2d3(), verify crosstalk_key and crosstalk_group in widget$x
- `gg2d3() works without SharedData` - verify crosstalk_key is NULL for regular data
- `gg2d3() extracts correct keys` - verify key values match SharedData$key()
- `gg2d3() extracts correct group` - verify group name matches SharedData$groupName()
- `Crosstalk dependencies attached` - verify widget$dependencies includes crosstalk libs

Run `Rscript -e "pkgload::load_all(); devtools::test()"` to execute all tests.
  </action>
  <verify>
Run `Rscript -e "pkgload::load_all(); testthat::test_file('tests/testthat/test-zoom-brush.R')"` - all pass.
Run `Rscript -e "pkgload::load_all(); testthat::test_file('tests/testthat/test-crosstalk.R')"` - all pass (or skip if crosstalk not installed).
Run `Rscript -e "pkgload::load_all(); devtools::test()"` - no regressions in existing tests.
  </verify>
  <done>
All zoom unit tests pass.
All brush unit tests pass.
All crosstalk unit tests pass (or skip gracefully).
No regressions in existing test suite (Phase 10 interactivity tests still pass).
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Visual verification of zoom, brush, and linked views</name>
  <files>tests/testthat/test-zoom-brush.R, tests/testthat/test-crosstalk.R</files>
  <action>
Generate test HTML files and open in browser for manual verification of all Phase 11 interactive features.

Run these R commands to generate test HTML files:

**Scenario 1: Basic zoom**
```r
pkgload::load_all()
library(ggplot2)
p <- ggplot(mtcars, aes(mpg, wt, color = factor(cyl))) + geom_point(size = 3)
w <- gg2d3(p) |> d3_zoom() |> d3_tooltip()
htmlwidgets::saveWidget(w, "test_zoom.html", selfcontained = FALSE)
browseURL("test_zoom.html")
```

**Scenario 2: Brush selection**
```r
p <- ggplot(mtcars, aes(mpg, wt)) + geom_point(size = 3)
w <- gg2d3(p) |> d3_brush() |> d3_tooltip()
htmlwidgets::saveWidget(w, "test_brush.html", selfcontained = FALSE)
browseURL("test_brush.html")
```

**Scenario 3: X-only brush**
```r
p <- ggplot(mtcars, aes(mpg, wt)) + geom_point(size = 3)
w <- gg2d3(p) |> d3_brush(direction = "x")
htmlwidgets::saveWidget(w, "test_brush_x.html", selfcontained = FALSE)
browseURL("test_brush_x.html")
```

**Scenario 4: Zoom + Brush composition**
```r
p <- ggplot(mtcars, aes(mpg, wt, color = factor(cyl))) + geom_point(size = 3)
w <- gg2d3(p) |> d3_zoom() |> d3_brush() |> d3_tooltip() |> d3_hover()
htmlwidgets::saveWidget(w, "test_all.html", selfcontained = FALSE)
browseURL("test_all.html")
```

**Scenario 5: Bar chart brush**
```r
p <- ggplot(mtcars, aes(factor(cyl), fill = factor(cyl))) + geom_bar()
w <- gg2d3(p) |> d3_brush()
htmlwidgets::saveWidget(w, "test_brush_bars.html", selfcontained = FALSE)
browseURL("test_brush_bars.html")
```
  </action>
  <verify>
Verify in browser:
- Scenario 1: Mouse wheel zooms, drag pans, axes update, double-click resets, tooltips work while zoomed, points stay in panel bounds
- Scenario 2: Click-drag creates blue selection, points inside opaque, outside dimmed, double-click clears, tooltips work
- Scenario 3: Brush selects horizontal band only
- Scenario 4: All four features coexist without event conflicts
- Scenario 5: Bar chart brush highlights bars within selection

Clean up test files after verification:
```r
file.remove("test_zoom.html", "test_brush.html", "test_brush_x.html", "test_all.html", "test_brush_bars.html")
unlink("test_zoom_files", recursive = TRUE)
unlink("test_brush_files", recursive = TRUE)
unlink("test_brush_x_files", recursive = TRUE)
unlink("test_all_files", recursive = TRUE)
unlink("test_brush_bars_files", recursive = TRUE)
```
  </verify>
  <done>
All visual verification scenarios pass.
Zoom works: wheel, pan, axis update, reset, clip-path respected.
Brush works: selection rect, highlight/dim, clear, categorical support.
Composition works: zoom + brush + tooltip + hover coexist.
  </done>
</task>

</tasks>

<verification>
1. All unit tests pass (zoom, brush, crosstalk)
2. No regressions in existing test suite
3. Visual verification confirms zoom works (wheel, pan, reset)
4. Visual verification confirms brush works (select, highlight, clear)
5. Visual verification confirms feature composition (zoom + brush + tooltip + hover)
6. Bar chart categorical brush works
</verification>

<success_criteria>
- 15+ unit tests covering zoom, brush, and crosstalk pipe functions
- All existing tests still pass (no regressions)
- Visual verification passes for zoom, brush, and composition
- All Phase 11 success criteria from roadmap met:
  1. d3_zoom() with drag pan
  2. Brush selection highlights data
  3. Crosstalk integration for linked brushing
  4. Shiny integration for server-side updates
  5. Double-click resets zoom and brush
</success_criteria>

<output>
After completion, create `.planning/phases/11-advanced-interactivity/11-04-SUMMARY.md`
</output>
