---
phase: 06-layout-engine
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - R/as_d3_ir.R
  - R/validate_ir.R
  - inst/htmlwidgets/modules/layout.js
  - inst/htmlwidgets/gg2d3.yaml
autonomous: true
user_setup: []

must_haves:
  truths:
    - "calculateLayout() returns pixel positions for panel, axes, titles, and legend area"
    - "R IR contains tick label strings for text width estimation"
    - "R IR contains legend.position extracted from theme"
    - "R IR contains secondary axis presence (x2/y2) flags"
    - "Layout engine is a pure function with no DOM dependency"
    - "Box manipulation utilities (shrinkBox, sliceTop/Bottom/Left/Right) produce correct geometry"
  artifacts:
    - path: "inst/htmlwidgets/modules/layout.js"
      provides: "calculateLayout() pure function and box utilities"
      min_lines: 150
      exports: ["calculateLayout"]
    - path: "R/as_d3_ir.R"
      provides: "Layout metadata in IR (tickLabels, legend.position, secondary axes)"
      contains: "tickLabels"
    - path: "R/validate_ir.R"
      provides: "Updated validation accepting new IR fields"
    - path: "inst/htmlwidgets/gg2d3.yaml"
      provides: "layout.js in module load order"
      contains: "layout.js"
  key_links:
    - from: "R/as_d3_ir.R"
      to: "inst/htmlwidgets/modules/layout.js"
      via: "IR JSON fields consumed by calculateLayout config"
      pattern: "tickLabels|legend\\.position|axes\\.x2|axes\\.y2"
    - from: "inst/htmlwidgets/modules/layout.js"
      to: "inst/htmlwidgets/modules/theme.js"
      via: "Uses theme accessor and constants for unit conversion"
      pattern: "window\\.gg2d3\\.theme|window\\.gg2d3\\.constants"
---

<objective>
Create the layout engine module and extract layout metadata from R into the IR.

Purpose: Establish the `calculateLayout()` pure function that computes pixel positions for all chart components using subtraction-based allocation (outside-in: margins -> titles -> legends -> axes -> panel gets remainder). Also enrich the IR with tick label strings, legend position, and secondary axis presence so the layout engine can estimate space requirements.

Output: New `layout.js` module with complete layout calculation, updated IR with layout metadata, YAML wiring.
</objective>

<execution_context>
@/Users/davidzenz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davidzenz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-layout-engine/06-RESEARCH.md
@inst/htmlwidgets/modules/theme.js
@inst/htmlwidgets/modules/constants.js
@inst/htmlwidgets/gg2d3.yaml
@R/as_d3_ir.R
@R/validate_ir.R
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract layout metadata in R-side IR</name>
  <files>R/as_d3_ir.R, R/validate_ir.R</files>
  <action>
Add layout metadata extraction to `as_d3_ir()` in R/as_d3_ir.R. Insert the following extractions BEFORE the final `ir <- list(...)` construction (around line 484):

1. **Extract tick label strings** from panel_params for text width estimation in JS:
```r
# Extract axis tick labels as strings for JS layout text measurement
# Use the un-swapped panel_params (pp_x, pp_y) already computed above
x_tick_labels <- tryCatch({
  labs <- pp_x$get_labels()
  labs <- labs[!is.na(labs)]
  as.character(labs)
}, error = function(e) character(0))

y_tick_labels <- tryCatch({
  labs <- pp_y$get_labels()
  labs <- labs[!is.na(labs)]
  as.character(labs)
}, error = function(e) character(0))
```

2. **Extract secondary axis presence** from panel_params:
```r
# Detect secondary axes (Phase 6 reserves space, future phases render)
has_sec_x <- tryCatch({
  sec <- b$layout$panel_params[[1]]$x.sec
  !is.null(sec) && !inherits(sec, "waiver")
}, error = function(e) FALSE)

has_sec_y <- tryCatch({
  sec <- b$layout$panel_params[[1]]$y.sec
  !is.null(sec) && !inherits(sec, "waiver")
}, error = function(e) FALSE)
```

3. **Extract legend position** from theme:
```r
# Extract legend position from theme for layout engine
legend_position <- tryCatch({
  complete_theme <- ggplot2::theme_get() + b$plot$theme
  pos <- ggplot2:::calc_element("legend.position", complete_theme)
  if (is.character(pos)) pos else "right"
}, error = function(e) "right")
```

4. **Extract subtitle and caption** from plot labels:
```r
subtitle_text <- b$plot$labels$subtitle %||% ""
caption_text <- b$plot$labels$caption %||% ""
```

5. **Extract additional theme elements** for layout: add subtitle and caption theme extraction to the theme_ir block (around line 461):
```r
# Inside the theme_ir construction, add to the 'text' section:
text = list(
  title = extract_theme_element("plot.title", b$plot$theme),
  subtitle = extract_theme_element("plot.subtitle", b$plot$theme),
  caption = extract_theme_element("plot.caption", b$plot$theme)
)
```

6. **Update the IR construction** (the `ir <- list(...)` call) to include new fields:
- Change `title = b$plot$labels$title %||% ""` to keep as-is
- Add `subtitle = subtitle_text` and `caption = caption_text` at top level
- Update `axes` to include tickLabels: `x = list(orientation = "bottom", label = x_label, tickLabels = x_tick_labels)` and same for y
- Add `x2 = if (has_sec_x) list(enabled = TRUE) else NULL` and `y2 = if (has_sec_y) list(enabled = TRUE) else NULL` inside axes
- Update `legend = list(enabled = TRUE, position = legend_position)`

7. **Update validate_ir.R**: No structural changes needed since the new fields (tickLabels, subtitle, caption, x2, y2) are additive and optional. The existing validation checks `scales`, `layers`, and layer structure which remain unchanged.

IMPORTANT: Wrap all new extractions in tryCatch to handle edge cases gracefully. Use `%||%` for null fallbacks. The tick label extraction uses `pp_x` and `pp_y` which are already computed earlier in the function (around line 394-400) as un-swapped panel_params.
  </action>
  <verify>
Run `devtools::load_all()` and `devtools::test()` from R console. All existing tests must pass. Then verify new fields appear:
```r
library(ggplot2)
p <- ggplot(mtcars, aes(wt, mpg)) + geom_point() + labs(title = "Test", subtitle = "Sub", caption = "Cap")
ir <- as_d3_ir(p)
stopifnot(!is.null(ir$axes$x$tickLabels))
stopifnot(!is.null(ir$axes$y$tickLabels))
stopifnot(length(ir$axes$x$tickLabels) > 0)
stopifnot(ir$legend$position == "right")
stopifnot(ir$subtitle == "Sub")
stopifnot(ir$caption == "Cap")
stopifnot(is.null(ir$axes$x2))  # no secondary axis
```
  </verify>
  <done>IR contains tickLabels arrays for x and y axes, legend.position string, subtitle/caption strings, and secondary axis flags. All existing tests pass.</done>
</task>

<task type="auto">
  <name>Task 2: Create layout.js module with calculateLayout() and box utilities</name>
  <files>inst/htmlwidgets/modules/layout.js, inst/htmlwidgets/gg2d3.yaml</files>
  <action>
Create `inst/htmlwidgets/modules/layout.js` following the `window.gg2d3` namespace pattern from other modules. The module must:

**1. Box manipulation utilities (pure functions):**
- `shrinkBox(box, margin)` - Inset a box by {top, right, bottom, left} amounts. Returns new box {x, y, w, h}.
- `sliceTop(box, amount)` - Returns {sliced: {x,y,w,h}, remaining: {x,y,w,h}}
- `sliceBottom(box, amount)` - Same pattern
- `sliceLeft(box, amount)` - Same pattern
- `sliceRight(box, amount)` - Same pattern
- `sliceSide(box, position, width, height)` - Dispatches to slice* based on position string ("right"|"left"|"top"|"bottom")

**2. Text estimation functions (pure, no DOM):**
- `estimateTextHeight(fontSizePx)` - Returns `fontSizePx * 1.2` (line height)
- `estimateTextWidth(text, fontSizePx)` - Returns `text.length * fontSizePx * 0.6` (average char width for sans-serif)
- `estimateMaxTextWidth(labels, fontSizePx)` - Returns max width across array of label strings

**3. Theme extraction helpers:**
- `getPlotMargin(theme)` - Gets plot.margin from theme, returns {top, right, bottom, left} in px. Falls back to default 7.3px each.
- `getTitleSize(theme)` - Gets font sizes for title/subtitle/caption from theme. Returns {title: px, subtitle: px, caption: px}. Uses ptToPx from constants. Default: title=13.2pt, subtitle=11pt, caption=8.8pt.
- `getAxisTextSize(theme)` - Gets axis.text.x and axis.text.y font sizes. Default 8.8pt.
- `getAxisTitleSize(theme)` - Gets axis.title.x and axis.title.y font sizes. Default 11pt.
- `getTickLength(theme)` - Returns tick length in px. ggplot2 default: 2.75pt = 3.67px.

Note on theme value extraction: The theme accessor's `.get()` returns objects with a `size` field in POINTS (not pixels) -- this is how R extracts them via `calc_element()`. The helpers must convert pt to px using `window.gg2d3.constants.ptToPx()`. However, `plot.margin` is already in PIXELS (converted in R via `grid::convertUnit`). Check the actual theme values carefully:
- `theme.get("axis.text")` returns `{type: "text", size: 8.8, ...}` where size is in pt
- `theme.get("plot.margin")` returns `{type: "margin", top: 7.3, ...}` where values are in px

**4. `calculateLayout(config)` function:**

Input config shape:
```javascript
{
  width: number,        // total widget width px
  height: number,       // total widget height px
  theme: themeAccessor, // from createTheme()
  titles: {
    title: string|null,
    subtitle: string|null,
    caption: string|null
  },
  axes: {
    x: { label: string|null, tickLabels: string[] },
    y: { label: string|null, tickLabels: string[] },
    x2: { enabled: boolean }|null,  // secondary top axis
    y2: { enabled: boolean }|null   // secondary right axis
  },
  legend: {
    position: "right"|"left"|"top"|"bottom"|"inside"|"none",
    width: number,   // 0 if no legend yet (Phase 7)
    height: number   // 0 if no legend yet
  },
  coord: {
    type: string,
    flip: boolean,
    ratio: number|null,
    xRange: number,  // x domain extent for coord_fixed
    yRange: number   // y domain extent for coord_fixed
  }
}
```

Algorithm (subtraction-based, outside-in):
1. Start with `{x: 0, y: 0, w: width, h: height}`
2. `shrinkBox` by plot margin
3. `sliceTop` for title area (titleHeight + subtitleHeight, each with 4px gap if present)
4. `sliceBottom` for caption area (captionHeight + 4px gap if present)
5. Compute legend area: if position != "none" and position != "inside", `sliceSide` by legend dimensions. Add legend.box.spacing (default 14.7px gap between panel and legend). For Phase 6, legend width/height will be 0 so no space reserved.
6. Compute axis space:
   - Bottom: xTickHeight + tickLength + xTitleHeight + 8px gap
   - Left: max y-tick label width (estimated from tickLabels strings) + tickLength + yTitleWidth (use estimateTextHeight since it's rotated) + 8px gap
   - Top: only if x2 present (same formula as bottom)
   - Right: only if y2 present (same formula as left)
7. Panel = remaining box after subtracting axis space from all sides
8. Clamp panel to minimum 50x50px
9. Apply coord_fixed aspect ratio if coord.ratio is set:
   - Use same `calculatePanelSize` logic from current gg2d3.js (dataRatio = yRange/xRange, targetAspect = ratio * dataRatio)
   - Center constrained panel in available space
10. Compute derived positions:
    - title: centered horizontally over panel, y = top of title area + baseline offset
    - subtitle: centered horizontally over panel, y = below title
    - caption: centered horizontally over panel, y = bottom of caption area
    - axes.bottom: {x: panel.x, y: panel.y + panel.h, w: panel.w}
    - axes.left: {x: panel.x, y: panel.y, h: panel.h}
    - axes.top: if x2, {x: panel.x, y: panel.y, w: panel.w}; else null
    - axes.right: if y2, {x: panel.x + panel.w, y: panel.y, h: panel.h}; else null
    - axisLabels.x: centered below bottom axis area
    - axisLabels.y: rotated -90, centered left of left axis area
    - legend: position rect (will be {x:0,y:0,w:0,h:0} until Phase 7)
    - clipId: "panel-clip-" + random string

Return LayoutResult shape:
```javascript
{
  total: {w, h},
  plotMargin: {top, right, bottom, left},
  title: {x, y, visible},
  subtitle: {x, y, visible},
  caption: {x, y, visible},
  panel: {x, y, w, h, offsetX, offsetY},  // offsetX/Y for coord_fixed centering
  clipId: string,
  axes: {
    bottom: {x, y, w} | null,
    left: {x, y, h} | null,
    top: {x, y, w} | null,
    right: {x, y, h} | null
  },
  axisLabels: {
    x: {x, y, visible},
    y: {x, y, rotation, visible}
  },
  legend: {x, y, w, h, position},
  panels: null,      // Future: facets
  strips: null,      // Future: facet strips
  secondaryAxes: {top: boolean, right: boolean}
}
```

**5. Export to namespace:**
```javascript
window.gg2d3.layout = {
  calculateLayout: calculateLayout,
  // Export utilities for testing
  estimateTextWidth: estimateTextWidth,
  estimateTextHeight: estimateTextHeight,
  shrinkBox: shrinkBox
};
```

**6. Update gg2d3.yaml:** Add `layout.js` to the module script list. It must load AFTER `constants.js` and `theme.js` (which it depends on) but BEFORE `gg2d3.js` (which will consume it in Plan 06-02). Insert `layout.js` after `theme.js` in the script array:
```yaml
script:
  - constants.js
  - scales.js
  - theme.js
  - layout.js     # <-- NEW
  - geom-registry.js
  - geoms/point.js
  ...
```

IMPORTANT NOTES:
- The layout engine must be a PURE function (no DOM access, no d3 selections). All text measurement uses estimation heuristics.
- Follow existing module pattern: IIFE wrapping, namespace initialization guard, export to window.gg2d3.
- panel.offsetX and panel.offsetY should be 0 unless coord_fixed constrains dimensions (then they center the panel).
- When legend.width and legend.height are both 0, no space is reserved for legend (prevents Phase 6 from creating empty gaps per Research pitfall #5).
  </action>
  <verify>
Verify the file exists, has correct structure, and YAML is valid:
```bash
# Check layout.js exists and has key functions
grep -c "calculateLayout" inst/htmlwidgets/modules/layout.js
grep -c "shrinkBox" inst/htmlwidgets/modules/layout.js
grep -c "estimateTextWidth" inst/htmlwidgets/modules/layout.js
grep -c "window.gg2d3.layout" inst/htmlwidgets/modules/layout.js

# Check YAML has layout.js in correct position
grep "layout.js" inst/htmlwidgets/gg2d3.yaml

# Load package to verify no R errors
Rscript -e "devtools::load_all(); devtools::test()"
```
  </verify>
  <done>layout.js module exports calculateLayout() as a pure function. YAML loads layout.js after theme.js and before geom-registry.js. R package loads and all tests pass.</done>
</task>

</tasks>

<verification>
1. `devtools::test()` passes all existing tests
2. New IR fields (tickLabels, legend.position, subtitle, caption, x2/y2) appear in IR output
3. layout.js exists with calculateLayout, box utilities, and text estimation
4. YAML loads layout.js in correct order (after theme.js, before geom-registry.js)
5. calculateLayout is a pure function (no DOM access, no d3 selections)
</verification>

<success_criteria>
- calculateLayout() accepts a config object and returns a complete LayoutResult with pixel positions for panel, axes, titles, legend area
- R IR contains tick label strings, legend position, subtitle/caption text, and secondary axis flags
- All existing tests continue to pass (no regressions)
- layout.js follows existing module patterns (IIFE, namespace, exports)
</success_criteria>

<output>
After completion, create `.planning/phases/06-layout-engine/06-01-SUMMARY.md`
</output>
