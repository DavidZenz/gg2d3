---
phase: 05-statistical-geoms
plan: 04
type: execute
wave: 3
depends_on: ["05-02", "05-03"]
files_modified:
  - tests/testthat/test-geoms-phase5.R
autonomous: true

must_haves:
  truths:
    - "IR extraction for all Phase 5 stat geoms produces correct structure"
    - "Boxplot data includes five-number summary and outliers as list"
    - "Violin data includes violinwidth column with density values"
    - "Density data has x and y (density estimate) columns"
    - "Smooth data includes x, y, ymin, ymax for fitted line + CI"
    - "GeomSmooth maps to 'smooth' geom type (not 'path')"
    - "All new geom types pass IR validation without warnings"
    - "Histogram still works via existing bar renderer (regression check)"
  artifacts:
    - path: "tests/testthat/test-geoms-phase5.R"
      provides: "Unit tests for Phase 5 stat geom IR extraction and validation"
      min_lines: 100
  key_links:
    - from: "tests/testthat/test-geoms-phase5.R"
      to: "R/as_d3_ir.R"
      via: "Tests call as_d3_ir() and inspect layer structure for stat geoms"
      pattern: "as_d3_ir"
---

<objective>
Add R-side unit tests for all Phase 5 stat geom types and verify end-to-end rendering.

Purpose: Statistical geoms have the most complex data structures in ggplot2 (list-columns for outliers, 512-point density curves, dual-component smooth layers). These tests catch regressions and document expected IR structure for each stat geom type.

Output: Comprehensive test file covering Phase 5 stat geom IR extraction.
</objective>

<execution_context>
@/Users/davidzenz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davidzenz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/05-statistical-geoms/05-01-SUMMARY.md
@tests/testthat/test-geoms-phase4.R
@R/as_d3_ir.R
@R/validate_ir.R
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Phase 5 stat geom IR extraction tests</name>
  <files>tests/testthat/test-geoms-phase5.R</files>
  <action>
  Create a new test file `tests/testthat/test-geoms-phase5.R` with comprehensive tests for Phase 5 stat geom IR extraction. Follow the existing test patterns in `test-geoms-phase4.R`.

  **Tests to include:**

  1. **geom_boxplot basic IR structure:**
     - Create boxplot with `ggplot(mtcars, aes(factor(cyl), mpg)) + geom_boxplot()`
     - Verify geom name is "boxplot"
     - Verify data has correct number of rows (3, one per cyl group)
     - Verify first row has all five-number summary columns: lower, middle, upper, ymin, ymax
     - Verify first row has `outliers` column
     - Verify outliers is a list/vector (not a scalar or NULL)
     - Verify `width` column exists

  2. **geom_boxplot outliers serialization:**
     - Create boxplot known to have outliers (mtcars mpg has outliers for some groups)
     - Extract IR, find a group with outliers
     - Verify outliers field is a numeric vector with length > 0
     - Verify outlier values are within expected range (actual mpg values)

  3. **geom_violin basic IR structure:**
     - Create violin with `ggplot(mtcars, aes(factor(cyl), mpg)) + geom_violin()`
     - Verify geom name is "violin"
     - Verify data has many rows (significantly more than 3 -- should be ~512 * 3 groups = ~1536)
     - Verify first row has `violinwidth` column
     - Verify first row has `y` column (data value)
     - Verify violinwidth is numeric and >= 0

  4. **geom_density basic IR structure:**
     - Create density with `ggplot(mtcars, aes(mpg)) + geom_density()`
     - Use `suppressMessages(as_d3_ir(p))` (density may trigger scale messages)
     - Verify geom name is "density"
     - Verify data has many rows (~512 for one group)
     - Verify first row has `x` and `y` columns
     - Verify y values are non-negative (density is always >= 0)

  5. **geom_density with groups:**
     - Create density with fill groups: `aes(mpg, fill = factor(cyl))`
     - Verify data has ~512 * 3 rows (3 groups)
     - Verify group column exists

  6. **geom_smooth IR structure:**
     - Create smooth with `ggplot(mtcars, aes(wt, mpg)) + geom_smooth(method = "lm")`
     - Use `suppressMessages()` to suppress fitting messages
     - Verify geom name is "smooth" (NOT "path")
     - Verify data has x, y, ymin, ymax columns
     - Verify ymin < y < ymax for fitted values (CI bounds bracket fitted)

  7. **geom_smooth without se (se = FALSE):**
     - Create smooth with `geom_smooth(method = "lm", se = FALSE)`
     - Verify geom name is still "smooth"
     - Verify data has x and y columns
     - Check if ymin/ymax are present (they may still be present but NA, or absent entirely -- test actual behavior)

  8. **geom_histogram works via existing bar renderer:**
     - Create histogram with `ggplot(mtcars, aes(mpg)) + geom_histogram(bins = 10)`
     - Verify geom name is "bar" (GeomBar used by histogram)
     - Verify data has expected structure (x, y, xmin, xmax)

  9. **IR validation accepts all Phase 5 geom types:**
     - Create plots with each stat geom
     - Verify `validate_ir(as_d3_ir(p))` produces no warnings about unrecognized types
     - Use `expect_silent()` pattern from test-geoms-phase4.R

  10. **geom_boxplot with coord_flip:**
      - Verify coord type is "flip" in IR
      - Verify boxplot data structure unchanged by flip

  **Pattern notes:**
  - Use `suppressMessages()` around `as_d3_ir()` for any plot using stat computations that may produce messages
  - ggplot2's stat layers can produce fitting messages (e.g., "using method = 'loess'")
  </action>
  <verify>
  ```r
  devtools::test()
  # All tests should pass, including new Phase 5 tests
  # Specifically: testthat::test_file("tests/testthat/test-geoms-phase5.R")
  ```
  </verify>
  <done>
  All Phase 5 stat geom types have R-side unit tests verifying:
  - Correct geom name in IR (boxplot, violin, density, smooth)
  - Required stat columns present (lower/middle/upper/outliers for boxplot, violinwidth for violin, density for density, ymin/ymax for smooth)
  - List-column outliers correctly serialized as numeric vectors
  - GeomSmooth maps to "smooth" not "path"
  - IR validation passes without warnings
  - Histogram regression test (still works as "bar")
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>All Phase 5 stat geoms: geom_boxplot, geom_violin, geom_density, geom_smooth. Complete R-side IR extraction, D3 rendering, and unit tests.</what-built>
  <how-to-verify>
  Run these verification plots in R and visually inspect the browser output:

  ```r
  devtools::load_all()
  library(ggplot2)

  # 1. Boxplot: basic
  p1 <- ggplot(mtcars, aes(factor(cyl), mpg)) +
    geom_boxplot() +
    ggtitle("Boxplot: mpg by cylinder count")
  gg2d3(p1)
  # EXPECT: Three boxplots with boxes, whiskers, endcaps, and outlier dots
  # Compare with: print(p1)

  # 2. Boxplot: colored + flipped
  p2 <- ggplot(mtcars, aes(factor(cyl), mpg, fill = factor(cyl))) +
    geom_boxplot(alpha = 0.7) + coord_flip() +
    ggtitle("Boxplot: colored, horizontal")
  gg2d3(p2)
  # EXPECT: Horizontal colored boxplots

  # 3. Violin: basic
  p3 <- ggplot(mtcars, aes(factor(cyl), mpg)) +
    geom_violin(fill = "lightblue") +
    ggtitle("Violin: mpg by cylinder count")
  gg2d3(p3)
  # EXPECT: Three symmetric violin shapes showing distribution density
  # Compare with: print(p3)

  # 4. Violin + Boxplot overlay
  p4 <- ggplot(mtcars, aes(factor(cyl), mpg)) +
    geom_violin(fill = "lightblue", alpha = 0.5) +
    geom_boxplot(width = 0.1) +
    ggtitle("Violin + Boxplot overlay")
  gg2d3(p4)
  # EXPECT: Violins with narrow boxplots inside

  # 5. Density: single group
  p5 <- ggplot(mtcars, aes(mpg)) +
    geom_density(fill = "steelblue", alpha = 0.5) +
    ggtitle("Density: mpg distribution")
  gg2d3(p5)
  # EXPECT: Smooth filled density curve

  # 6. Density: multiple groups
  p6 <- ggplot(mtcars, aes(mpg, fill = factor(cyl))) +
    geom_density(alpha = 0.4) +
    ggtitle("Density: by cylinder count")
  gg2d3(p6)
  # EXPECT: Three overlapping density curves with different colors

  # 7. Smooth: loess with CI
  p7 <- ggplot(mtcars, aes(wt, mpg)) +
    geom_point() +
    geom_smooth() +
    ggtitle("Smooth: loess with confidence interval")
  suppressMessages(gg2d3(p7))
  # EXPECT: Scatter + blue smooth curve + grey confidence band

  # 8. Smooth: linear model
  p8 <- ggplot(mtcars, aes(wt, mpg)) +
    geom_point() +
    geom_smooth(method = "lm") +
    ggtitle("Smooth: linear model")
  suppressMessages(gg2d3(p8))
  # EXPECT: Scatter + straight blue line + narrow grey band

  # 9. Histogram (regression check)
  p9 <- ggplot(mtcars, aes(mpg)) +
    geom_histogram(bins = 15, fill = "steelblue") +
    ggtitle("Histogram: mpg")
  gg2d3(p9)
  # EXPECT: Bar chart of frequency bins (uses existing bar renderer)
  ```

  For each D3 output, compare with the equivalent ggplot2 PNG (`print(pN)`) to verify visual fidelity.
  </how-to-verify>
  <resume-signal>Type "approved" or describe visual issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. `devtools::test()` passes all tests including new Phase 5 test file
2. Visual verification: boxplots show five-number summary with outliers
3. Visual verification: violins show symmetric density shapes
4. Visual verification: density shows smooth filled curves
5. Visual verification: smooth shows fitted line + confidence ribbon
6. Visual verification: coord_flip works for boxplot and violin
7. Visual verification: multiple groups render with distinct colors
8. Visual verification: histogram still works (regression check)
</verification>

<success_criteria>
- All R-side unit tests pass (10+ test_that blocks)
- Boxplots render correctly with box, whiskers, endcaps, outliers
- Violins display symmetric density shapes
- Density curves fill under the line
- Smooth shows line + ribbon composite
- Histogram (regression) still works
- User visually approves output fidelity
</success_criteria>

<output>
After completion, create `.planning/phases/05-statistical-geoms/05-04-SUMMARY.md`
</output>
