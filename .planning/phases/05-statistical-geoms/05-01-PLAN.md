---
phase: 05-statistical-geoms
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - R/as_d3_ir.R
  - R/validate_ir.R
  - inst/htmlwidgets/gg2d3.yaml
  - inst/htmlwidgets/modules/geoms/boxplot.js
  - inst/htmlwidgets/modules/geoms/violin.js
  - inst/htmlwidgets/modules/geoms/density.js
  - inst/htmlwidgets/modules/geoms/smooth.js
autonomous: true

must_haves:
  truths:
    - "R IR extraction recognizes GeomBoxplot, GeomViolin, GeomDensity as distinct geom types"
    - "GeomSmooth maps to 'smooth' geom type (not 'path') so it can render line + ribbon"
    - "Boxplot stat-computed columns (lower, middle, upper, ymin, ymax, outliers, width, notchupper, notchlower) are preserved in IR"
    - "Violin stat-computed columns (violinwidth, density, scaled) are preserved in IR"
    - "List-column outliers field serializes correctly to JSON arrays via inner to_rows()"
    - "New JS geom module files are loaded by htmlwidgets in correct order"
    - "IR validation accepts all new geom types without warnings"
  artifacts:
    - path: "R/as_d3_ir.R"
      provides: "Updated keep_aes with stat columns, geom name switch for stat geoms, list-column handling in inner to_rows()"
      contains: "GeomDensity|GeomBoxplot|GeomViolin"
    - path: "R/validate_ir.R"
      provides: "Updated known_geoms list including density, smooth"
      contains: "density.*smooth"
    - path: "inst/htmlwidgets/gg2d3.yaml"
      provides: "Module loading for boxplot.js, violin.js, density.js, smooth.js"
      contains: "geoms/boxplot.js"
  key_links:
    - from: "R/as_d3_ir.R"
      to: "inst/htmlwidgets/gg2d3.yaml"
      via: "geom name in IR must match JS module registration name"
      pattern: "boxplot|violin|density|smooth"
    - from: "R/as_d3_ir.R"
      to: "R/validate_ir.R"
      via: "geom names used in as_d3_ir must be in validate_ir known_geoms"
      pattern: "known_geoms"
---

<objective>
Update R-side IR extraction and infrastructure to support Phase 5 statistical geoms (boxplot, violin, density, smooth).

Purpose: Statistical geoms have complex data structures from ggplot2's stat computations (quartiles, density estimates, regression fits). The R layer must correctly extract and serialize these computed values. This plan establishes the foundation so Wave 2 plans can focus purely on JS rendering logic.

Output: Updated as_d3_ir.R with stat-geom support (geom names, keep_aes columns, list-column handling), updated validate_ir.R, updated gg2d3.yaml, and placeholder JS modules.
</objective>

<execution_context>
@/Users/davidzenz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davidzenz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-statistical-geoms/05-RESEARCH.md
@R/as_d3_ir.R
@R/validate_ir.R
@inst/htmlwidgets/gg2d3.yaml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update R-side IR extraction for statistical geom types</name>
  <files>R/as_d3_ir.R</files>
  <action>
  In `as_d3_ir.R`, make four changes:

  1. **Update the inner `keep_aes` vector** (around line ~202, inside the `lapply` function) to include stat-computed columns needed by statistical geoms:
     - Add: `"lower"`, `"middle"`, `"upper"` (boxplot quartiles)
     - Add: `"outliers"` (boxplot outlier list-column)
     - Add: `"notchupper"`, `"notchlower"` (notched boxplot CI)
     - Add: `"width"` (boxplot/violin width)
     - Add: `"violinwidth"` (violin density width)
     - Add: `"density"`, `"scaled"`, `"count"`, `"ncount"`, `"ndensity"` (density/histogram stats)
     - Add: `"weight"` (used by some stat computations)
     - The outer `keep_aes` (line ~20) is only used by the outer `to_rows()` which isn't called for layers; the inner `keep_aes` is what matters for layer data extraction.

  2. **Change GeomSmooth mapping** in the `gname` switch (around line ~184):
     - Change: `GeomSmooth = "path"` to `GeomSmooth = "smooth"`
     - This enables a dedicated smooth renderer that draws both the fitted line AND the confidence ribbon, rather than just a line.
     - Add: `GeomDensity = "density"` mapping (if not already present)
     - Verify GeomBoxplot = "boxplot" and GeomViolin = "violin" are already present (they are, at lines ~183-184)

  3. **Fix inner `to_rows()` function** (around line ~210) to handle list-columns:
     - The inner `to_rows()` currently does NOT handle `is.list(col)` -- it only handles factors, POSIXct, Date.
     - Add list-column handling: `else if (is.list(col)) I(col)` in the `lapply` inside inner `to_rows()`.
     - This is CRITICAL for boxplot outliers, which are stored as a list-column where each row contains a vector of outlier values.
     - Without this, outliers will be silently dropped or cause serialization errors.

  4. **Add aes mappings for new columns** in the `aes <- list(...)` block (around line ~229):
     - No new aes mappings needed beyond what exists (the stat columns are data-only, not aesthetic mappings -- they get included via keep_aes in to_rows).
     - However, verify that `ymin` and `ymax` aes mappings exist (they do, for ribbon support).

  IMPORTANT: The inner `to_rows()` function at ~line 210 is a SEPARATE function from the outer `to_rows()` at ~line 27. They both need list-column handling, but only the inner one is used for layer data extraction. The outer one already has `is.list(col)` handling. The inner one does NOT -- this is the bug to fix.
  </action>
  <verify>
  In R console:
  ```r
  devtools::load_all()
  library(ggplot2)

  # Test boxplot IR extraction
  p1 <- ggplot(mtcars, aes(factor(cyl), mpg)) + geom_boxplot()
  ir1 <- as_d3_ir(p1)
  stopifnot(ir1$layers[[1]]$geom == "boxplot")
  first <- ir1$layers[[1]]$data[[1]]
  stopifnot(all(c("lower", "middle", "upper", "ymin", "ymax") %in% names(first)))
  # Check outliers is a list/vector (not a scalar)
  stopifnot("outliers" %in% names(first))
  cat("Boxplot outliers type:", class(first$outliers), "\n")

  # Test violin IR extraction
  p2 <- ggplot(mtcars, aes(factor(cyl), mpg)) + geom_violin()
  ir2 <- as_d3_ir(p2)
  stopifnot(ir2$layers[[1]]$geom == "violin")
  first2 <- ir2$layers[[1]]$data[[1]]
  stopifnot("violinwidth" %in% names(first2))

  # Test density IR extraction
  p3 <- ggplot(mtcars, aes(mpg)) + geom_density()
  ir3 <- suppressMessages(as_d3_ir(p3))
  stopifnot(ir3$layers[[1]]$geom == "density")

  # Test smooth IR extraction (should be "smooth" not "path")
  p4 <- ggplot(mtcars, aes(wt, mpg)) + geom_smooth(method = "lm")
  ir4 <- suppressMessages(as_d3_ir(p4))
  stopifnot(ir4$layers[[1]]$geom == "smooth")
  first4 <- ir4$layers[[1]]$data[[1]]
  stopifnot(all(c("x", "y", "ymin", "ymax") %in% names(first4)))

  cat("All stat geom IR extraction tests passed\n")
  ```
  </verify>
  <done>
  GeomBoxplot/GeomViolin/GeomDensity/GeomSmooth correctly recognized in IR. Stat-computed columns (lower, middle, upper, outliers, violinwidth, density, etc.) preserved in layer data. List-column outliers handled by inner to_rows().
  </done>
</task>

<task type="auto">
  <name>Task 2: Update IR validation, YAML module loading, and create placeholder JS modules</name>
  <files>R/validate_ir.R, inst/htmlwidgets/gg2d3.yaml, inst/htmlwidgets/modules/geoms/boxplot.js, inst/htmlwidgets/modules/geoms/violin.js, inst/htmlwidgets/modules/geoms/density.js, inst/htmlwidgets/modules/geoms/smooth.js</files>
  <action>
  Three areas to update:

  1. **R/validate_ir.R** - Update the `known_geoms` vector to include new geom types:
     - Add: `"density"`, `"smooth"` to the known_geoms vector
     - Verify `"violin"` and `"boxplot"` are already present (they are, from Phase 4 prep)

  2. **inst/htmlwidgets/gg2d3.yaml** - Add new geom module entries to the `gg2d3-modules` dependency script list:
     - Add after `geoms/reference.js`:
       - `geoms/boxplot.js`
       - `geoms/violin.js`
       - `geoms/density.js`
       - `geoms/smooth.js`
     - Order: these load after geom-registry.js (which they register with)

  3. **Create placeholder JS files** for the 4 new geom modules so the widget doesn't error on load before Wave 2 creates real implementations. Each placeholder should:
     - Use the IIFE pattern `(function() { 'use strict'; ... })();`
     - Register with the geom registry using a no-op function that returns 0
     - boxplot.js registers `'boxplot'`
     - violin.js registers `'violin'`
     - density.js registers `'density'`
     - smooth.js registers `'smooth'`

  Example placeholder:
  ```javascript
  (function() {
    'use strict';
    window.gg2d3.geomRegistry.register('boxplot', function() { return 0; });
  })();
  ```

  This ensures `devtools::load_all()` and widget rendering work without errors even before full implementations land in Wave 2.
  </action>
  <verify>
  ```r
  devtools::load_all()
  library(ggplot2)

  # Test that widget renders without JS errors for new geom types
  p <- ggplot(mtcars, aes(factor(cyl), mpg)) + geom_boxplot()
  w <- gg2d3(p)
  stopifnot(inherits(w, "htmlwidget"))

  # Test IR validation doesn't warn for new geom types
  ir <- as_d3_ir(p)
  # No "unrecognized geom type" warnings expected

  # Test violin
  p2 <- ggplot(mtcars, aes(factor(cyl), mpg)) + geom_violin()
  ir2 <- as_d3_ir(p2)

  # Test density
  p3 <- ggplot(mtcars, aes(mpg)) + geom_density()
  ir3 <- suppressMessages(as_d3_ir(p3))

  # Test smooth
  p4 <- ggplot(mtcars, aes(wt, mpg)) + geom_smooth(method = "lm")
  ir4 <- suppressMessages(as_d3_ir(p4))

  # Run all existing tests to check no regressions
  devtools::test()

  cat("Validation, YAML, and placeholder tests passed\n")
  ```
  </verify>
  <done>
  IR validation accepts density/smooth without warnings. YAML loads all 4 new geom module files. Placeholder JS files register no-op renderers so widget loads cleanly. Existing tests pass.
  </done>
</task>

</tasks>

<verification>
1. `devtools::load_all()` succeeds without errors
2. `as_d3_ir()` correctly extracts IR for plots with geom_boxplot, geom_violin, geom_density, geom_smooth
3. Boxplot IR includes lower/middle/upper/ymin/ymax/outliers with outliers as JSON arrays
4. Violin IR includes violinwidth column
5. GeomSmooth maps to "smooth" (not "path")
6. GeomDensity maps to "density" (not "area")
7. No "unrecognized geom type" warnings from validate_ir
8. Widget creation (`gg2d3()`) works for all new geom types (renders as no-op placeholders)
9. No existing tests break: `devtools::test()`
</verification>

<success_criteria>
- All 4 stat geom types (boxplot, violin, density, smooth) recognized by R IR extraction with correct geom names
- Stat-computed columns preserved in IR layer data (quartiles, density, violinwidth, outliers)
- List-column outliers correctly serialized through inner to_rows()
- YAML loads 4 new JS module files
- Placeholder JS files prevent load errors
- Existing functionality unchanged (point, line, bar, area, etc. still work)
</success_criteria>

<output>
After completion, create `.planning/phases/05-statistical-geoms/05-01-SUMMARY.md`
</output>
