---
phase: 04-essential-geoms
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - R/as_d3_ir.R
  - R/validate_ir.R
  - inst/htmlwidgets/gg2d3.yaml
  - inst/htmlwidgets/modules/geoms/area.js
  - inst/htmlwidgets/modules/geoms/ribbon.js
  - inst/htmlwidgets/modules/geoms/segment.js
  - inst/htmlwidgets/modules/geoms/reference.js
autonomous: true

must_haves:
  truths:
    - "R IR extraction recognizes GeomArea, GeomRibbon, GeomSegment, GeomHline, GeomVline, GeomAbline"
    - "Reference line data columns (slope, intercept, xintercept, yintercept) are preserved in IR"
    - "New JS geom module files are loaded by htmlwidgets in correct order"
    - "IR validation accepts all new geom types without warnings"
  artifacts:
    - path: "R/as_d3_ir.R"
      provides: "Updated keep_aes and geom name switch for new geom types"
      contains: "GeomHline|GeomVline|GeomAbline"
    - path: "R/validate_ir.R"
      provides: "Updated known_geoms list including hline, vline, abline, polygon"
      contains: "hline.*vline.*abline"
    - path: "inst/htmlwidgets/gg2d3.yaml"
      provides: "Module loading for area.js, ribbon.js, segment.js, reference.js"
      contains: "geoms/area.js"
  key_links:
    - from: "R/as_d3_ir.R"
      to: "inst/htmlwidgets/gg2d3.yaml"
      via: "geom name in IR must match JS module registration name"
      pattern: "hline|vline|abline|area|ribbon|segment"
---

<objective>
Update R-side IR extraction and infrastructure to support Phase 4 geoms (area, ribbon, segment, hline, vline, abline).

Purpose: All new JS geom renderers depend on correct IR data extraction and module loading. This plan establishes the foundation so Wave 2 plans can focus purely on JS rendering logic.

Output: Updated as_d3_ir.R with new geom name mappings and data columns, updated validate_ir.R with new known geoms, updated gg2d3.yaml with new module entries.
</objective>

<execution_context>
@/Users/davidzenz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davidzenz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-essential-geoms/04-RESEARCH.md
@R/as_d3_ir.R
@R/validate_ir.R
@inst/htmlwidgets/gg2d3.yaml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update R-side IR extraction for new geom types</name>
  <files>R/as_d3_ir.R</files>
  <action>
  In `as_d3_ir.R`, make three changes:

  1. **Update both `keep_aes` vectors** (line ~20 outer scope and line ~197 inner scope) to include reference line columns:
     - Add `"slope"`, `"intercept"`, `"xintercept"`, `"yintercept"` to the character vector
     - These columns are computed by `ggplot_build()` for GeomAbline (slope, intercept), GeomHline (yintercept), and GeomVline (xintercept)

  2. **Add reference line geom names to the `gname` switch** (around line ~168):
     - Add: `GeomHline = "hline"`
     - Add: `GeomVline = "vline"`
     - Add: `GeomAbline = "abline"`
     - Add: `GeomPolygon = "polygon"` (for completeness, deferred rendering)
     - Note: GeomArea, GeomSegment, GeomRibbon are already in the switch

  3. **Add aes mappings for new columns** in the `aes <- list(...)` block (around line ~223):
     - Add: `slope = if ("slope" %in% cols) "slope" else NULL`
     - Add: `intercept = if ("intercept" %in% cols) "intercept" else NULL`
     - Add: `xintercept = if ("xintercept" %in% cols) "xintercept" else NULL`
     - Add: `yintercept = if ("yintercept" %in% cols) "yintercept" else NULL`

  IMPORTANT: Reference lines in ggplot2 store their position data in the data frame rows (NOT in params). `ggplot_build()` computes data with columns like `yintercept`, `slope`, etc. The JS renderer will read these from the data rows, not from layer.params.
  </action>
  <verify>
  In R console:
  ```r
  devtools::load_all()
  library(ggplot2)
  # Test hline IR extraction
  p <- ggplot(mtcars, aes(wt, mpg)) + geom_point() + geom_hline(yintercept = 20)
  ir <- as_d3_ir(p)
  # Should have 2 layers; layer 2 should be geom="hline" with yintercept in data
  stopifnot(ir$layers[[2]]$geom == "hline")
  stopifnot("yintercept" %in% names(ir$layers[[2]]$data[[1]]))
  # Test vline
  p2 <- ggplot(mtcars, aes(wt, mpg)) + geom_point() + geom_vline(xintercept = 3)
  ir2 <- as_d3_ir(p2)
  stopifnot(ir2$layers[[2]]$geom == "vline")
  # Test abline
  p3 <- ggplot(mtcars, aes(wt, mpg)) + geom_point() + geom_abline(slope = 5, intercept = 10)
  ir3 <- as_d3_ir(p3)
  stopifnot(ir3$layers[[2]]$geom == "abline")
  # Test area
  p4 <- ggplot(economics, aes(date, unemploy)) + geom_area()
  ir4 <- as_d3_ir(p4)
  stopifnot(ir4$layers[[1]]$geom == "area")
  cat("All IR extraction tests passed\n")
  ```
  </verify>
  <done>
  GeomHline/GeomVline/GeomAbline recognized in IR with correct geom names. Reference line position data (yintercept, xintercept, slope, intercept) preserved in layer data rows and aes mappings.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update IR validation and YAML module loading</name>
  <files>R/validate_ir.R, inst/htmlwidgets/gg2d3.yaml, inst/htmlwidgets/modules/geoms/area.js, inst/htmlwidgets/modules/geoms/ribbon.js, inst/htmlwidgets/modules/geoms/segment.js, inst/htmlwidgets/modules/geoms/reference.js</files>
  <action>
  Two files to update:

  1. **R/validate_ir.R** - Update the `known_geoms` vector to include new geom types:
     - Add: `"hline"`, `"vline"`, `"abline"`, `"polygon"`
     - The vector already contains `"area"`, `"segment"`, `"ribbon"` -- verify this and leave them

  2. **inst/htmlwidgets/gg2d3.yaml** - Add new geom module entries to the `gg2d3-modules` dependency script list:
     - Add after `geoms/text.js`:
       - `geoms/area.js`
       - `geoms/ribbon.js`
       - `geoms/segment.js`
       - `geoms/reference.js`
     - Order matters: these load after geom-registry.js (which they register with)

  Also create **placeholder JS files** for the 4 new geom modules so the widget doesn't error on load before Wave 2 creates real implementations. Each placeholder should:
  - Use the IIFE pattern `(function() { 'use strict'; ... })();`
  - Register with the geom registry using a no-op function that returns 0
  - area.js registers `['area']`
  - ribbon.js registers `['ribbon']`
  - segment.js registers `['segment']`
  - reference.js registers `['hline', 'vline', 'abline']`

  This ensures `devtools::load_all()` and widget rendering work without errors even before full implementations land.
  </action>
  <verify>
  ```r
  devtools::load_all()
  library(ggplot2)
  # Test that widget renders without JS errors for new geom types
  p <- ggplot(mtcars, aes(wt, mpg)) + geom_point() + geom_hline(yintercept = 20)
  w <- gg2d3(p)
  # Should create widget without error (hline renders as no-op)
  stopifnot(inherits(w, "htmlwidget"))
  # Test IR validation doesn't warn for new geom types
  ir <- as_d3_ir(p)
  # Should not produce "unrecognized geom type" warning
  cat("Validation and YAML tests passed\n")
  ```
  Also verify YAML is valid:
  ```bash
  cat inst/htmlwidgets/gg2d3.yaml
  ```
  </verify>
  <done>
  IR validation accepts hline/vline/abline/polygon without warnings. YAML loads all 4 new geom module files. Placeholder JS files register no-op renderers so widget loads cleanly.
  </done>
</task>

</tasks>

<verification>
1. `devtools::load_all()` succeeds without errors
2. `as_d3_ir()` correctly extracts IR for plots with geom_area, geom_ribbon, geom_segment, geom_hline, geom_vline, geom_abline
3. No "unrecognized geom type" warnings from validate_ir
4. Widget creation (`gg2d3()`) works for all new geom types (renders as no-op placeholders)
5. No existing tests break: `devtools::test()`
</verification>

<success_criteria>
- All 6 new geom types (area, ribbon, segment, hline, vline, abline) recognized by R IR extraction
- Reference line data columns preserved in IR layer data
- YAML loads 4 new JS module files
- Placeholder JS files prevent load errors
- Existing functionality unchanged (point, line, bar, etc. still work)
</success_criteria>

<output>
After completion, create `.planning/phases/04-essential-geoms/04-01-SUMMARY.md`
</output>
