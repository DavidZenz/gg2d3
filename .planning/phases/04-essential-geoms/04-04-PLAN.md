---
phase: 04-essential-geoms
plan: 04
type: execute
wave: 3
depends_on: ["04-02", "04-03"]
files_modified:
  - tests/testthat/test-geoms-phase4.R
autonomous: true

must_haves:
  truths:
    - "IR extraction for all Phase 4 geoms produces correct structure"
    - "Area baseline defaults to zero when zero is in scale domain"
    - "Ribbon data includes ymin and ymax in IR"
    - "Segment data includes xend and yend in IR"
    - "Reference line data includes position columns (yintercept, xintercept, slope, intercept)"
    - "All new geom types pass IR validation without warnings"
  artifacts:
    - path: "tests/testthat/test-geoms-phase4.R"
      provides: "Unit tests for Phase 4 geom IR extraction and validation"
      min_lines: 80
  key_links:
    - from: "tests/testthat/test-geoms-phase4.R"
      to: "R/as_d3_ir.R"
      via: "Tests call as_d3_ir() and inspect layer structure"
      pattern: "as_d3_ir"
---

<objective>
Add R-side unit tests for all Phase 4 geom types verifying correct IR extraction and validation.

Purpose: Ensures the R-side pipeline correctly extracts data for area, ribbon, segment, hline, vline, and abline. These tests catch regressions and document expected IR structure.

Output: New test file covering Phase 4 geom IR extraction.
</objective>

<execution_context>
@/Users/davidzenz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davidzenz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/04-essential-geoms/04-01-SUMMARY.md
@tests/testthat/test-ir.R
@R/as_d3_ir.R
@R/validate_ir.R
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Phase 4 geom IR extraction tests</name>
  <files>tests/testthat/test-geoms-phase4.R</files>
  <action>
  Create a new test file `tests/testthat/test-geoms-phase4.R` with comprehensive tests for Phase 4 geom IR extraction. Follow the existing test patterns in `test-ir.R`.

  **Test structure:**

  ```r
  test_that("geom_area produces correct IR", {
    p <- ggplot(economics, aes(x = as.numeric(date), y = unemploy)) + geom_area()
    ir <- as_d3_ir(p)

    expect_equal(length(ir$layers), 1)
    expect_equal(ir$layers[[1]]$geom, "area")
    expect_true(length(ir$layers[[1]]$data) > 0)
    # Area data should have x, y, ymin, ymax from ggplot_build()
    first_row <- ir$layers[[1]]$data[[1]]
    expect_true("x" %in% names(first_row))
    expect_true("y" %in% names(first_row))
    # ymin should be present (ggplot_build computes it for area)
    expect_true("ymin" %in% names(first_row))
  })

  test_that("geom_ribbon produces correct IR", {
    huron <- data.frame(year = 1875:1972, level = as.numeric(LakeHuron))
    huron$ymin <- huron$level - 1
    huron$ymax <- huron$level + 1
    p <- ggplot(huron, aes(year, ymin = ymin, ymax = ymax)) + geom_ribbon()
    ir <- as_d3_ir(p)

    expect_equal(ir$layers[[1]]$geom, "ribbon")
    first_row <- ir$layers[[1]]$data[[1]]
    expect_true("ymin" %in% names(first_row))
    expect_true("ymax" %in% names(first_row))
    expect_true(is.numeric(first_row$ymin))
    expect_true(is.numeric(first_row$ymax))
  })

  test_that("geom_segment produces correct IR", {
    df <- data.frame(x = 1, y = 1, xend = 2, yend = 3)
    p <- ggplot(df, aes(x, y, xend = xend, yend = yend)) + geom_segment()
    ir <- as_d3_ir(p)

    expect_equal(ir$layers[[1]]$geom, "segment")
    first_row <- ir$layers[[1]]$data[[1]]
    expect_true("xend" %in% names(first_row))
    expect_true("yend" %in% names(first_row))
    # Verify aes mappings include xend/yend
    expect_equal(ir$layers[[1]]$aes$xend, "xend")
    expect_equal(ir$layers[[1]]$aes$yend, "yend")
  })

  test_that("geom_hline produces correct IR", {
    p <- ggplot(mtcars, aes(wt, mpg)) + geom_point() +
      geom_hline(yintercept = 20)
    ir <- as_d3_ir(p)

    expect_equal(length(ir$layers), 2)
    expect_equal(ir$layers[[2]]$geom, "hline")
    first_row <- ir$layers[[2]]$data[[1]]
    expect_true("yintercept" %in% names(first_row))
    expect_equal(first_row$yintercept, 20)
  })

  test_that("geom_vline produces correct IR", {
    p <- ggplot(mtcars, aes(wt, mpg)) + geom_point() +
      geom_vline(xintercept = 3)
    ir <- as_d3_ir(p)

    expect_equal(ir$layers[[2]]$geom, "vline")
    first_row <- ir$layers[[2]]$data[[1]]
    expect_true("xintercept" %in% names(first_row))
    expect_equal(first_row$xintercept, 3)
  })

  test_that("geom_abline produces correct IR", {
    p <- ggplot(mtcars, aes(wt, mpg)) + geom_point() +
      geom_abline(slope = -5, intercept = 35)
    ir <- as_d3_ir(p)

    expect_equal(ir$layers[[2]]$geom, "abline")
    first_row <- ir$layers[[2]]$data[[1]]
    expect_true("slope" %in% names(first_row))
    expect_true("intercept" %in% names(first_row))
    expect_equal(first_row$slope, -5)
    expect_equal(first_row$intercept, 35)
  })

  test_that("multiple reference lines produce multiple data rows", {
    p <- ggplot(mtcars, aes(wt, mpg)) + geom_point() +
      geom_hline(yintercept = c(15, 20, 25))
    ir <- as_d3_ir(p)

    hline_layer <- ir$layers[[2]]
    expect_equal(length(hline_layer$data), 3)
    expect_equal(hline_layer$data[[1]]$yintercept, 15)
    expect_equal(hline_layer$data[[2]]$yintercept, 20)
    expect_equal(hline_layer$data[[3]]$yintercept, 25)
  })

  test_that("IR validation accepts all Phase 4 geom types", {
    # Should not produce warnings about unrecognized geom types
    p <- ggplot(mtcars, aes(wt, mpg)) + geom_point() +
      geom_hline(yintercept = 20)
    expect_silent(as_d3_ir(p))

    p2 <- ggplot(mtcars, aes(wt, mpg)) + geom_point() +
      geom_vline(xintercept = 3)
    expect_silent(as_d3_ir(p2))
  })
  ```

  Adapt the above as needed based on what `ggplot_build()` actually produces -- the executor should run each test incrementally and fix if actual output differs from expected.

  IMPORTANT: Some ggplot2 geom_smooth may need `method` argument to suppress messages. Use `suppressMessages()` if needed around `as_d3_ir()` calls for tests involving stat computations.
  </action>
  <verify>
  ```r
  devtools::test()
  # All tests should pass, including new Phase 4 tests
  # Specifically: testthat::test_file("tests/testthat/test-geoms-phase4.R")
  ```
  </verify>
  <done>
  All Phase 4 geom types have R-side unit tests verifying:
  - Correct geom name in IR
  - Required data columns present (yintercept, xintercept, slope, intercept, xend, yend, ymin, ymax)
  - Correct values in data rows
  - IR validation passes without warnings
  - Multiple reference lines produce correct number of data rows
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>All Phase 4 geoms: geom_area, geom_ribbon, geom_segment, geom_hline, geom_vline, geom_abline. Complete R-side IR extraction, D3 rendering, and unit tests.</what-built>
  <how-to-verify>
  Run these verification plots in R and visually inspect the browser output:

  ```r
  devtools::load_all()
  library(ggplot2)

  # 1. Area chart with economics data
  p1 <- ggplot(economics, aes(x = as.numeric(date), y = unemploy)) +
    geom_area(fill = "steelblue", alpha = 0.7) +
    ggtitle("Area: Economics unemployment")
  gg2d3(p1)
  # EXPECT: Filled blue area from zero baseline to unemployment values

  # 2. Ribbon with confidence band
  huron <- data.frame(year = 1875:1972, level = as.numeric(LakeHuron))
  huron$ymin <- huron$level - 1
  huron$ymax <- huron$level + 1
  p2 <- ggplot(huron, aes(year)) +
    geom_ribbon(aes(ymin = ymin, ymax = ymax), fill = "grey70") +
    geom_line(aes(y = level)) +
    ggtitle("Ribbon: Lake Huron confidence band")
  gg2d3(p2)
  # EXPECT: Grey band around a line

  # 3. Segments
  df_seg <- data.frame(x = c(1,3), y = c(1,3), xend = c(3,5), yend = c(4,1))
  p3 <- ggplot(df_seg, aes(x, y, xend = xend, yend = yend)) +
    geom_segment(linewidth = 1) +
    ggtitle("Segments: Two diagonal lines")
  gg2d3(p3)
  # EXPECT: Two line segments connecting the point pairs

  # 4. Reference lines
  p4 <- ggplot(mtcars, aes(wt, mpg)) + geom_point() +
    geom_hline(yintercept = 20, colour = "red", linetype = "dashed") +
    geom_vline(xintercept = 3.5, colour = "blue") +
    geom_abline(slope = -5, intercept = 35, colour = "darkgreen") +
    ggtitle("Reference lines: hline, vline, abline")
  gg2d3(p4)
  # EXPECT: Red dashed horizontal at y=20, blue vertical at x=3.5, green diagonal

  # 5. coord_flip test
  p5 <- ggplot(mtcars, aes(wt, mpg)) + geom_point() +
    geom_hline(yintercept = 20, colour = "red") +
    coord_flip() +
    ggtitle("coord_flip: reference lines")
  gg2d3(p5)
  # EXPECT: Flipped coordinates with reference line in correct position
  ```

  Compare each D3 output with the equivalent ggplot2 PNG to verify visual fidelity.
  </how-to-verify>
  <resume-signal>Type "approved" or describe visual issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. `devtools::test()` passes all tests including new Phase 4 test file
2. Visual verification: area fills from correct baseline
3. Visual verification: ribbon shows band between ymin and ymax
4. Visual verification: segments connect correct endpoints
5. Visual verification: hline/vline/abline appear at correct positions with correct styling
6. Visual verification: coord_flip works for all new geom types
</verification>

<success_criteria>
- All R-side unit tests pass
- Area plots render filled regions with proper baseline (zero or ymin aesthetic)
- Ribbon plots show confidence bands with ymin/ymax aesthetics
- Segments connect arbitrary point pairs with correct endpoints
- Reference lines appear at specified positions with correct styling
- All new geoms respect theme styling (colors, line widths, alpha)
- User visually approves output fidelity
</success_criteria>

<output>
After completion, create `.planning/phases/04-essential-geoms/04-04-SUMMARY.md`
</output>
