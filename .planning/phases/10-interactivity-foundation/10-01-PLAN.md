---
phase: 10-interactivity-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - R/d3_tooltip.R
  - R/d3_hover.R
  - inst/htmlwidgets/modules/events.js
  - inst/htmlwidgets/modules/tooltip.js
autonomous: true

must_haves:
  truths:
    - "d3_tooltip() returns a modified gg2d3 widget with tooltip config in x$interactivity$tooltip"
    - "d3_hover() returns a modified gg2d3 widget with hover config in x$interactivity$hover"
    - "Both pipe functions validate input is a gg2d3 widget and stop with clear error if not"
    - "Tooltip module creates singleton div with pointer-events:none and viewport-aware positioning"
    - "Event module attaches D3 mouseover/mousemove/mouseout handlers to interactive SVG elements"
  artifacts:
    - path: "R/d3_tooltip.R"
      provides: "d3_tooltip() pipe function with fields and formatter params"
      contains: "d3_tooltip"
    - path: "R/d3_hover.R"
      provides: "d3_hover() pipe function with opacity/stroke params"
      contains: "d3_hover"
    - path: "inst/htmlwidgets/modules/events.js"
      provides: "Event attachment system for geom elements"
      contains: "window.gg2d3.events"
    - path: "inst/htmlwidgets/modules/tooltip.js"
      provides: "Tooltip creation, formatting, positioning"
      contains: "window.gg2d3.tooltip"
  key_links:
    - from: "R/d3_tooltip.R"
      to: "inst/htmlwidgets/modules/events.js"
      via: "htmlwidgets::onRender() JS callback calls window.gg2d3.events.attachTooltips()"
      pattern: "window\\.gg2d3\\.events\\.attachTooltips"
    - from: "inst/htmlwidgets/modules/events.js"
      to: "inst/htmlwidgets/modules/tooltip.js"
      via: "Event handlers call tooltip.show/move/hide"
      pattern: "window\\.gg2d3\\.tooltip\\."
---

<objective>
Create the R pipe functions (d3_tooltip, d3_hover) and JavaScript interactivity modules (events.js, tooltip.js) that form the foundation of the interactivity system.

Purpose: Establishes the pipe-based API pattern (`gg2d3(p) |> d3_tooltip()`) and the JavaScript event/tooltip infrastructure that all interactive features build on.

Output: Four new files -- two R pipe functions and two JS modules -- ready to be wired into the widget.
</objective>

<execution_context>
@/Users/davidzenz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davidzenz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-interactivity-foundation/10-RESEARCH.md
@R/gg2d3.R
@inst/htmlwidgets/modules/constants.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create R pipe functions d3_tooltip() and d3_hover()</name>
  <files>R/d3_tooltip.R, R/d3_hover.R</files>
  <action>
Create two R source files implementing the pipe-based interactivity API.

**R/d3_tooltip.R:**
- Export `d3_tooltip(widget, fields = NULL, formatter = NULL)` function
- Validate `inherits(widget, "gg2d3")`, stop with clear error if not
- Initialize `widget$x$interactivity` list if NULL
- Set `widget$x$interactivity$tooltip` with `list(enabled = TRUE, fields = fields, formatter = formatter)`
  - `fields`: character vector of field names to show (NULL = all aesthetics)
  - `formatter`: optional JS function string for custom value formatting
- Call `htmlwidgets::onRender()` with JS callback that defers to next tick via `setTimeout(function() { ... }, 0)`:
  - Check `x.interactivity && x.interactivity.tooltip` before calling
  - Call `window.gg2d3.events.attachTooltips(el, x.interactivity.tooltip)`
- Return the widget (enables pipe chaining)
- Add roxygen2 docs with `@param`, `@return`, `@export`, `@examples`

**R/d3_hover.R:**
- Export `d3_hover(widget, opacity = 0.7, stroke = NULL, stroke_width = NULL)` function
- Same validation pattern as d3_tooltip
- Set `widget$x$interactivity$hover` with `list(enabled = TRUE, opacity = opacity, stroke = stroke, stroke_width = stroke_width)`
  - `opacity`: numeric, opacity of non-hovered elements (dim others to highlight hovered)
  - `stroke`: optional string, stroke color for hovered element
  - `stroke_width`: optional numeric, stroke width for hovered element
- Call `htmlwidgets::onRender()` with JS callback:
  - Check `x.interactivity && x.interactivity.hover` before calling
  - Call `window.gg2d3.events.attachHover(el, x.interactivity.hover)`
- Return widget for chaining
- Add roxygen2 docs

Both functions use base R pipe `|>` syntax in examples but work with magrittr `%>%` too (they just return modified widget objects).
  </action>
  <verify>
Run `pkgload::load_all()` in R to confirm no syntax errors. Run `devtools::document()` to generate NAMESPACE exports. Verify both functions appear in NAMESPACE.
  </verify>
  <done>
d3_tooltip() and d3_hover() are exported R functions that modify widget$x$interactivity and attach onRender JS callbacks. Both validate input and support pipe chaining.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create JavaScript tooltip.js and events.js modules</name>
  <files>inst/htmlwidgets/modules/tooltip.js, inst/htmlwidgets/modules/events.js</files>
  <action>
Create two JavaScript modules following the project's IIFE + window.gg2d3 namespace pattern.

**inst/htmlwidgets/modules/tooltip.js:**
- IIFE wrapping with `'use strict'`
- Initialize `window.gg2d3.tooltip` namespace
- `getOrCreate()`: Returns singleton tooltip div. Uses `d3.select('body').select('.gg2d3-tooltip')`. If empty, create new div with:
  - Class: `gg2d3-tooltip`
  - `position: absolute`
  - `display: none`
  - `pointer-events: none` (critical: prevents tooltip from intercepting mouse events)
  - `background: white`
  - `border: 1px solid #ccc`
  - `border-radius: 4px`
  - `padding: 6px 10px`
  - `font-family: sans-serif`
  - `font-size: 12px`
  - `color: #333`
  - `box-shadow: 0 2px 4px rgba(0,0,0,0.15)`
  - `z-index: 9999`
  - `max-width: 300px`
  - `line-height: 1.4`
- `format(d, config)`: Formats tooltip content from data row `d`.
  - If `config.fields` is set, show only those fields. Otherwise show all keys in `d` except keys starting with underscore and internal keys like `PANEL`, `group`, `SCALE_X`, `SCALE_Y`.
  - For each field: `<div style="margin:1px 0"><strong>{field}:</strong> {value}</div>`
  - If value is number, format with up to 4 significant digits (use `parseFloat(value.toPrecision(4))` if numeric)
  - If `config.formatter` is set (JS function string), evaluate and use it: `new Function('field', 'value', config.formatter)`
  - Return HTML string
- `show(event, d, config)`: Get tooltip, set `display: block`, set innerHTML via `format(d, config)`, call `position(event, tooltip)`
- `move(event)`: Call `position(event, getOrCreate())`
- `hide()`: Set tooltip `display: none`
- `position(event, tooltipDiv)`: Viewport-aware positioning.
  - Get tooltip bounds via `tooltipDiv.node().getBoundingClientRect()`
  - Offset from cursor: 12px
  - Check right edge: if `x + width > window.innerWidth`, flip to left of cursor
  - Check bottom edge: if `y + height > window.innerHeight + window.scrollY`, flip above cursor
  - Clamp to prevent going off-screen left or top
  - Set `left` and `top` styles using `event.pageX`/`event.pageY`

**inst/htmlwidgets/modules/events.js:**
- IIFE wrapping with `'use strict'`
- Initialize `window.gg2d3.events` namespace
- Define `INTERACTIVE_SELECTORS` array: `['circle', 'rect:not(.panel-bg)', 'path.geom-line', 'path.geom-area', 'path.geom-density', 'path.geom-smooth', 'path.geom-ribbon', 'path.geom-violin', 'text.geom-text', 'line.geom-segment']`
  - Use `:not(.panel-bg)` to exclude panel background rects
  - Use class selectors for paths to distinguish geom types
- `attachTooltips(el, config)`:
  - Get SVG via `d3.select(el).select('svg')`
  - For each selector in INTERACTIVE_SELECTORS, select all matching elements within SVG
  - Attach `.on('mouseover', function(event, d) { ... })` that calls `window.gg2d3.tooltip.show(event, d, config)`
  - Attach `.on('mousemove', function(event) { ... })` that calls `window.gg2d3.tooltip.move(event)`
  - Attach `.on('mouseout', function() { ... })` that calls `window.gg2d3.tooltip.hide()`
  - Skip selectors that return empty selections (no-op)
- `attachHover(el, config)`:
  - Get SVG via `d3.select(el).select('svg')`
  - For each selector, attach:
    - `mouseover`: Set opacity of ALL sibling interactive elements to `config.opacity` (dim), then set THIS element to opacity 1.0 (highlight). Optionally set stroke/stroke-width if config provides them.
    - `mouseout`: Restore all elements to original opacity (store originals as data attribute or use D3's `.attr()` to read). Remove hover stroke if applied.
  - Store original opacity values before first hover to enable proper restoration.
- Export: `window.gg2d3.events = { attachTooltips, attachHover }`
  </action>
  <verify>
Verify files parse correctly: `node -c inst/htmlwidgets/modules/tooltip.js && node -c inst/htmlwidgets/modules/events.js`. Verify namespace pattern matches existing modules (IIFE, window.gg2d3.* export).
  </verify>
  <done>
tooltip.js provides singleton tooltip div with viewport-aware positioning and configurable content formatting. events.js provides attachTooltips() and attachHover() that use D3 .on() to bind event handlers to geom elements via CSS selectors.
  </done>
</task>

</tasks>

<verification>
1. `pkgload::load_all()` succeeds with no errors
2. `devtools::document()` adds d3_tooltip and d3_hover to NAMESPACE
3. `node -c inst/htmlwidgets/modules/tooltip.js` passes
4. `node -c inst/htmlwidgets/modules/events.js` passes
5. tooltip.js exports window.gg2d3.tooltip with getOrCreate, format, show, move, hide, position
6. events.js exports window.gg2d3.events with attachTooltips, attachHover
</verification>

<success_criteria>
- R pipe functions d3_tooltip() and d3_hover() exist, are exported, and modify widget$x$interactivity
- JavaScript tooltip module creates styled singleton div with viewport-aware positioning
- JavaScript events module attaches D3 event handlers to geom elements via class-based selectors
- All files follow existing project conventions (IIFE pattern, window.gg2d3 namespace, roxygen2 docs)
</success_criteria>

<output>
After completion, create `.planning/phases/10-interactivity-foundation/10-01-SUMMARY.md`
</output>
