---
phase: 10-interactivity-foundation
plan: 02
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - inst/htmlwidgets/gg2d3.yaml
  - inst/htmlwidgets/modules/geoms/point.js
  - inst/htmlwidgets/modules/geoms/line.js
  - inst/htmlwidgets/modules/geoms/bar.js
  - inst/htmlwidgets/modules/geoms/rect.js
  - inst/htmlwidgets/modules/geoms/text.js
  - inst/htmlwidgets/modules/geoms/area.js
  - inst/htmlwidgets/modules/geoms/ribbon.js
  - inst/htmlwidgets/modules/geoms/segment.js
  - inst/htmlwidgets/modules/geoms/density.js
  - inst/htmlwidgets/modules/geoms/smooth.js
  - inst/htmlwidgets/modules/geoms/violin.js
  - inst/htmlwidgets/modules/geoms/boxplot.js
autonomous: true

must_haves:
  truths:
    - "tooltip.js and events.js are loaded by htmlwidgets before gg2d3.js"
    - "All geom SVG elements have class attributes enabling CSS selector targeting"
    - "Path-based geoms have distinguishing class names (geom-line, geom-area, etc.)"
    - "Point geom elements have data bound via D3 .data() for tooltip access"
    - "Static rendering (without d3_tooltip) is unaffected by geom class additions"
  artifacts:
    - path: "inst/htmlwidgets/gg2d3.yaml"
      provides: "Script loading order including events.js and tooltip.js"
      contains: "events.js"
    - path: "inst/htmlwidgets/modules/geoms/point.js"
      provides: "Class attribute on circle elements"
      contains: "geom-point"
    - path: "inst/htmlwidgets/modules/geoms/line.js"
      provides: "Class attribute on path elements"
      contains: "geom-line"
    - path: "inst/htmlwidgets/modules/geoms/bar.js"
      provides: "Class attribute on rect elements"
      contains: "geom-bar"
  key_links:
    - from: "inst/htmlwidgets/gg2d3.yaml"
      to: "inst/htmlwidgets/modules/events.js"
      via: "Script dependency loading"
      pattern: "events\\.js"
    - from: "inst/htmlwidgets/gg2d3.yaml"
      to: "inst/htmlwidgets/modules/tooltip.js"
      via: "Script dependency loading"
      pattern: "tooltip\\.js"
---

<objective>
Wire the new JavaScript interactivity modules into the widget and add class attributes to all geom renderers so the event system can target them with CSS selectors.

Purpose: Connects the R pipe API (Plan 10-01) to the D3 event system by ensuring JS modules load in correct order and geom elements are targetable by the event selector system.

Output: Updated YAML config and geom renderers with class attributes for event selection.
</objective>

<execution_context>
@/Users/davidzenz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davidzenz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-interactivity-foundation/10-01-SUMMARY.md
@inst/htmlwidgets/gg2d3.yaml
@inst/htmlwidgets/modules/geoms/point.js
@inst/htmlwidgets/modules/geoms/line.js
@inst/htmlwidgets/modules/geoms/bar.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update YAML to load events.js and tooltip.js modules</name>
  <files>inst/htmlwidgets/gg2d3.yaml</files>
  <action>
Add `tooltip.js` and `events.js` to the gg2d3-modules dependency script array in gg2d3.yaml.

**Loading order matters:** tooltip.js must load before events.js because events.js calls `window.gg2d3.tooltip.*`. Both must load before geom modules (they don't depend on geoms, but loading them early ensures the namespace exists when onRender callbacks fire).

Insert after `legend.js` and before `geom-registry.js`:
```yaml
      - tooltip.js
      - events.js
```

The full script array should be:
```yaml
    script:
      - constants.js
      - scales.js
      - theme.js
      - layout.js
      - legend.js
      - tooltip.js
      - events.js
      - geom-registry.js
      - geoms/point.js
      - geoms/line.js
      ... (rest unchanged)
```
  </action>
  <verify>
Read gg2d3.yaml and confirm tooltip.js and events.js appear in the script array before geom-registry.js. Verify no duplicate entries.
  </verify>
  <done>
htmlwidgets loads tooltip.js and events.js modules in correct order, making window.gg2d3.tooltip and window.gg2d3.events available before any onRender callbacks fire.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add class attributes to all geom renderers for event targeting</name>
  <files>
    inst/htmlwidgets/modules/geoms/point.js
    inst/htmlwidgets/modules/geoms/line.js
    inst/htmlwidgets/modules/geoms/bar.js
    inst/htmlwidgets/modules/geoms/rect.js
    inst/htmlwidgets/modules/geoms/text.js
    inst/htmlwidgets/modules/geoms/area.js
    inst/htmlwidgets/modules/geoms/ribbon.js
    inst/htmlwidgets/modules/geoms/segment.js
    inst/htmlwidgets/modules/geoms/density.js
    inst/htmlwidgets/modules/geoms/smooth.js
    inst/htmlwidgets/modules/geoms/violin.js
    inst/htmlwidgets/modules/geoms/boxplot.js
  </files>
  <action>
Add `.attr('class', 'geom-{type}')` to the SVG elements created by each geom renderer. This enables the events.js selector system to target specific geom types.

**Changes per file:**

1. **point.js**: On `sel.enter().append("circle")`, add `.attr("class", "geom-point")` as the first chained attribute.

2. **line.js**: On `g.append("path")`, add `.attr("class", "geom-line")`. This is the key one -- distinguishes line paths from area/ribbon/density paths.

3. **bar.js**: On `sel.enter().append("rect")` (there are two -- one for band scale, one for continuous), add `.attr("class", "geom-bar")` to both.

4. **rect.js**: On `sel.enter().append("rect")` (two paths), add `.attr("class", "geom-rect")`.

5. **text.js**: On `sel.enter().append("text")`, add `.attr("class", "geom-text")`.

6. **area.js**: On `g.append("path")`, add `.attr("class", "geom-area")`.

7. **ribbon.js**: On `g.append("path")`, add `.attr("class", "geom-ribbon")`.

8. **segment.js**: On `sel.enter().append("line")`, add `.attr("class", "geom-segment")`.

9. **density.js**: Has two path appends (fill + stroke). Add `.attr("class", "geom-density")` to the FILL path (first one). Add `.attr("class", "geom-density-outline")` to the stroke path (second one). Only the fill path gets tooltip events.

10. **smooth.js**: Has ribbon path + line path. Add `.attr("class", "geom-smooth-ribbon")` to ribbon path. Add `.attr("class", "geom-smooth")` to the line path.

11. **violin.js**: On `g.append('path')`, add `.attr("class", "geom-violin")`. There are two code paths (flip/non-flip) -- add to both.

12. **boxplot.js**: The boxplot is composed of multiple primitives (rect for IQR box, lines for whiskers/median, circles for outliers). Add `.attr("class", "geom-boxplot-box")` to the IQR rect, `.attr("class", "geom-boxplot-median")` to the median line, `.attr("class", "geom-boxplot-whisker")` to whisker lines, `.attr("class", "geom-boxplot-outlier")` to outlier circles.

**Important:** These class additions must NOT break any existing CSS or selection patterns. Since no existing code selects by class on these elements, this is purely additive.

After adding classes, update the `INTERACTIVE_SELECTORS` array in events.js (from Plan 10-01) if any selector names differ from what was initially planned. The final selector list should match the class names added here:
- `'circle.geom-point'`
- `'rect.geom-bar'`
- `'rect.geom-rect'`
- `'path.geom-line'`
- `'path.geom-area'`
- `'path.geom-density'`
- `'path.geom-smooth'`
- `'path.geom-ribbon'`
- `'path.geom-violin'`
- `'text.geom-text'`
- `'line.geom-segment'`
- `'rect.geom-boxplot-box'`
- `'circle.geom-boxplot-outlier'`
  </action>
  <verify>
For each modified geom file, run `node -c inst/htmlwidgets/modules/geoms/{file}.js` to verify syntax. Then search all geom files for "geom-" class pattern to confirm all have been updated.
  </verify>
  <done>
All geom renderers add class attributes to their SVG elements. The event system can now target any geom type using `d3.selectAll('circle.geom-point')` etc. Static rendering is unaffected.
  </done>
</task>

</tasks>

<verification>
1. `node -c` passes for all modified geom JS files
2. gg2d3.yaml includes tooltip.js and events.js in correct load order
3. Every geom renderer appends class attribute matching the selector in events.js
4. `pkgload::load_all()` succeeds (R package still loads)
5. Existing tests pass: `devtools::test()` (no regressions from class additions)
</verification>

<success_criteria>
- YAML loads tooltip.js and events.js before geom-registry.js
- All 12 geom renderers have class attributes on their SVG elements
- Class names are consistent between geom renderers and events.js INTERACTIVE_SELECTORS
- No regressions in existing test suite
</success_criteria>

<output>
After completion, create `.planning/phases/10-interactivity-foundation/10-02-SUMMARY.md`
</output>
