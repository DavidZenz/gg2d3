---
phase: 08-basic-faceting
plan: 04
type: execute
wave: 3
depends_on: ["08-03"]
files_modified:
  - tests/testthat/test-facets.R
autonomous: false

must_haves:
  truths:
    - "facet_wrap IR extraction has unit test coverage"
    - "Non-faceted backward compatibility verified by test"
    - "Visual rendering confirmed by user for facet_wrap plots"
  artifacts:
    - path: "tests/testthat/test-facets.R"
      provides: "Facet IR unit tests"
      contains: "facet_wrap"
  key_links:
    - from: "tests/testthat/test-facets.R"
      to: "R/as_d3_ir.R"
      via: "testing as_d3_ir() with faceted plots"
      pattern: "as_d3_ir"
---

<objective>
Add unit tests for facet IR extraction and visual verification for facet rendering.

Purpose: Ensure facet extraction and rendering work correctly across various facet_wrap configurations, and get user confirmation that rendering matches ggplot2 output.

Output: test-facets.R with comprehensive tests, visual verification checkpoint.
</objective>

<execution_context>
@/Users/davidzenz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davidzenz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-basic-faceting/08-01-SUMMARY.md
@.planning/phases/08-basic-faceting/08-02-SUMMARY.md
@.planning/phases/08-basic-faceting/08-03-SUMMARY.md
@tests/testthat/test-ir.R
@tests/testthat/test-legends.R
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create comprehensive facet IR unit tests</name>
  <files>tests/testthat/test-facets.R</files>
  <action>
  Create `tests/testthat/test-facets.R` with the following test cases:

  **1. Basic facet_wrap IR structure:**
  ```r
  test_that("facet_wrap produces correct IR structure", {
    p <- ggplot(mtcars, aes(wt, mpg)) + geom_point() + facet_wrap(~ cyl)
    ir <- as_d3_ir(p)

    expect_equal(ir$facets$type, "wrap")
    expect_true(ir$facets$nrow >= 1)
    expect_true(ir$facets$ncol >= 1)
    expect_equal(length(ir$facets$layout), 3)  # 3 levels of cyl
    expect_equal(length(ir$facets$strips), 3)
    expect_true(!is.null(ir$facets$spacing))
  })
  ```

  **2. Panel layout has correct PANEL/ROW/COL:**
  ```r
  test_that("facet layout has PANEL, ROW, COL as integers", {
    p <- ggplot(mtcars, aes(wt, mpg)) + geom_point() + facet_wrap(~ cyl, nrow = 2)
    ir <- as_d3_ir(p)

    for (entry in ir$facets$layout) {
      expect_true(is.integer(entry$PANEL))
      expect_true(is.integer(entry$ROW))
      expect_true(is.integer(entry$COL))
    }
    # With nrow=2, 3 panels: should be 2 rows, 2 cols
    expect_equal(ir$facets$nrow, 2L)
    expect_equal(ir$facets$ncol, 2L)
  })
  ```

  **3. Strip labels contain facet variable values:**
  ```r
  test_that("strip labels contain facet variable values", {
    p <- ggplot(mtcars, aes(wt, mpg)) + geom_point() + facet_wrap(~ cyl)
    ir <- as_d3_ir(p)

    strip_labels <- vapply(ir$facets$strips, function(s) s$label, character(1))
    # cyl has values 4, 6, 8
    expect_true("4" %in% strip_labels)
    expect_true("6" %in% strip_labels)
    expect_true("8" %in% strip_labels)
  })
  ```

  **4. Panels array matches layout:**
  ```r
  test_that("panels array has per-panel scale metadata", {
    p <- ggplot(mtcars, aes(wt, mpg)) + geom_point() + facet_wrap(~ cyl)
    ir <- as_d3_ir(p)

    expect_equal(length(ir$panels), 3)
    for (panel in ir$panels) {
      expect_true(is.integer(panel$PANEL))
      expect_equal(length(panel$x_range), 2)
      expect_equal(length(panel$y_range), 2)
      expect_true(length(panel$x_breaks) > 0)
      expect_true(length(panel$y_breaks) > 0)
    }

    # Fixed scales: all panels should have same ranges
    expect_equal(ir$panels[[1]]$x_range, ir$panels[[2]]$x_range)
    expect_equal(ir$panels[[1]]$y_range, ir$panels[[2]]$y_range)
  })
  ```

  **5. PANEL column preserved as integer in layer data:**
  ```r
  test_that("layer data has PANEL as integer", {
    p <- ggplot(mtcars, aes(wt, mpg)) + geom_point() + facet_wrap(~ cyl)
    ir <- as_d3_ir(p)

    panels_in_data <- vapply(ir$layers[[1]]$data, function(d) d$PANEL, integer(1))
    expect_true(all(panels_in_data %in% 1:3))
    expect_true(is.integer(panels_in_data))
  })
  ```

  **6. Non-faceted plot produces null facets:**
  ```r
  test_that("non-faceted plot has null facet type", {
    p <- ggplot(mtcars, aes(wt, mpg)) + geom_point()
    ir <- as_d3_ir(p)

    expect_equal(ir$facets$type, "null")
    expect_equal(length(ir$panels), 1)
    expect_equal(ir$panels[[1]]$PANEL, 1L)
  })
  ```

  **7. Multi-variable facet_wrap:**
  ```r
  test_that("multi-variable facet_wrap works", {
    p <- ggplot(mtcars, aes(wt, mpg)) + geom_point() + facet_wrap(~ cyl + gear)
    ir <- as_d3_ir(p)

    expect_equal(ir$facets$type, "wrap")
    expect_true(length(ir$facets$vars) == 2)
    # Labels should contain both variable values
    for (strip in ir$facets$strips) {
      expect_true(grepl(",", strip$label))  # multi-var labels have comma
    }
  })
  ```

  **8. Strip theme elements extracted:**
  ```r
  test_that("strip theme elements are in IR", {
    p <- ggplot(mtcars, aes(wt, mpg)) + geom_point() + facet_wrap(~ cyl)
    ir <- as_d3_ir(p)

    expect_true(!is.null(ir$theme$strip))
    expect_true(!is.null(ir$theme$strip$text))
    expect_true(!is.null(ir$theme$strip$background))
  })
  ```

  **9. Facet_wrap with various geom types:**
  ```r
  test_that("facet_wrap works with bar geom", {
    p <- ggplot(mtcars, aes(factor(gear))) + geom_bar() + facet_wrap(~ cyl)
    ir <- as_d3_ir(p)

    expect_equal(ir$facets$type, "wrap")
    expect_equal(length(ir$panels), 3)
    # Each panel should have data
    panel_counts <- table(vapply(ir$layers[[1]]$data, function(d) d$PANEL, integer(1)))
    expect_true(all(panel_counts > 0))
  })
  ```

  **10. Validation catches malformed facet IR:**
  ```r
  test_that("validate_ir catches malformed facet structure", {
    ir <- list(
      scales = list(x = list(type = "continuous", domain = c(0, 1)),
                    y = list(type = "continuous", domain = c(0, 1))),
      layers = list(),
      facets = list()  # missing type
    )
    expect_error(validate_ir(ir), "type")
  })
  ```

  Run all tests: `devtools::test()`
  </action>
  <verify>
  ```bash
  cd /Users/davidzenz/R/gg2d3 && Rscript -e 'devtools::test()'
  ```
  All tests pass, including the new facet tests.
  </verify>
  <done>
  test-facets.R contains 10 test cases covering: facet_wrap IR structure, layout integers, strip labels, panels array, PANEL preservation, backward compatibility, multi-variable facets, strip theme, various geoms, and validation. All tests pass.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Visual verification of facet_wrap rendering</name>
  <files>test_output</files>
  <action>
Generate 5 test plots to visually verify facet rendering. Save each as HTML file and present to user for verification.

```r
library(ggplot2)
devtools::load_all()

# Test 1: Basic facet_wrap
p1 <- ggplot(mtcars, aes(wt, mpg)) +
  geom_point() +
  facet_wrap(~ cyl, nrow = 2) +
  labs(title = "MPG by Weight", subtitle = "Faceted by Cylinder")
htmlwidgets::saveWidget(gg2d3(p1), "/tmp/facet_test_1_basic.html")

# Test 2: Facet with color + legend
p2 <- ggplot(mtcars, aes(wt, mpg, color = factor(gear))) +
  geom_point() +
  facet_wrap(~ cyl)
htmlwidgets::saveWidget(gg2d3(p2), "/tmp/facet_test_2_color.html")

# Test 3: Facet with bars
p3 <- ggplot(mtcars, aes(factor(gear))) +
  geom_bar(fill = "steelblue") +
  facet_wrap(~ cyl) +
  labs(title = "Gear Distribution by Cylinder")
htmlwidgets::saveWidget(gg2d3(p3), "/tmp/facet_test_3_bars.html")

# Test 4: Non-faceted regression
p4 <- ggplot(mtcars, aes(wt, mpg)) +
  geom_point() +
  geom_smooth(method = "lm") +
  labs(title = "Test Non-Faceted")
htmlwidgets::saveWidget(gg2d3(p4), "/tmp/facet_test_4_nonfacet.html")

# Test 5: Multi-variable facet
p5 <- ggplot(mtcars, aes(wt, mpg)) +
  geom_point() +
  facet_wrap(~ cyl + am)
htmlwidgets::saveWidget(gg2d3(p5), "/tmp/facet_test_5_multivar.html")
```

Present each HTML to user for visual comparison with ggplot2 reference.
  </action>
  <verify>
User confirms visual output matches ggplot2 reference for all 5 test cases:
1. 3 panels in 2x2 grid, strip labels "4", "6", "8"
2. Legend visible alongside faceted panels with correct colors
3. Bar charts in each panel with discrete x-axis
4. Non-faceted plot unchanged from before Phase 8
5. Multi-variable facets with combined strip labels
  </verify>
  <done>
User approves visual rendering of facet_wrap plots. All 5 test cases pass visual inspection. Non-faceted regression shows no changes.
  </done>
</task>

</tasks>

<verification>
- All R-side unit tests pass (devtools::test())
- facet_wrap renders with correct panel grid layout
- Strip labels visible with correct styling
- Per-panel data filtering shows correct data subsets
- Axes positioned on outer edges
- Non-faceted plots unchanged
- Legend still works with faceted plots
</verification>

<success_criteria>
1. 10+ facet unit tests pass
2. User approves visual rendering of 5 test cases
3. Non-faceted regression test shows no visual changes
4. Full test suite passes with no regressions
</success_criteria>

<output>
After completion, create `.planning/phases/08-basic-faceting/08-04-SUMMARY.md`
</output>
