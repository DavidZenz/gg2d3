---
phase: 08-basic-faceting
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - R/as_d3_ir.R
  - R/validate_ir.R
autonomous: true

must_haves:
  truths:
    - "facet_wrap plot produces IR with facets object containing layout and strips"
    - "Layer data preserves PANEL column as integer for per-panel filtering"
    - "Per-panel scale ranges and breaks are extracted from panel_params"
    - "Non-faceted plots continue to work unchanged (backward compatible)"
  artifacts:
    - path: "R/as_d3_ir.R"
      provides: "Facet extraction logic in as_d3_ir()"
      contains: "facet_wrap"
    - path: "R/validate_ir.R"
      provides: "Facet IR validation"
      contains: "facets"
  key_links:
    - from: "R/as_d3_ir.R"
      to: "b$layout$layout"
      via: "ggplot_build facet layout dataframe"
      pattern: "b\\$layout\\$layout"
    - from: "R/as_d3_ir.R"
      to: "b$layout$panel_params"
      via: "per-panel scale metadata"
      pattern: "panel_params"
---

<objective>
Extract facet_wrap metadata from ggplot_build() and build facet IR structure.

Purpose: R-side IR must contain all faceting information (panel layout, strip labels, per-panel scale ranges/breaks) so JavaScript can render multi-panel grids without recomputing anything.

Output: Updated as_d3_ir() that produces facets/panels IR fields for facet_wrap plots, plus validation in validate_ir().
</objective>

<execution_context>
@/Users/davidzenz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davidzenz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-basic-faceting/08-RESEARCH.md
@R/as_d3_ir.R
@R/validate_ir.R
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract facet_wrap metadata and build facet IR structure</name>
  <files>R/as_d3_ir.R</files>
  <action>
  Add facet extraction logic to as_d3_ir() BEFORE the final IR assembly (before the `ir <- list(...)` block at ~line 744). This replaces the current hardcoded `facets = list(type = "grid", rows = 1, cols = 1, layout = data.frame(panel = 1, row = 1, col = 1))`.

  **1. Detect facet type:**
  ```r
  is_facet_wrap <- inherits(b$layout$facet, "FacetWrap")
  ```

  **2. For facet_wrap plots, extract:**
  - `b$layout$layout` dataframe: contains PANEL, ROW, COL, faceting variable columns, SCALE_X, SCALE_Y
  - Facet variable names: `names(b$layout$facet$params$facets)` (quosures)
  - nrow/ncol: `b$layout$facet$params$nrow` and `b$layout$facet$params$ncol`
  - Compute actual nrow/ncol from layout dataframe: `max(b$layout$layout$ROW)`, `max(b$layout$layout$COL)`

  **3. Extract strip labels:**
  For each panel row in layout dataframe, construct the strip label from the faceting variable values. Use the values directly from the layout dataframe columns (the facet variable columns contain the level values as character strings).

  For a single facet variable (e.g., `~ cyl`), the strip label is just the value of that column for each panel row. For multiple variables (e.g., `~ cyl + gear`), concatenate with ", " separator.

  Build strips array:
  ```r
  facet_vars <- names(b$layout$facet$params$facets)
  strips <- lapply(seq_len(nrow(layout_df)), function(i) {
    label_parts <- vapply(facet_vars, function(v) {
      as.character(layout_df[[v]][i])
    }, character(1))
    list(PANEL = as.integer(layout_df$PANEL[i]),
         label = paste(label_parts, collapse = ", "))
  })
  ```

  **4. Extract per-panel scale metadata:**
  Build `panels` array from `b$layout$panel_params`. For fixed scales, all panels share the same domain/range, but extract per-panel to support future free scales.

  For each panel_params entry, extract x/y ranges and breaks (applying the same coord_flip un-swap logic already used for single-panel). Use the existing pp_x/pp_y extraction pattern but loop over all panel_params:

  ```r
  panels_ir <- lapply(seq_along(b$layout$panel_params), function(p) {
    pp <- b$layout$panel_params[[p]]
    if (is_flip_early) {
      ppx <- pp$y  # un-swap for coord_flip
      ppy <- pp$x
    } else {
      ppx <- pp$x
      ppy <- pp$y
    }
    list(
      PANEL = as.integer(p),
      x_range = unname(ppx$continuous_range %||% ppx$range),
      y_range = unname(ppy$continuous_range %||% ppy$range),
      x_breaks = unname(ppx$breaks[!is.na(ppx$breaks)]),
      y_breaks = unname(ppy$breaks[!is.na(ppy$breaks)])
    )
  })
  ```

  **5. Build facets IR object:**
  ```r
  facets_ir <- list(
    type = "wrap",
    vars = facet_vars,
    nrow = as.integer(max(layout_df$ROW)),
    ncol = as.integer(max(layout_df$COL)),
    layout = lapply(seq_len(nrow(layout_df)), function(i) {
      row <- as.list(layout_df[i, , drop = FALSE])
      row$PANEL <- as.integer(row$PANEL)
      row$ROW <- as.integer(row$ROW)
      row$COL <- as.integer(row$COL)
      row$SCALE_X <- as.integer(row$SCALE_X)
      row$SCALE_Y <- as.integer(row$SCALE_Y)
      row
    }),
    strips = strips
  )
  ```

  **6. For non-faceted plots (default):**
  ```r
  facets_ir <- list(
    type = "null",
    vars = list(),
    nrow = 1L,
    ncol = 1L,
    layout = list(list(PANEL = 1L, ROW = 1L, COL = 1L, SCALE_X = 1L, SCALE_Y = 1L)),
    strips = list()
  )
  panels_ir <- list(list(
    PANEL = 1L,
    x_range = unname(scales$x$domain),
    y_range = unname(scales$y$domain),
    x_breaks = unname(x_breaks),
    y_breaks = unname(y_breaks)
  ))
  ```

  **7. Update the final IR assembly:**
  Replace the hardcoded `facets` field with `facets_ir`. Add `panels = panels_ir` to the IR object.

  **8. Ensure PANEL column is preserved in layer data:**
  PANEL is already in the outer `keep_aes` vector (line 21) AND the inner `keep_aes` (line 203), so it should already be in layer data. Verify by checking that `to_rows()` converts PANEL to integer, not factor. Add explicit integer coercion in the factor-stripping logic: if the column name is "PANEL", coerce to integer.

  **9. Extract strip theme elements for IR:**
  Add strip theme extraction to the theme_ir block:
  ```r
  strip = list(
    text = extract_theme_element("strip.text", b$plot$theme),
    background = extract_theme_element("strip.background", b$plot$theme)
  )
  ```

  **10. Extract panel.spacing for IR:**
  ```r
  panel_spacing <- tryCatch({
    complete_theme <- ggplot2::theme_get() + b$plot$theme
    spacing <- ggplot2:::calc_element("panel.spacing", complete_theme)
    if (!is.null(spacing)) {
      inches <- grid::convertUnit(spacing, "inches", valueOnly = TRUE)
      inches * 96  # pixels
    } else {
      7.3  # default 5.5pt in pixels
    }
  }, error = function(e) 7.3)
  ```
  Add `panel_spacing` to the facets IR: `facets_ir$spacing <- panel_spacing`

  **Important:** Wrap ALL facet extraction in tryCatch so non-faceted plots never break. The fallback is the "null" facet type with single panel.
  </action>
  <verify>
  Run in R:
  ```r
  devtools::load_all()
  library(ggplot2)

  # Test facet_wrap
  p <- ggplot(mtcars, aes(wt, mpg)) + geom_point() + facet_wrap(~ cyl, nrow = 2)
  ir <- as_d3_ir(p)
  stopifnot(ir$facets$type == "wrap")
  stopifnot(ir$facets$nrow == 2)
  stopifnot(ir$facets$ncol == 2)
  stopifnot(length(ir$facets$layout) == 3)
  stopifnot(length(ir$facets$strips) == 3)
  stopifnot(length(ir$panels) == 3)
  stopifnot(all(sapply(ir$panels, function(p) length(p$x_range) == 2)))
  # Check PANEL in layer data
  stopifnot(all(sapply(ir$layers[[1]]$data, function(d) is.integer(d$PANEL))))
  cat("facet_wrap IR: PASS\n")

  # Test non-faceted (backward compat)
  p2 <- ggplot(mtcars, aes(wt, mpg)) + geom_point()
  ir2 <- as_d3_ir(p2)
  stopifnot(ir2$facets$type == "null")
  stopifnot(length(ir2$panels) == 1)
  cat("non-faceted IR: PASS\n")
  ```
  </verify>
  <done>
  facet_wrap plots produce IR with facets.type="wrap", correct layout/strips/panels arrays, and PANEL column as integer in layer data. Non-faceted plots produce facets.type="null" with single panel. All existing tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add facet IR validation to validate_ir()</name>
  <files>R/validate_ir.R</files>
  <action>
  Add facet structure validation to validate_ir() after the existing guide validation block (~line 100).

  **Validate facets field:**
  ```r
  # Validate facets structure
  if (!is.null(ir$facets)) {
    if (!"type" %in% names(ir$facets)) {
      stop("IR facets must contain a 'type' field", call. = FALSE)
    }
    if (!ir$facets$type %in% c("null", "wrap", "grid")) {
      warning(sprintf("Unrecognized facet type '%s'", ir$facets$type), call. = FALSE)
    }
    if (ir$facets$type == "wrap") {
      if (is.null(ir$facets$layout) || length(ir$facets$layout) == 0) {
        stop("facet_wrap IR must have non-empty layout", call. = FALSE)
      }
      if (is.null(ir$facets$strips)) {
        warning("facet_wrap IR has no strips", call. = FALSE)
      }
      if (is.null(ir$facets$nrow) || is.null(ir$facets$ncol)) {
        warning("facet_wrap IR missing nrow/ncol", call. = FALSE)
      }
    }
  }

  # Validate panels array
  if (!is.null(ir$panels) && length(ir$panels) > 0) {
    for (i in seq_along(ir$panels)) {
      panel <- ir$panels[[i]]
      if (is.null(panel$PANEL)) {
        warning(sprintf("Panel %d missing PANEL identifier", i), call. = FALSE)
      }
      if (is.null(panel$x_range) || length(panel$x_range) != 2) {
        warning(sprintf("Panel %d has invalid x_range", i), call. = FALSE)
      }
      if (is.null(panel$y_range) || length(panel$y_range) != 2) {
        warning(sprintf("Panel %d has invalid y_range", i), call. = FALSE)
      }
    }
  }
  ```

  Validation is soft (warnings for non-critical, errors only for missing type). Backward compatible: IR without facets field passes unchanged.
  </action>
  <verify>
  Run: `devtools::test()` -- all existing tests pass plus:
  ```r
  # Quick validation check
  devtools::load_all()
  p <- ggplot(mtcars, aes(wt, mpg)) + geom_point() + facet_wrap(~ cyl)
  ir <- as_d3_ir(p)  # Should pass validation
  cat("Facet IR validates: PASS\n")
  ```
  </verify>
  <done>
  validate_ir() checks facet type, layout presence, strip existence, panel ranges. Existing non-faceted IR passes unchanged. All tests pass.
  </done>
</task>

</tasks>

<verification>
- `devtools::test()` passes with no failures
- facet_wrap IR has type="wrap", layout with PANEL/ROW/COL, strips with labels, panels with ranges/breaks
- Non-faceted IR has type="null" with single panel
- PANEL column preserved as integer in layer data
- Strip theme elements extracted in theme IR
- panel.spacing extracted in facets IR
</verification>

<success_criteria>
1. `as_d3_ir(ggplot(mtcars, aes(wt,mpg)) + geom_point() + facet_wrap(~cyl))` returns IR with facets.type=="wrap" and 3 panels
2. `as_d3_ir(ggplot(mtcars, aes(wt,mpg)) + geom_point())` returns IR with facets.type=="null" (backward compat)
3. All existing package tests pass without modification
4. PANEL column is integer in every layer data row
</success_criteria>

<output>
After completion, create `.planning/phases/08-basic-faceting/08-01-SUMMARY.md`
</output>
