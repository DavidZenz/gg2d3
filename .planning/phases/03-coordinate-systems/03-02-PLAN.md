---
phase: 03-coordinate-systems
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - inst/htmlwidgets/gg2d3.js
autonomous: true

must_haves:
  truths:
    - "coord_fixed(ratio=1) renders a square panel regardless of widget container dimensions"
    - "coord_fixed(ratio=2) renders a panel where 1 unit of y takes twice the visual space as 1 unit of x"
    - "Panel is centered in the available space when aspect ratio constrains dimensions"
    - "Text elements (axis labels, title) remain at constant pixel size during resize"
    - "Widget resize recalculates panel dimensions maintaining the aspect ratio"
  artifacts:
    - path: "inst/htmlwidgets/gg2d3.js"
      provides: "Constrained panel calculation and resize support for coord_fixed"
      contains: "coord.ratio"
  key_links:
    - from: "inst/htmlwidgets/gg2d3.js"
      to: "R/as_d3_ir.R"
      via: "ir.coord.ratio from R-side extraction (Plan 03-01)"
      pattern: "ir\\.coord.*ratio"
---

<objective>
Implement coord_fixed aspect ratio constraints in the D3 rendering pipeline.

When a ggplot uses `coord_fixed(ratio = N)`, the rendered panel should maintain the specified aspect ratio (y/x) regardless of widget container dimensions. This uses constrained panel dimension calculation (not SVG viewBox) to preserve text readability.

Purpose: coord_fixed is essential for spatial data, maps, and any plot where physical proportions matter.
Output: Working coord_fixed with correct aspect ratio maintained during resize.
</objective>

<execution_context>
@/Users/davidzenz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davidzenz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-coordinate-systems/03-RESEARCH.md
@.planning/phases/03-coordinate-systems/03-01-SUMMARY.md
@inst/htmlwidgets/gg2d3.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement constrained panel dimensions for coord_fixed</name>
  <files>inst/htmlwidgets/gg2d3.js</files>
  <action>
Add aspect ratio constraint logic to the `draw()` function in `gg2d3.js`.

**1. Add panel dimension calculation function** at the top of the `draw()` function (after padding calculation, before scale creation):

```javascript
// Calculate panel dimensions with optional aspect ratio constraint
function calculatePanelSize(availW, availH, ratio) {
  if (!ratio || ratio <= 0) {
    return { w: availW, h: availH, offsetX: 0, offsetY: 0 };
  }

  // ratio = y_units / x_units in data space
  // For coord_fixed(ratio=1), 1 data unit on y = 1 data unit on x in pixels
  // We need to account for the scale ranges to compute actual pixel ratio
  let panelW, panelH;
  if (availH / availW > ratio) {
    // Width-limited: use full width, constrain height
    panelW = availW;
    panelH = availW * ratio;
  } else {
    // Height-limited: use full height, constrain width
    panelH = availH;
    panelW = availH / ratio;
  }

  // Center panel in available space
  const offsetX = (availW - panelW) / 2;
  const offsetY = (availH - panelH) / 2;

  return { w: panelW, h: panelH, offsetX, offsetY };
}
```

**2. Integrate into existing dimension calculation:**

Currently the code does:
```javascript
const w = Math.max(10, innerW - pad.left - pad.right);
const h = Math.max(10, innerH - pad.top - pad.bottom);
```

Replace with:
```javascript
const availW = Math.max(10, innerW - pad.left - pad.right);
const availH = Math.max(10, innerH - pad.top - pad.bottom);

// Apply coord_fixed aspect ratio constraint
const coordRatio = ir.coord && ir.coord.ratio;
const panel = calculatePanelSize(availW, availH, coordRatio);
const w = panel.w;
const h = panel.h;
```

**3. Adjust panel group transform for centering:**

Currently:
```javascript
const g = root.append("g").attr("transform", `translate(${pad.left},${pad.top})`);
```

Update to account for centering offset:
```javascript
const g = root.append("g").attr("transform",
  `translate(${pad.left + panel.offsetX},${pad.top + panel.offsetY})`
);
```

**4. Adjust title and axis title positions** to account for the panel offset. The plot title should stay at top center of the full SVG (no change needed). Axis titles need to reference the offset panel position:
- Bottom axis title: `pad.top + panel.offsetY + h + (some margin)` for y position
- Left axis title: use `pad.left + panel.offsetX - (some margin)` for x position

Update the axis title rendering (from Plan 03-01) to use the offset:
```javascript
// X-axis title
if (xTitle) {
  root.append("text")
    .attr("x", pad.left + panel.offsetX + w / 2)
    .attr("y", pad.top + panel.offsetY + h + pad.bottom - 5)
    ...
}

// Y-axis title
if (yTitle) {
  const yTitleX = Math.max(12, pad.left + panel.offsetX - 35);
  root.append("text")
    .attr("x", yTitleX)
    .attr("y", pad.top + panel.offsetY + h / 2)
    .attr("transform", `rotate(-90, ${yTitleX}, ${pad.top + panel.offsetY + h / 2})`)
    ...
}
```

**5. Implement resize support:**

Update the widget `resize` method to actually redraw:
```javascript
resize: function (newWidth, newHeight) {
  width = newWidth;
  height = newHeight;
  if (currentIR) {
    draw(currentIR, newWidth, newHeight);
  }
}
```

And store the IR for reuse:
```javascript
// At the top of factory function, add:
let currentIR = null;

// In renderValue:
renderValue: function (x) {
  // ... existing parsing ...
  currentIR = ir;
  draw(ir, width, height);
},
```

**6. Ensure coord_fixed + coord_flip interaction:**

If both `flip` and `ratio` are present (which ggplot2 does allow via `coord_flip()` being superseded by flipping aesthetics), the ratio should still apply. However, `coord_flip` and `coord_fixed` are mutually exclusive coordinate systems in ggplot2 â€” a plot uses one or the other. So no special interaction handling is needed.
  </action>
  <verify>
Create test script:
```r
devtools::load_all()
library(ggplot2)

# Test 1: Square panel (ratio=1)
p1 <- ggplot(mtcars, aes(wt, mpg)) +
  geom_point() +
  coord_fixed(ratio = 1) +
  labs(title = "coord_fixed(ratio=1) - Square panel")
gg2d3(p1)

# Test 2: Tall panel (ratio=2)
p2 <- ggplot(mtcars, aes(wt, mpg)) +
  geom_point() +
  coord_fixed(ratio = 2) +
  labs(title = "coord_fixed(ratio=2) - Tall panel")
gg2d3(p2)

# Test 3: Wide panel (ratio=0.5)
p3 <- ggplot(mtcars, aes(wt, mpg)) +
  geom_point() +
  coord_fixed(ratio = 0.5) +
  labs(title = "coord_fixed(ratio=0.5) - Wide panel")
gg2d3(p3)

# Test 4: Default (no constraint) - should fill available space
p4 <- ggplot(mtcars, aes(wt, mpg)) +
  geom_point() +
  labs(title = "No coord_fixed - Full size")
gg2d3(p4)
```

Verify:
1. p1 has a square plotting area (equal width and height)
2. p2 has a taller-than-wide plotting area
3. p3 has a wider-than-tall plotting area
4. p4 fills the available space as before (no regression)
5. All panels are centered in the widget
6. Text sizes remain constant across all panels
  </verify>
  <done>coord_fixed constrains panel aspect ratio correctly, panel is centered, text size is constant, and resize recalculates dimensions. No regression for unconstrained plots.</done>
</task>

</tasks>

<verification>
1. `devtools::test()` passes all existing tests
2. `coord_fixed(ratio = 1)` produces a square panel
3. `coord_fixed(ratio = 2)` produces a panel twice as tall as wide
4. Default plots without coord_fixed are unchanged (no regression)
5. Panel is visually centered in the widget container
6. Resizing the widget recalculates panel size while maintaining ratio
</verification>

<success_criteria>
coord_fixed maintains specified aspect ratio with centered panel and constant text size, and widget resize preserves the ratio.
</success_criteria>

<output>
After completion, create `.planning/phases/03-coordinate-systems/03-02-SUMMARY.md`
</output>
