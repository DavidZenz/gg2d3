---
phase: 03-coordinate-systems
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - R/as_d3_ir.R
  - inst/htmlwidgets/gg2d3.js
  - inst/htmlwidgets/modules/theme.js
autonomous: true

must_haves:
  truths:
    - "coord_flip places x-aesthetic axis on the left and y-aesthetic axis on the bottom"
    - "Axis labels swap correctly — x title appears on left axis, y title on bottom axis after flip"
    - "Grid lines align with correct axes after coordinate flip (x-breaks draw horizontal, y-breaks draw vertical)"
    - "Theme elements follow aesthetic semantics (axis.text.x styles x-aesthetic axis regardless of visual position)"
    - "coord_fixed ratio field is extracted from ggplot2 and included in IR"
  artifacts:
    - path: "R/as_d3_ir.R"
      provides: "coord_fixed extraction with ratio field in IR"
      contains: "CoordFixed"
    - path: "inst/htmlwidgets/gg2d3.js"
      provides: "Correct axis positioning, axis title placement, and theme mapping for flipped coords"
      contains: "axisLeft(xScale)"
    - path: "inst/htmlwidgets/modules/theme.js"
      provides: "Grid drawing with orientation aware of coord_flip"
  key_links:
    - from: "R/as_d3_ir.R"
      to: "inst/htmlwidgets/gg2d3.js"
      via: "ir.coord.flip and ir.coord.ratio fields"
      pattern: "coord\\.flip"
    - from: "inst/htmlwidgets/gg2d3.js"
      to: "inst/htmlwidgets/modules/theme.js"
      via: "drawGrid orientation parameter swapped for flip"
      pattern: "drawGrid.*horizontal|drawGrid.*vertical"
---

<objective>
Fix coord_flip axis positioning and grid alignment, and extract coord_fixed metadata from R.

coord_flip is currently broken: scale ranges are swapped but axes remain at wrong positions, grid lines are misaligned, and axis titles don't swap. This plan fixes the D3 rendering pipeline to treat coord_flip as a layout transformation (not just a scale swap), and adds R-side extraction for coord_fixed.

Purpose: coord_flip is one of the most-used ggplot2 features (horizontal bar charts, etc). Fixing it unblocks real-world usage.
Output: Working coord_flip with correct axes, grids, titles, and theme element mapping. IR includes coord_fixed ratio.
</objective>

<execution_context>
@/Users/davidzenz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davidzenz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-coordinate-systems/03-RESEARCH.md
@inst/htmlwidgets/gg2d3.js
@inst/htmlwidgets/modules/theme.js
@R/as_d3_ir.R
</context>

<tasks>

<task type="auto">
  <name>Task 1: R-side coord extraction (coord_flip + coord_fixed)</name>
  <files>R/as_d3_ir.R</files>
  <action>
Update the `coord` extraction in `as_d3_ir()` (currently at line ~431) to detect both CoordFlip and CoordFixed:

1. **CoordFixed detection**: Add detection for `inherits(b$plot$coordinates, "CoordFixed")`. Extract the `ratio` parameter from `b$plot$coordinates$ratio` (defaults to 1). Add it to the `ir$coord` object as `ratio`.

2. **coord_equal normalization**: `coord_equal()` is a synonym for `coord_fixed(ratio = 1)`. Both produce `CoordFixed` class, so detection is the same.

3. **Update coord IR structure** to:
```r
coord = list(
  type = dplyr::case_when(
    inherits(b$plot$coordinates, "CoordFlip") ~ "flip",
    inherits(b$plot$coordinates, "CoordFixed") ~ "fixed",
    TRUE ~ "cartesian"
  ),
  flip = inherits(b$plot$coordinates, "CoordFlip"),
  ratio = if (inherits(b$plot$coordinates, "CoordFixed"))
            b$plot$coordinates$ratio %||% 1
          else NULL
)
```
Note: Do NOT use dplyr. Use simple if/else instead. The `flip` boolean is kept for backward compatibility with existing JS code.

4. **Swap axis labels for coord_flip**: When `flip = TRUE`, swap the axis label assignments so that `ir$axes$x$label` gets `b$plot$labels$y` and `ir$axes$y$label` gets `b$plot$labels$x`. This is because ggplot2 swaps the visual axes — the x-aesthetic title should appear on the left visual axis after flip.
  </action>
  <verify>
Run in R:
```r
devtools::load_all()
library(ggplot2)

# Test coord_flip IR
p1 <- ggplot(mtcars, aes(factor(cyl), mpg)) + geom_col() + coord_flip()
ir1 <- as_d3_ir(p1)
stopifnot(ir1$coord$flip == TRUE)
stopifnot(ir1$coord$type == "flip")
# After flip, x label (factor(cyl)) should be on what was the y-axis
stopifnot(ir1$axes$x$label == "mpg")  # x visual axis = bottom = y aesthetic
stopifnot(ir1$axes$y$label == "factor(cyl)")  # y visual axis = left = x aesthetic

# Test coord_fixed IR
p2 <- ggplot(mtcars, aes(wt, mpg)) + geom_point() + coord_fixed(ratio = 2)
ir2 <- as_d3_ir(p2)
stopifnot(ir2$coord$type == "fixed")
stopifnot(ir2$coord$ratio == 2)
stopifnot(ir2$coord$flip == FALSE)

# Test default cartesian (no coord)
p3 <- ggplot(mtcars, aes(wt, mpg)) + geom_point()
ir3 <- as_d3_ir(p3)
stopifnot(ir3$coord$type == "cartesian")
stopifnot(ir3$coord$flip == FALSE)
stopifnot(is.null(ir3$coord$ratio))

cat("All coord IR extraction tests passed!\n")
```
  </verify>
  <done>IR contains correct coord.type, coord.flip, and coord.ratio for CoordFlip, CoordFixed, and default CoordCartesian. Axis labels swap correctly for coord_flip.</done>
</task>

<task type="auto">
  <name>Task 2: Fix D3 coord_flip rendering (axes, grids, titles, theme mapping)</name>
  <files>inst/htmlwidgets/gg2d3.js, inst/htmlwidgets/modules/theme.js</files>
  <action>
This is the core fix. The current `gg2d3.js` flip branch (lines 131-155) swaps scale ranges but uses confusing variable names and incorrect axis positioning. Rewrite the flip logic:

**In `gg2d3.js` — Scale creation (lines 56-58):**

The current approach of swapping scale ranges is actually correct for positioning data points. Keep it:
```javascript
const flip = !!(ir.coord && ir.coord.flip);
let xScale = window.gg2d3.scales.createScale(ir.scales && ir.scales.x, flip ? [h, 0] : [0, w]);
let yScale = window.gg2d3.scales.createScale(ir.scales && ir.scales.y, flip ? [0, w] : [h, 0]);
```

**In `gg2d3.js` — Grid drawing (lines 61-80):**

Replace the grid section to swap orientations for flip. When flipped:
- x-scale controls vertical visual axis, so x-breaks draw **horizontal** lines
- y-scale controls horizontal visual axis, so y-breaks draw **vertical** lines

```javascript
// Minor grid
if (gridMinor && gridMinor.type !== "blank") {
  const xMinorBreaks = ir.scales && ir.scales.x && ir.scales.x.minor_breaks;
  const yMinorBreaks = ir.scales && ir.scales.y && ir.scales.y.minor_breaks;
  if (xMinorBreaks || yMinorBreaks) {
    window.gg2d3.theme.drawGrid(g, xScale, flip ? "horizontal" : "vertical", gridMinor, xMinorBreaks, w, h, convertColor);
    window.gg2d3.theme.drawGrid(g, yScale, flip ? "vertical" : "horizontal", gridMinor, yMinorBreaks, w, h, convertColor);
  }
}
// Major grid
if (gridMajor && gridMajor.type !== "blank") {
  const xBreaks = ir.scales && ir.scales.x && ir.scales.x.breaks;
  const yBreaks = ir.scales && ir.scales.y && ir.scales.y.breaks;
  window.gg2d3.theme.drawGrid(g, xScale, flip ? "horizontal" : "vertical", gridMajor, xBreaks, w, h, convertColor);
  window.gg2d3.theme.drawGrid(g, yScale, flip ? "vertical" : "horizontal", gridMajor, yBreaks, w, h, convertColor);
}
```

**In `gg2d3.js` — Axis rendering (lines 117-183):**

Rewrite the axis section. The key insight: after flip, `xScale` maps to the LEFT visual axis (vertical), and `yScale` maps to the BOTTOM visual axis (horizontal). Theme elements follow aesthetic semantics: `axis.text.x` applies to whichever axis the x-aesthetic controls.

For the flip branch:
- Create `d3.axisLeft(xScale)` for the LEFT visual axis (this IS the x-aesthetic)
- Create `d3.axisBottom(yScale)` for the BOTTOM visual axis (this IS the y-aesthetic)
- Apply `xBreaks` to the left axis, `yBreaks` to the bottom axis
- Apply `xTransform` tick format to left axis, `yTransform` to bottom axis

Also add separate theme element extraction for x-specific and y-specific axis styling. Currently only `axis.text` (generic) is used. Extract:
- `axis.text.x` and `axis.text.y` from theme (falling back to `axis.text`)
- `axis.line.x` and `axis.line.y` from theme (falling back to `axis.line`)
- `axis.ticks.x` and `axis.ticks.y` from theme (falling back to `axis.ticks`)

In the flip branch, apply x-theme to the left visual axis and y-theme to the bottom visual axis.
In the normal branch, apply x-theme to the bottom visual axis and y-theme to the left visual axis.

**Axis titles:**

After the axis rendering block, add axis title rendering. The IR provides `ir.axes.x.label` and `ir.axes.y.label`. Note: in the R-side (Task 1), we already swapped these for coord_flip, so the D3 code just renders them at their normal positions:
- x-axis title below the bottom axis
- y-axis title rotated -90 degrees to the left of the left axis

Add title rendering:
```javascript
// X-axis title (below bottom axis)
const xTitle = ir.axes && ir.axes.x && ir.axes.x.label;
const axisTitleSpec = theme.get("axis.title");
if (xTitle) {
  root.append("text")
    .attr("x", pad.left + w / 2)
    .attr("y", pad.top + h + pad.bottom - 5)
    .attr("text-anchor", "middle")
    .style("font-size", axisTitleSpec && axisTitleSpec.size ? `${axisTitleSpec.size}px` : "11px")
    .style("fill", convertColor(axisTitleSpec && axisTitleSpec.colour) || "black")
    .style("font-family", axisTitleSpec && axisTitleSpec.family || "sans-serif")
    .text(xTitle);
}

// Y-axis title (rotated, left of left axis)
const yTitle = ir.axes && ir.axes.y && ir.axes.y.label;
if (yTitle) {
  root.append("text")
    .attr("x", 12)
    .attr("y", pad.top + h / 2)
    .attr("text-anchor", "middle")
    .attr("transform", `rotate(-90, 12, ${pad.top + h / 2})`)
    .style("font-size", axisTitleSpec && axisTitleSpec.size ? `${axisTitleSpec.size}px` : "11px")
    .style("fill", convertColor(axisTitleSpec && axisTitleSpec.colour) || "black")
    .style("font-family", axisTitleSpec && axisTitleSpec.family || "sans-serif")
    .text(yTitle);
}
```

**In `theme.js` — no structural changes needed.** The `drawGrid()` function already accepts an `orientation` parameter. The fix is in `gg2d3.js` where we pass the correct orientation based on flip state.

**In `theme.js` — add x/y-specific theme support:**

Update `DEFAULT_THEME` to include `axis.text.x`, `axis.text.y`, `axis.line.x`, `axis.line.y`, `axis.ticks.x`, `axis.ticks.y` as null (so they inherit from the generic versions). The `createTheme` `get()` function already handles dot-path lookups, so `theme.get("axis.text.x")` will return the x-specific override or null. The caller in `gg2d3.js` should fall back to `theme.get("axis.text")` when the specific version is null.

Add these to `DEFAULT_THEME.axis`:
```javascript
axis: {
  line: { type: "blank" },
  text: { type: "text", colour: "#4D4D4D", size: 8.8 },
  title: { type: "text", colour: "black", size: 11 },
  ticks: { type: "line", colour: "#333333", linewidth: 1.89 },
  // x/y specific (null = inherit from generic)
  "text.x": null,
  "text.y": null,
  "line.x": null,
  "line.y": null,
  "ticks.x": null,
  "ticks.y": null
}
```

Wait — this won't work with dot-path lookup since the keys contain dots. Instead, restructure as nested objects where needed or handle in gg2d3.js by falling back. The simpler approach: In `gg2d3.js`, extract x/y-specific theme elements and fall back to generic:

```javascript
const axisTextX = theme.get("axis.text.x") || axisText;
const axisTextY = theme.get("axis.text.y") || axisText;
const axisLineX = theme.get("axis.line.x") || axisLine;
const axisLineY = theme.get("axis.line.y") || axisLine;
const axisTicksX = theme.get("axis.ticks.x") || axisTicks;
const axisTicksY = theme.get("axis.ticks.y") || axisTicks;
```

The R-side `as_d3_ir.R` already extracts `axis.text`, `axis.line`, `axis.ticks` at the generic level. To support x/y-specific, add extraction of `axis.text.x`, `axis.text.y`, `axis.line.x`, `axis.line.y`, `axis.ticks.x`, `axis.ticks.y` in the theme_ir construction. These should be nested under `axis` like:
```r
axis = list(
  line = extract_theme_element("axis.line", b$plot$theme),
  line.x = extract_theme_element("axis.line.x", b$plot$theme),
  line.y = extract_theme_element("axis.line.y", b$plot$theme),
  text = extract_theme_element("axis.text", b$plot$theme),
  text.x = extract_theme_element("axis.text.x", b$plot$theme),
  text.y = extract_theme_element("axis.text.y", b$plot$theme),
  title = extract_theme_element("axis.title", b$plot$theme),
  ticks = extract_theme_element("axis.ticks", b$plot$theme),
  ticks.x = extract_theme_element("axis.ticks.x", b$plot$theme),
  ticks.y = extract_theme_element("axis.ticks.y", b$plot$theme)
)
```

**NOTE:** R list names with dots are legal. In the JSON output they become `{"text.x": ...}` which the `get()` path resolver in theme.js will pick up correctly since it splits on dots and traverses the tree: `axis` -> `text` -> `x`. BUT the R list key is `"text.x"` as a flat key under `axis`, not a nested `text.x`. The `get("axis.text.x")` call resolves to `theme.axis["text"]["x"]` which won't match `theme.axis["text.x"]`.

**Resolution:** Use nested R lists instead:
```r
axis = list(
  line = list(
    .self = extract_theme_element("axis.line", b$plot$theme),
    x = extract_theme_element("axis.line.x", b$plot$theme),
    y = extract_theme_element("axis.line.y", b$plot$theme)
  ),
  text = list(
    .self = extract_theme_element("axis.text", b$plot$theme),
    x = extract_theme_element("axis.text.x", b$plot$theme),
    y = extract_theme_element("axis.text.y", b$plot$theme)
  ),
  title = extract_theme_element("axis.title", b$plot$theme),
  ticks = list(
    .self = extract_theme_element("axis.ticks", b$plot$theme),
    x = extract_theme_element("axis.ticks.x", b$plot$theme),
    y = extract_theme_element("axis.ticks.y", b$plot$theme)
  )
)
```

But this breaks the existing `theme.get("axis.text")` call — it would now return the full `{.self, x, y}` object instead of the text spec.

**Simplest approach that preserves backward compatibility**: Keep the R-side theme extraction as-is. In gg2d3.js, directly access the nested IR structure for x/y variants. In R, add separate top-level fields:

Actually, the cleanest approach: keep `axis.text`, `axis.line`, `axis.ticks` as they are. Add new fields in gg2d3.js that look up `axis.text.x` etc. If the theme IR doesn't have them (which it won't for default themes since ggplot2's `axis.text.x` inherits from `axis.text`), just fall back. This means NO R-side changes for theme extraction — only gg2d3.js changes.

```javascript
// In gg2d3.js axis section:
const axisTextX = theme.get("axis.text.x") || axisText;
const axisTextY = theme.get("axis.text.y") || axisText;
```

Since `theme.get("axis.text.x")` will return `null` when the user hasn't overridden `axis.text.x` specifically (they usually only set `axis.text`), this fallback is correct. And for custom themes that DO set `axis.text.x` differently, we'd need the R-side extraction — but that's an edge case for now and can be added later.

**Final approach for Task 2:** Just fix the D3 rendering. No theme.js structural changes needed. No R-side theme extraction changes needed beyond coord detection.
  </action>
  <verify>
Create a test script in R:
```r
devtools::load_all()
library(ggplot2)

# Horizontal bar chart with coord_flip
p <- ggplot(mtcars, aes(factor(cyl), mpg)) +
  geom_col(fill = "steelblue") +
  coord_flip() +
  labs(x = "Cylinders", y = "Miles per Gallon")

gg2d3(p)
```

Verify visually:
1. Bars extend horizontally (left to right)
2. Category labels (4, 6, 8) appear on the LEFT axis
3. Numeric labels (mpg values) appear on the BOTTOM axis
4. "Cylinders" title on the left vertical axis
5. "Miles per Gallon" title below the bottom axis
6. Grid lines align with axis ticks on both axes
  </verify>
  <done>coord_flip renders with x-axis on left, y-axis on bottom, grid lines aligned with correct axes, axis titles positioned correctly, and theme elements following aesthetic semantics.</done>
</task>

</tasks>

<verification>
1. `devtools::test()` passes all existing tests
2. A `coord_flip()` bar chart shows horizontal bars with category labels on the left and value labels on the bottom
3. A `coord_flip()` point chart shows x-aesthetic on left axis, y-aesthetic on bottom axis
4. Grid lines align with their respective axis ticks after flip
5. Axis titles appear on correct sides (x title on left, y title on bottom after flip)
6. Default (no coord) plots still render correctly (no regression)
</verification>

<success_criteria>
coord_flip produces correct axis placement matching ggplot2: x-aesthetic on left, y-aesthetic on bottom, with aligned grids and correct titles.
</success_criteria>

<output>
After completion, create `.planning/phases/03-coordinate-systems/03-01-SUMMARY.md`
</output>
