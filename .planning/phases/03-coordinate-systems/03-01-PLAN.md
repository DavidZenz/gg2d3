---
phase: 03-coordinate-systems
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - R/as_d3_ir.R
  - inst/htmlwidgets/gg2d3.js
autonomous: true

must_haves:
  truths:
    - "coord_flip places x-aesthetic axis on the left and y-aesthetic axis on the bottom"
    - "Axis labels swap correctly — x title appears on left axis, y title on bottom axis after flip"
    - "Grid lines align with correct axes after coordinate flip (x-breaks draw horizontal, y-breaks draw vertical)"
    - "Theme elements follow aesthetic semantics (axis.text.x styles x-aesthetic axis regardless of visual position)"
    - "coord_fixed ratio field is extracted from ggplot2 and included in IR"
  artifacts:
    - path: "R/as_d3_ir.R"
      provides: "coord_fixed extraction with ratio field in IR"
      contains: "CoordFixed"
    - path: "inst/htmlwidgets/gg2d3.js"
      provides: "Correct axis positioning, axis title placement, and theme mapping for flipped coords"
      contains: "axisLeft(xScale)"
  key_links:
    - from: "R/as_d3_ir.R"
      to: "inst/htmlwidgets/gg2d3.js"
      via: "ir.coord.flip and ir.coord.ratio fields"
      pattern: "coord\\.flip"
    - from: "R/as_d3_ir.R"
      to: "inst/htmlwidgets/gg2d3.js"
      via: "ir.axes.x.label and ir.axes.y.label swapped for coord_flip"
      pattern: "axes\\.x\\.label|axes\\.y\\.label"
    - from: "inst/htmlwidgets/gg2d3.js"
      to: "inst/htmlwidgets/modules/theme.js"
      via: "drawGrid orientation parameter swapped for flip"
      pattern: "drawGrid.*horizontal|drawGrid.*vertical"
---

<objective>
Fix coord_flip axis positioning and grid alignment, and extract coord_fixed metadata from R.

coord_flip is currently broken: scale ranges are swapped but axes remain at wrong positions, grid lines are misaligned, and axis titles don't swap. This plan fixes the D3 rendering pipeline to treat coord_flip as a layout transformation (not just a scale swap), and adds R-side extraction for coord_fixed.

Purpose: coord_flip is one of the most-used ggplot2 features (horizontal bar charts, etc). Fixing it unblocks real-world usage.
Output: Working coord_flip with correct axes, grids, titles, and theme element mapping. IR includes coord_fixed ratio.
</objective>

<execution_context>
@/Users/davidzenz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davidzenz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-coordinate-systems/03-RESEARCH.md
@inst/htmlwidgets/gg2d3.js
@inst/htmlwidgets/modules/theme.js
@R/as_d3_ir.R
</context>

<tasks>

<task type="auto">
  <name>Task 1: R-side coord extraction (coord_flip + coord_fixed)</name>
  <files>R/as_d3_ir.R</files>
  <action>
Update the `coord` extraction in `as_d3_ir()` (currently at line ~431) to detect both CoordFlip and CoordFixed:

1. **CoordFixed detection**: Add detection for `inherits(b$plot$coordinates, "CoordFixed")`. Extract the `ratio` parameter from `b$plot$coordinates$ratio` (defaults to 1). Add it to the `ir$coord` object as `ratio`.

2. **coord_equal normalization**: `coord_equal()` is a synonym for `coord_fixed(ratio = 1)`. Both produce `CoordFixed` class, so detection is the same.

3. **Update coord IR structure** using if/else (do NOT use dplyr):
```r
is_flip  <- inherits(b$plot$coordinates, "CoordFlip")
is_fixed <- inherits(b$plot$coordinates, "CoordFixed")

coord_type <- if (is_flip) "flip" else if (is_fixed) "fixed" else "cartesian"
coord_ratio <- if (is_fixed) (b$plot$coordinates$ratio %||% 1) else NULL

ir$coord <- list(
  type  = coord_type,
  flip  = is_flip,
  ratio = coord_ratio
)
```
The `flip` boolean is kept for backward compatibility with existing JS code.

4. **Swap axis labels for coord_flip**: The existing IR extraction code already creates `ir$axes$x$label` and `ir$axes$y$label` from ggplot2 labels. When `is_flip == TRUE`, swap these assignments so that:
   - `ir$axes$x$label` gets `b$plot$labels$y` (the y-aesthetic label moves to the visual bottom axis)
   - `ir$axes$y$label` gets `b$plot$labels$x` (the x-aesthetic label moves to the visual left axis)
   This is because ggplot2 swaps the visual axes — the x-aesthetic title should appear on the left visual axis after flip. The `ir$axes` structure (with `x$label` and `y$label` fields) already exists from existing IR extraction code; this step only changes which labels go where when flipped.
  </action>
  <verify>
Run in R:
```r
devtools::load_all()
library(ggplot2)

# Test coord_flip IR
p1 <- ggplot(mtcars, aes(factor(cyl), mpg)) + geom_col() + coord_flip()
ir1 <- as_d3_ir(p1)
stopifnot(ir1$coord$flip == TRUE)
stopifnot(ir1$coord$type == "flip")
# After flip, x label (factor(cyl)) should be on what was the y-axis
stopifnot(ir1$axes$x$label == "mpg")  # x visual axis = bottom = y aesthetic
stopifnot(ir1$axes$y$label == "factor(cyl)")  # y visual axis = left = x aesthetic

# Test coord_fixed IR
p2 <- ggplot(mtcars, aes(wt, mpg)) + geom_point() + coord_fixed(ratio = 2)
ir2 <- as_d3_ir(p2)
stopifnot(ir2$coord$type == "fixed")
stopifnot(ir2$coord$ratio == 2)
stopifnot(ir2$coord$flip == FALSE)

# Test default cartesian (no coord)
p3 <- ggplot(mtcars, aes(wt, mpg)) + geom_point()
ir3 <- as_d3_ir(p3)
stopifnot(ir3$coord$type == "cartesian")
stopifnot(ir3$coord$flip == FALSE)
stopifnot(is.null(ir3$coord$ratio))

cat("All coord IR extraction tests passed!\n")
```
  </verify>
  <done>IR contains correct coord.type, coord.flip, and coord.ratio for CoordFlip, CoordFixed, and default CoordCartesian. Axis labels swap correctly for coord_flip.</done>
</task>

<task type="auto">
  <name>Task 2: Fix D3 coord_flip axis positioning and grid alignment</name>
  <files>inst/htmlwidgets/gg2d3.js</files>
  <action>
Fix the core coord_flip rendering. The current `gg2d3.js` flip branch (lines 131-155) swaps scale ranges but uses confusing variable names and incorrect axis positioning.

**In `gg2d3.js` — Scale creation (lines 56-58):**

The current approach of swapping scale ranges is correct for positioning data points. Keep it:
```javascript
const flip = !!(ir.coord && ir.coord.flip);
let xScale = window.gg2d3.scales.createScale(ir.scales && ir.scales.x, flip ? [h, 0] : [0, w]);
let yScale = window.gg2d3.scales.createScale(ir.scales && ir.scales.y, flip ? [0, w] : [h, 0]);
```

**In `gg2d3.js` — Grid drawing (lines 61-80):**

Replace the grid section to swap orientations for flip. When flipped:
- x-scale controls vertical visual axis, so x-breaks draw **horizontal** lines
- y-scale controls horizontal visual axis, so y-breaks draw **vertical** lines

```javascript
// Minor grid
if (gridMinor && gridMinor.type !== "blank") {
  const xMinorBreaks = ir.scales && ir.scales.x && ir.scales.x.minor_breaks;
  const yMinorBreaks = ir.scales && ir.scales.y && ir.scales.y.minor_breaks;
  if (xMinorBreaks || yMinorBreaks) {
    window.gg2d3.theme.drawGrid(g, xScale, flip ? "horizontal" : "vertical", gridMinor, xMinorBreaks, w, h, convertColor);
    window.gg2d3.theme.drawGrid(g, yScale, flip ? "vertical" : "horizontal", gridMinor, yMinorBreaks, w, h, convertColor);
  }
}
// Major grid
if (gridMajor && gridMajor.type !== "blank") {
  const xBreaks = ir.scales && ir.scales.x && ir.scales.x.breaks;
  const yBreaks = ir.scales && ir.scales.y && ir.scales.y.breaks;
  window.gg2d3.theme.drawGrid(g, xScale, flip ? "horizontal" : "vertical", gridMajor, xBreaks, w, h, convertColor);
  window.gg2d3.theme.drawGrid(g, yScale, flip ? "vertical" : "horizontal", gridMajor, yBreaks, w, h, convertColor);
}
```

**In `gg2d3.js` — Axis rendering (lines 117-183):**

Rewrite the axis section. The key insight: after flip, `xScale` maps to the LEFT visual axis (vertical), and `yScale` maps to the BOTTOM visual axis (horizontal).

For the flip branch:
- Create `d3.axisLeft(xScale)` for the LEFT visual axis (this IS the x-aesthetic)
- Create `d3.axisBottom(yScale)` for the BOTTOM visual axis (this IS the y-aesthetic)
- Apply `xBreaks` to the left axis, `yBreaks` to the bottom axis
- Apply `xTransform` tick format to left axis, `yTransform` to bottom axis

For the normal branch, keep existing behavior:
- `d3.axisBottom(xScale)` for the bottom visual axis
- `d3.axisLeft(yScale)` for the left visual axis
  </action>
  <verify>
Create a test script in R:
```r
devtools::load_all()
library(ggplot2)

# Horizontal bar chart with coord_flip
p <- ggplot(mtcars, aes(factor(cyl), mpg)) +
  geom_col(fill = "steelblue") +
  coord_flip()

gg2d3(p)
```

Verify visually:
1. Bars extend horizontally (left to right)
2. Category labels (4, 6, 8) appear on the LEFT axis
3. Numeric labels (mpg values) appear on the BOTTOM axis
4. Grid lines align with axis ticks on both axes
5. Default (no coord) plots still render correctly (no regression)
  </verify>
  <done>coord_flip axis positioning is correct: x-aesthetic on left, y-aesthetic on bottom, grid lines aligned with correct axes.</done>
</task>

<task type="auto">
  <name>Task 3: Add axis titles and x/y-specific theme element support</name>
  <files>inst/htmlwidgets/gg2d3.js</files>
  <action>
Add axis title rendering and x/y-specific theme element lookups to the axis section created in Task 2.

**Axis titles:**

After the axis rendering block, add axis title rendering. The IR provides `ir.axes.x.label` and `ir.axes.y.label` (already swapped for coord_flip in Task 1). The D3 code renders them at their normal positions:
- x-axis title below the bottom axis
- y-axis title rotated -90 degrees to the left of the left axis

```javascript
// X-axis title (below bottom axis)
const xTitle = ir.axes && ir.axes.x && ir.axes.x.label;
const axisTitleSpec = theme.get("axis.title");
if (xTitle) {
  root.append("text")
    .attr("x", pad.left + w / 2)
    .attr("y", pad.top + h + pad.bottom - 5)
    .attr("text-anchor", "middle")
    .style("font-size", axisTitleSpec && axisTitleSpec.size ? `${axisTitleSpec.size}px` : "11px")
    .style("fill", convertColor(axisTitleSpec && axisTitleSpec.colour) || "black")
    .style("font-family", axisTitleSpec && axisTitleSpec.family || "sans-serif")
    .text(xTitle);
}

// Y-axis title (rotated, left of left axis)
const yTitle = ir.axes && ir.axes.y && ir.axes.y.label;
if (yTitle) {
  root.append("text")
    .attr("x", 12)
    .attr("y", pad.top + h / 2)
    .attr("text-anchor", "middle")
    .attr("transform", `rotate(-90, 12, ${pad.top + h / 2})`)
    .style("font-size", axisTitleSpec && axisTitleSpec.size ? `${axisTitleSpec.size}px` : "11px")
    .style("fill", convertColor(axisTitleSpec && axisTitleSpec.colour) || "black")
    .style("font-family", axisTitleSpec && axisTitleSpec.family || "sans-serif")
    .text(yTitle);
}
```

**x/y-specific theme element support:**

Add fallback-based theme element extraction for per-axis styling. No R-side changes or theme.js changes needed — just look up `axis.text.x` etc. in gg2d3.js, falling back to the generic `axis.text`:

```javascript
const axisTextX = theme.get("axis.text.x") || axisText;
const axisTextY = theme.get("axis.text.y") || axisText;
const axisLineX = theme.get("axis.line.x") || axisLine;
const axisLineY = theme.get("axis.line.y") || axisLine;
const axisTicksX = theme.get("axis.ticks.x") || axisTicks;
const axisTicksY = theme.get("axis.ticks.y") || axisTicks;
```

Since `theme.get("axis.text.x")` returns `null` for default themes (ggplot2's `axis.text.x` inherits from `axis.text`), the fallback is correct. In the flip branch, apply x-theme to the left visual axis and y-theme to the bottom visual axis. In the normal branch, apply x-theme to the bottom visual axis and y-theme to the left visual axis.

**No theme.js structural changes needed.** The `drawGrid()` function already accepts an `orientation` parameter, and x/y-specific theme elements fall back cleanly.
  </action>
  <verify>
```r
devtools::load_all()
library(ggplot2)

# Horizontal bar chart with coord_flip and titles
p <- ggplot(mtcars, aes(factor(cyl), mpg)) +
  geom_col(fill = "steelblue") +
  coord_flip() +
  labs(x = "Cylinders", y = "Miles per Gallon")

gg2d3(p)
```

Verify visually:
1. "Cylinders" title on the left vertical axis
2. "Miles per Gallon" title below the bottom axis
3. Theme elements (text size, color) follow aesthetic semantics — x-aesthetic styling on left axis, y-aesthetic styling on bottom axis
4. Non-flipped plots still show titles at correct positions
  </verify>
  <done>Axis titles render at correct positions for both normal and flipped coordinates. x/y-specific theme elements are supported with correct fallback to generic axis theme.</done>
</task>

</tasks>

<verification>
1. `devtools::test()` passes all existing tests
2. A `coord_flip()` bar chart shows horizontal bars with category labels on the left and value labels on the bottom
3. A `coord_flip()` point chart shows x-aesthetic on left axis, y-aesthetic on bottom axis
4. Grid lines align with their respective axis ticks after flip
5. Axis titles appear on correct sides (x title on left, y title on bottom after flip)
6. Default (no coord) plots still render correctly (no regression)
</verification>

<success_criteria>
coord_flip produces correct axis placement matching ggplot2: x-aesthetic on left, y-aesthetic on bottom, with aligned grids and correct titles.
</success_criteria>

<output>
After completion, create `.planning/phases/03-coordinate-systems/03-01-SUMMARY.md`
</output>
