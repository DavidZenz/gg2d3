---
phase: 03-coordinate-systems
plan: 03
type: execute
wave: 3
depends_on: ["03-01", "03-02"]
files_modified:
  - tests/testthat/test-ir.R
autonomous: false

must_haves:
  truths:
    - "coord_flip works correctly with all 8 existing geom types (point, line, path, bar, col, rect, tile, text)"
    - "coord_fixed works correctly with point, line, bar, and rect geoms"
    - "R-side tests verify coord IR extraction for flip, fixed, and cartesian"
    - "Visual comparison between ggplot2 and gg2d3 confirms pixel-level fidelity for coordinate systems"
  artifacts:
    - path: "tests/testthat/test-ir.R"
      provides: "Unit tests for coord_flip and coord_fixed IR extraction"
      contains: "coord_flip"
  key_links:
    - from: "tests/testthat/test-ir.R"
      to: "R/as_d3_ir.R"
      via: "as_d3_ir() coord extraction validation"
      pattern: "coord.*flip|coord.*fixed"
---

<objective>
Add R-side unit tests for coordinate system IR extraction and generate visual comparison outputs for all geom types with coord_flip and coord_fixed.

Purpose: Ensures coordinate system changes don't regress and verifies rendering fidelity across all geom types.
Output: Passing unit tests and visual comparison files for user verification.
</objective>

<execution_context>
@/Users/davidzenz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davidzenz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-coordinate-systems/03-01-SUMMARY.md
@.planning/phases/03-coordinate-systems/03-02-SUMMARY.md
@tests/testthat/test-ir.R
@R/as_d3_ir.R
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add unit tests for coord IR extraction</name>
  <files>tests/testthat/test-ir.R</files>
  <action>
Add tests to `tests/testthat/test-ir.R` for coordinate system IR extraction:

```r
# --- Coordinate System Tests ---

test_that("coord_flip produces correct IR", {
  library(ggplot2)
  p <- ggplot(mtcars, aes(factor(cyl), mpg)) + geom_col() + coord_flip()
  ir <- as_d3_ir(p)

  expect_equal(ir$coord$type, "flip")
  expect_true(ir$coord$flip)
  expect_null(ir$coord$ratio)
})

test_that("coord_flip swaps axis labels", {
  library(ggplot2)
  p <- ggplot(mtcars, aes(factor(cyl), mpg)) +
    geom_col() +
    coord_flip() +
    labs(x = "Cylinders", y = "Miles per Gallon")
  ir <- as_d3_ir(p)

  # After flip, the visual bottom axis shows the y-aesthetic label
  # and the visual left axis shows the x-aesthetic label
  # R-side swaps: ir$axes$x$label gets the y aesthetic, ir$axes$y$label gets the x aesthetic
  expect_equal(ir$axes$x$label, "Miles per Gallon")
  expect_equal(ir$axes$y$label, "Cylinders")
})

test_that("coord_fixed produces correct IR with ratio", {
  library(ggplot2)
  p <- ggplot(mtcars, aes(wt, mpg)) + geom_point() + coord_fixed(ratio = 2)
  ir <- as_d3_ir(p)

  expect_equal(ir$coord$type, "fixed")
  expect_false(ir$coord$flip)
  expect_equal(ir$coord$ratio, 2)
})

test_that("coord_fixed with default ratio=1", {
  library(ggplot2)
  p <- ggplot(mtcars, aes(wt, mpg)) + geom_point() + coord_fixed()
  ir <- as_d3_ir(p)

  expect_equal(ir$coord$type, "fixed")
  expect_equal(ir$coord$ratio, 1)
})

test_that("default coord is cartesian", {
  library(ggplot2)
  p <- ggplot(mtcars, aes(wt, mpg)) + geom_point()
  ir <- as_d3_ir(p)

  expect_equal(ir$coord$type, "cartesian")
  expect_false(ir$coord$flip)
  expect_null(ir$coord$ratio)
})

test_that("coord_flip preserves scale types", {
  library(ggplot2)
  p <- ggplot(mtcars, aes(factor(cyl), mpg)) + geom_col() + coord_flip()
  ir <- as_d3_ir(p)

  # Scale types should be unchanged by coord_flip
  expect_equal(ir$scales$x$type, "categorical")
  expect_equal(ir$scales$y$type, "continuous")
})

test_that("coord_fixed preserves scale domains", {
  library(ggplot2)
  p <- ggplot(mtcars, aes(wt, mpg)) + geom_point() + coord_fixed(ratio = 1)
  ir <- as_d3_ir(p)

  # Domains should still cover the data range
  expect_true(ir$scales$x$domain[1] <= min(mtcars$wt))
  expect_true(ir$scales$x$domain[2] >= max(mtcars$wt))
  expect_true(ir$scales$y$domain[1] <= min(mtcars$mpg))
  expect_true(ir$scales$y$domain[2] >= max(mtcars$mpg))
})
```

Run `devtools::test()` to confirm all tests pass.
  </action>
  <verify>`devtools::test()` — all tests pass, including new coord tests. No test failures.</verify>
  <done>Unit tests for coord_flip IR, coord_fixed IR, axis label swapping, default cartesian, and scale preservation all pass.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete coordinate system support: coord_flip axis positioning fix and coord_fixed aspect ratio constraints. Both features are implemented in the R extraction layer and D3 rendering pipeline.
  </what-built>
  <how-to-verify>
Generate the following test plots in R and compare ggplot2 output with gg2d3 output:

```r
devtools::load_all()
library(ggplot2)

# --- coord_flip tests ---

# 1. Horizontal bar chart (most common coord_flip use case)
p1 <- ggplot(mtcars, aes(factor(cyl), fill = factor(cyl))) +
  geom_bar() +
  coord_flip() +
  labs(x = "Cylinders", y = "Count", title = "Flipped Bar Chart")
ggsave("ggplot_flip_bar.png", p1, width = 6, height = 4)
htmlwidgets::saveWidget(gg2d3(p1), "d3_flip_bar.html")

# 2. Flipped scatter plot
p2 <- ggplot(mtcars, aes(wt, mpg, color = factor(cyl))) +
  geom_point(size = 3) +
  coord_flip() +
  labs(x = "Weight", y = "MPG", title = "Flipped Scatter")
ggsave("ggplot_flip_scatter.png", p2, width = 6, height = 4)
htmlwidgets::saveWidget(gg2d3(p2), "d3_flip_scatter.html")

# 3. Flipped line chart
p3 <- ggplot(economics[1:50,], aes(date, unemploy)) +
  geom_line() +
  coord_flip() +
  labs(title = "Flipped Line")
ggsave("ggplot_flip_line.png", p3, width = 6, height = 4)
htmlwidgets::saveWidget(gg2d3(p3), "d3_flip_line.html")

# --- coord_fixed tests ---

# 4. Square panel (ratio=1)
p4 <- ggplot(mtcars, aes(wt, mpg)) +
  geom_point() +
  coord_fixed(ratio = 1) +
  labs(title = "coord_fixed(ratio=1)")
ggsave("ggplot_fixed_1.png", p4, width = 6, height = 4)
htmlwidgets::saveWidget(gg2d3(p4), "d3_fixed_1.html")

# 5. Tall panel (ratio=2)
p5 <- ggplot(mtcars, aes(wt, mpg)) +
  geom_point() +
  coord_fixed(ratio = 2) +
  labs(title = "coord_fixed(ratio=2)")
ggsave("ggplot_fixed_2.png", p5, width = 6, height = 4)
htmlwidgets::saveWidget(gg2d3(p5), "d3_fixed_2.html")

# --- Regression test ---

# 6. Normal plot (no coord) should be unchanged
p6 <- ggplot(mtcars, aes(wt, mpg)) +
  geom_point() +
  labs(x = "Weight", y = "MPG", title = "Normal (no coord)")
ggsave("ggplot_normal.png", p6, width = 6, height = 4)
htmlwidgets::saveWidget(gg2d3(p6), "d3_normal.html")
```

**Verify each pair (ggplot PNG vs D3 HTML):**

1. **Flipped bar chart**: Bars extend horizontally. "Cylinders" label on left, "Count" on bottom. Category ticks (4,6,8) on left axis. Numeric ticks on bottom axis. Grid lines aligned.

2. **Flipped scatter**: Points positioned correctly. "Weight" on left, "MPG" on bottom. Axis ticks match ggplot2 positions.

3. **Flipped line**: Line path follows data correctly in flipped orientation.

4. **coord_fixed ratio=1**: Panel is roughly square (not stretched to fill).

5. **coord_fixed ratio=2**: Panel is noticeably taller than wide.

6. **Normal plot**: Unchanged from before — no regression.
  </how-to-verify>
  <resume-signal>Type "approved" if all 6 comparisons match, or describe any issues.</resume-signal>
</task>

</tasks>

<verification>
1. `devtools::test()` passes all tests (existing + new coord tests)
2. coord_flip bar chart shows horizontal bars with correct axis placement
3. coord_flip scatter shows correct point positions with swapped axes
4. coord_fixed maintains aspect ratio constraints visually
5. Normal plots render identically to before (no regression)
6. User approves visual checkpoint
</verification>

<success_criteria>
All coordinate system unit tests pass, visual comparisons approved by user, and no regressions in existing functionality.
</success_criteria>

<output>
After completion, create `.planning/phases/03-coordinate-systems/03-03-SUMMARY.md`
</output>
