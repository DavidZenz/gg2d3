---
phase: 07-legend-system
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - inst/htmlwidgets/modules/legend.js
  - inst/htmlwidgets/gg2d3.yaml
autonomous: true

must_haves:
  truths:
    - "Discrete legends render color swatches, size circles, or shape symbols with correct labels"
    - "Colorbar renders smooth SVG gradient with tick marks and labels at break points"
    - "Legend title renders above keys with correct theme styling"
    - "Legend dimensions can be estimated before rendering for layout engine"
    - "All legend text and key sizes derived from theme (no hardcoded pixel values)"
  artifacts:
    - path: "inst/htmlwidgets/modules/legend.js"
      provides: "D3 legend rendering functions"
      exports: ["renderDiscreteLegend", "renderColorbar", "estimateLegendDimensions"]
    - path: "inst/htmlwidgets/gg2d3.yaml"
      provides: "Module load order including legend.js"
      contains: "legend.js"
  key_links:
    - from: "inst/htmlwidgets/modules/legend.js"
      to: "window.gg2d3.constants"
      via: "ptToPx unit conversion"
      pattern: "window\\.gg2d3\\.constants"
    - from: "inst/htmlwidgets/modules/legend.js"
      to: "window.gg2d3.layout"
      via: "text estimation functions"
      pattern: "estimateTextWidth|estimateTextHeight"
    - from: "inst/htmlwidgets/modules/legend.js"
      to: "window.gg2d3.scales"
      via: "convertColor for R color names"
      pattern: "convertColor"
---

<objective>
Create the D3 legend rendering module with discrete legend and colorbar renderers.

Purpose: This module takes guide IR specifications (from Plan 07-01) and renders them as SVG groups. It also provides dimension estimation so the layout engine can reserve correct space before rendering.

Output: New `legend.js` module exporting `renderDiscreteLegend()`, `renderColorbar()`, `estimateLegendDimensions()`, and `renderLegends()` (orchestrator function).
</objective>

<execution_context>
@/Users/davidzenz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davidzenz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-legend-system/07-RESEARCH.md
@inst/htmlwidgets/modules/layout.js
@inst/htmlwidgets/modules/constants.js
@inst/htmlwidgets/modules/scales.js
@inst/htmlwidgets/modules/theme.js
@inst/htmlwidgets/gg2d3.yaml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create legend.js module with discrete and colorbar renderers</name>
  <files>inst/htmlwidgets/modules/legend.js</files>
  <action>
Create `inst/htmlwidgets/modules/legend.js` following the established module pattern (IIFE with `window.gg2d3.legend` namespace export).

**Module structure:**

```
legend.js
  - getThemeDefaults(theme)          // Extract legend-specific theme values
  - estimateLegendDimensions(guides, theme)  // Pre-render size estimation
  - renderDiscreteLegend(svg, guide, box, theme)  // guide_legend rendering
  - renderColorbar(svg, guide, box, theme)        // guide_colorbar rendering
  - renderLegends(svg, guides, layout, theme)     // Orchestrator
```

**1. getThemeDefaults(theme) -- helper function (not exported)**

Extract all legend-related theme values into a single object:
- `keySize`: from `theme.get("legend.key")` -- ggplot2 default is 1.2 lines = 1.2 * 11pt = 13.2pt. Convert using `ptToPx()`.
- `textSize`: from `theme.get("legend.text")` -- ggplot2 default 8.8pt (rel(0.8) * base_size).
- `titleSize`: from `theme.get("legend.title")` -- ggplot2 default 11pt (base_size).
- `titleColour`: from legend.title theme element colour, default "black".
- `textColour`: from legend.text theme element colour, default "black".
- `keySpacing`: 5.5pt (ggplot2 default legend.key.spacing). Convert to px.
- `titleSpacing`: 5.5pt spacing between title and keys.
- `keyBackground`: from `theme.get("legend.key")` fill, default "#FFFFFF" (white in ggplot2 default).
- `legendBackground`: from `theme.get("legend.background")`, for outer border/fill.
- `margin`: from legend.margin, default 5.5pt all sides.

Use `window.gg2d3.constants.ptToPx` for all conversions. Use `window.gg2d3.scales.convertColor` for R color names.

**2. estimateLegendDimensions(guides, theme) -- exported**

Estimates total legend dimensions for ALL guides (summed). This is called before rendering to provide the layout engine with legend width/height.

Use `window.gg2d3.layout.estimateTextWidth` and `estimateTextHeight` for text measurement.

For each guide:
- If type === "legend" (discrete):
  - Width = keySize + keySpacing + maxLabelWidth + margin*2
  - Height = (title ? titleHeight + titleSpacing : 0) + (nKeys * (keySize + keySpacing)) + margin*2
  - maxLabelWidth = max of estimateTextWidth(label, textSize) for all keys
- If type === "colorbar":
  - barWidth = keySize (use keySize as bar width, matching ggplot2)
  - barHeight = 5 * keySize (ggplot2 default nbin=20 but visual height is ~5x key size)
  - Width = barWidth + 3 + maxLabelWidth + margin*2 (bar + tick + label + margins)
  - Height = (title ? titleHeight + titleSpacing : 0) + barHeight + margin*2

For multiple guides:
- When position is "right" or "left": width = max of all guide widths, height = sum of all guide heights + spacing between guides (11pt)
- When position is "top" or "bottom": width = sum of all guide widths + spacing, height = max of all guide heights

Return `{ width, height }` in pixels.

**3. renderDiscreteLegend(svg, guide, x, y, theme) -- exported**

Renders a single discrete legend at position (x, y).

Steps:
1. Create `g` group with class "gg2d3-legend" and translate to (x, y)
2. Get theme defaults via `getThemeDefaults(theme)`
3. Optionally draw legend background (if legend.background is not blank)
4. Draw title text if `guide.title` exists:
   - Font size = titleSize, font weight bold, fill = titleColour
   - Position at (margin, margin + titleSize * 0.8) within group
5. For each key in `guide.keys`, draw:
   - **Color/fill swatch** (if guide has colour or fill aesthetic):
     - `rect` with width=keySize, height=keySize, filled with `key.colour || key.fill`
     - Use `convertColor()` on the fill value
     - Stroke from legend.key.colour theme or "grey80" (ggplot2 default)
   - **Size circle** (if guide has size aesthetic):
     - `circle` at center of key box, radius from `key.size` converted via `sizeToRadius()` from constants
     - Fill = "black" (default data point color)
   - **Shape symbol** (if guide has shape aesthetic):
     - Use D3 `d3.symbol()` with shape type mapped from ggplot2 shape code
     - Map ggplot2 shape codes: 0=square, 1=circle, 2=triangle, 3=plus, 4=cross, 5=diamond, 15=filled square, 16=filled circle, 17=filled triangle, 18=filled diamond, 19=filled circle (default)
     - Position at center of key box
   - **Label text**:
     - Position at keySize + keySpacing horizontally, vertically centered with key
     - Font size = textSize, fill = textColour
     - Text content = `key.label` (converted to string)
   - Each key row spaced by keySize + keySpacing vertically

For **merged guides** (guide.aesthetics has multiple entries): draw the key symbol that combines all aesthetics. For example, if guide has both colour and shape:
- Draw shape symbol using `key.shape` filled with `key.colour`

Return the SVG group element.

**4. renderColorbar(svg, guide, x, y, theme) -- exported**

Renders a continuous colorbar legend at position (x, y).

Steps:
1. Create `g` group with class "gg2d3-colorbar" and translate to (x, y)
2. Get theme defaults
3. Draw title if present
4. Create SVG `linearGradient` in `defs`:
   - Generate unique gradient ID: `legend-grad-${Math.random().toString(36).substr(2,9)}`
   - Direction: vertical, y1="100%" to y2="0%" (bottom to top, matching ggplot2 colorbar direction)
   - Add color stops from `guide.colors` array (evenly spaced)
   - If `guide.colors` is not available, fall back to creating stops from `guide.keys` color values
5. Draw gradient rectangle:
   - Width = keySize, height = barHeight (5 * keySize)
   - Fill = `url(#gradientId)`
   - Stroke from legend.frame or "grey50" thin border
6. Draw tick marks and labels for each key (these are the labeled break points):
   - Calculate y position proportionally within bar height based on key value position in domain
   - Draw small horizontal tick mark at right edge of bar
   - Draw label text to the right of tick mark
7. Return the SVG group.

**5. renderLegends(svg, guides, layout, theme) -- exported (orchestrator)**

Called from `gg2d3.js` to render all legends.

Steps:
1. If no guides or guides is empty, return immediately
2. Get layout legend box: `layout.legend` has `{x, y, w, h, position}`
3. If position === "none", return
4. Calculate starting position within legend box (with margin)
5. For each guide:
   - If guide.type === "legend": call `renderDiscreteLegend(svg, guide, currentX, currentY, theme)`
   - If guide.type === "colorbar": call `renderColorbar(svg, guide, currentX, currentY, theme)`
   - Advance position (vertically for right/left legends, horizontally for top/bottom)

**6. Namespace export:**
```javascript
window.gg2d3.legend = {
  estimateLegendDimensions: estimateLegendDimensions,
  renderDiscreteLegend: renderDiscreteLegend,
  renderColorbar: renderColorbar,
  renderLegends: renderLegends
};
```

**Shape mapping helper (internal):**
Create a helper to map ggplot2 shape codes to D3 symbol types:
```javascript
function getD3Symbol(shapeCode) {
  const shapeMap = {
    0: d3.symbolSquare,      // open square
    1: d3.symbolCircle,      // open circle
    2: d3.symbolTriangle,    // open triangle
    3: d3.symbolCross,       // plus
    4: d3.symbolTimes,       // cross (X) - note: D3 v7 may not have symbolTimes, use symbolCross rotated
    5: d3.symbolDiamond,     // open diamond
    15: d3.symbolSquare,     // filled square
    16: d3.symbolCircle,     // filled circle (default)
    17: d3.symbolTriangle,   // filled triangle
    18: d3.symbolDiamond,    // filled diamond
    19: d3.symbolCircle      // solid circle
  };
  return shapeMap[shapeCode] || d3.symbolCircle;
}
```

Note: D3 v7 has `d3.symbolCircle`, `d3.symbolCross`, `d3.symbolDiamond`, `d3.symbolSquare`, `d3.symbolStar`, `d3.symbolTriangle`, `d3.symbolWye`. For ggplot2 shapes 0-2, 5 (open shapes), draw with stroke only (no fill). For 15-19 (filled shapes), draw with fill and no stroke.
  </action>
  <verify>
Verify module structure:
```bash
# File exists
test -f inst/htmlwidgets/modules/legend.js && echo "FOUND: legend.js"

# Module exports
grep -c "window.gg2d3.legend" inst/htmlwidgets/modules/legend.js

# Key functions present
grep -c "estimateLegendDimensions" inst/htmlwidgets/modules/legend.js
grep -c "renderDiscreteLegend" inst/htmlwidgets/modules/legend.js
grep -c "renderColorbar" inst/htmlwidgets/modules/legend.js
grep -c "renderLegends" inst/htmlwidgets/modules/legend.js

# Uses constants module (not hardcoded values)
grep -c "ptToPx" inst/htmlwidgets/modules/legend.js

# Uses layout text estimation
grep -c "estimateTextWidth\|estimateTextHeight" inst/htmlwidgets/modules/legend.js

# Uses convertColor
grep -c "convertColor" inst/htmlwidgets/modules/legend.js
```

All counts should be >= 1.
  </verify>
  <done>
legend.js module exists with renderDiscreteLegend (color swatches, size circles, shape symbols with labels), renderColorbar (SVG gradient with ticks), estimateLegendDimensions (pre-render sizing), and renderLegends (orchestrator). All sizes from theme, all colors through convertColor.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add legend.js to YAML module load order</name>
  <files>inst/htmlwidgets/gg2d3.yaml</files>
  <action>
Add `legend.js` to the gg2d3-modules dependency script list in `inst/htmlwidgets/gg2d3.yaml`.

Insert `legend.js` after `layout.js` and before `geom-registry.js` in the script array. Legend module depends on constants, scales, theme, and layout (for text estimation), so it must load after all of those but before geom-registry (which doesn't need legend).

Updated script section should be:
```yaml
    script:
      - constants.js
      - scales.js
      - theme.js
      - layout.js
      - legend.js        # <-- NEW
      - geom-registry.js
      - geoms/point.js
      ... (rest unchanged)
```
  </action>
  <verify>
```bash
grep "legend.js" inst/htmlwidgets/gg2d3.yaml && echo "legend.js in YAML"

# Verify load order: legend.js after layout.js
grep -n "layout.js\|legend.js\|geom-registry.js" inst/htmlwidgets/gg2d3.yaml
```
legend.js should appear between layout.js and geom-registry.js.
  </verify>
  <done>
legend.js registered in YAML module load order after layout.js and before geom-registry.js. Module will be loaded by HTMLWidgets in correct dependency order.
  </done>
</task>

</tasks>

<verification>
1. `legend.js` file exists with all 4 exported functions
2. legend.js uses `window.gg2d3.constants.ptToPx` for unit conversion (no hardcoded px values)
3. legend.js uses `window.gg2d3.layout.estimateTextWidth` for text sizing
4. legend.js uses `window.gg2d3.scales.convertColor` for R color names
5. YAML loads legend.js in correct position (after layout, before geom-registry)
6. `estimateLegendDimensions()` returns `{width, height}` object
</verification>

<success_criteria>
- Discrete legend renderer draws color swatches, size circles, or shape symbols with labels
- Colorbar renderer draws smooth SVG gradient with tick marks at break points
- Dimension estimation provides accurate pre-render sizing for layout engine
- All measurements derived from theme (legend.key.size, legend.text, legend.title)
- Module follows established namespace pattern (window.gg2d3.legend)
</success_criteria>

<output>
After completion, create `.planning/phases/07-legend-system/07-02-SUMMARY.md`
</output>
