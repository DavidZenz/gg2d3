---
phase: 09-advanced-faceting
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - inst/htmlwidgets/modules/layout.js
  - inst/htmlwidgets/gg2d3.js
autonomous: true

must_haves:
  truths:
    - "facet_grid plots render a 2D grid of panels with correct data in each"
    - "Column strip labels appear above each column of panels"
    - "Row strip labels appear to the right of each row of panels with rotated text"
    - "X-axes render on bottom row panels, Y-axes render on left column panels (fixed scales)"
    - "Panel spacing matches ggplot2 defaults between all panels"
    - "facet_wrap plots continue to render correctly (backward compatible)"
  artifacts:
    - path: "inst/htmlwidgets/modules/layout.js"
      provides: "calculateLayout for facet_grid with row and column strips"
      contains: "grid"
    - path: "inst/htmlwidgets/gg2d3.js"
      provides: "facet_grid rendering with col strips, row strips, per-row/col axes"
      contains: "row_strips"
  key_links:
    - from: "inst/htmlwidgets/gg2d3.js"
      to: "inst/htmlwidgets/modules/layout.js"
      via: "calculateLayout with facets.type='grid'"
      pattern: "type.*grid"
    - from: "inst/htmlwidgets/gg2d3.js"
      to: "renderPanel"
      via: "Multi-panel loop filtering data by PANEL"
      pattern: "renderPanel"
---

<objective>
Extend the JavaScript layout engine and rendering pipeline to support facet_grid's 2D panel grid with row strips (right side, rotated text) and column strips (top).

Purpose: Render facet_grid plots visually matching ggplot2's default layout: panels arranged in rows x columns, column strips on top, row strips on right, axes on outer edges.

Output: Working facet_grid rendering with correct spatial layout, strip labels, and axis positioning.
</objective>

<execution_context>
@/Users/davidzenz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davidzenz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-advanced-faceting/09-RESEARCH.md
@.planning/phases/09-advanced-faceting/09-01-SUMMARY.md
@.planning/phases/08-basic-faceting/08-02-SUMMARY.md
@.planning/phases/08-basic-faceting/08-03-SUMMARY.md
@inst/htmlwidgets/modules/layout.js
@inst/htmlwidgets/gg2d3.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend calculateLayout for facet_grid</name>
  <files>inst/htmlwidgets/modules/layout.js</files>
  <action>
Extend `calculateLayout()` to handle `facets.type === "grid"` in addition to `"wrap"`.

**Update isFaceted detection** (around line 297):
```javascript
const isFaceted = facets && (facets.type === "wrap" || facets.type === "grid") &&
                  facets.layout && facets.layout.length > 1;
const isFacetGrid = facets && facets.type === "grid";
```

**In the multi-panel grid calculation section** (around line 435), handle facet_grid's 2D strip layout:

For facet_grid:
- Column strips go on TOP of each column (like facet_wrap strips go above each panel)
- Row strips go on the RIGHT side of each row (rotated text)
- `stripHeight` = column strip height (same calculation as facet_wrap: text height + 2 * margin)
- `stripWidth` = row strip width (same as stripHeight for rotated text — rotated text's "width" equals the text height)

Space allocation for facet_grid:
1. Reserve `stripWidth` on the right side of the available panel area for row strips
2. Reserve `stripHeight` per row on top for column strips (one strip row per panel row, BUT for facet_grid, only ONE strip row at the top for column labels, not per-row)

Actually, correction: In facet_grid, column strips appear once at the top per column (not per panel row). Row strips appear once on the right per row. So:
- Total column strip height = 1 * stripHeight (one row of column strips at the top)
- Total row strip width = 1 * stripWidth (one column of row strips on the right)

**Panel layout calculation for facet_grid:**
```
panelAreaW = availW - stripWidth  (reserve right side for row strips)
panelAreaH = availH - stripHeight (reserve top for column strips)

panelW = (panelAreaW - totalSpacingX) / ncol
panelH = (panelAreaH - totalSpacingY) / nrow

For each layout entry:
  panel.x = availX + (COL-1) * (panelW + spacing)
  panel.y = availY + stripHeight + (ROW-1) * (panelH + spacing)
```

**Build colStrips array** (positioned at top of each column):
```javascript
if (isFacetGrid && facets.col_strips) {
  colStripsArr = facets.col_strips.map(function(strip) {
    var col = strip.COL - 1;
    return {
      COL: strip.COL,
      x: availX + col * (panelW + spacing),
      y: availY,
      w: panelW,
      h: stripHeight,
      label: strip.label,
      orientation: "top"
    };
  });
}
```

**Build rowStrips array** (positioned to the right of each row):
```javascript
if (isFacetGrid && facets.row_strips) {
  rowStripsArr = facets.row_strips.map(function(strip) {
    var rowIdx = strip.ROW - 1;
    return {
      ROW: strip.ROW,
      x: availX + panelAreaW,
      y: availY + stripHeight + rowIdx * (panelH + spacing),
      w: stripWidth,
      h: panelH,
      label: strip.label,
      orientation: "right"
    };
  });
}
```

**Add to return object:**
- `colStrips: colStripsArr` (null for non-grid)
- `rowStrips: rowStripsArr` (null for non-grid)

Keep existing `strips` for facet_wrap, add `colStrips`/`rowStrips` for facet_grid.

**Update panel bounding box** for facet_grid (same pattern as facet_wrap — union of all panel positions).

The `isFaceted` check for facet_wrap's existing grid calculation should remain for type="wrap". Add a new `else if (isFacetGrid)` block for the grid-specific calculation.
  </action>
  <verify>
```r
pkgload::load_all()
library(ggplot2)
p <- ggplot(mtcars, aes(wt, mpg)) + geom_point() + facet_grid(cyl ~ am)
gg2d3(p)
# Visual: should see panels in grid, column strips on top, row strips on right
# (Rendering will be partial until Task 2 wires up strip rendering)
```
  </verify>
  <done>calculateLayout returns correct panel positions, colStrips, and rowStrips for facet_grid plots. facet_wrap layout calculation unchanged.</done>
</task>

<task type="auto">
  <name>Task 2: Render facet_grid in gg2d3.js with strips and axes</name>
  <files>inst/htmlwidgets/gg2d3.js</files>
  <action>
Extend draw() in gg2d3.js to handle facet_grid rendering.

**1. Update layoutConfig construction** (around line 187) to pass facet_grid data:

Currently only passes facets for type="wrap". Extend to also pass for type="grid":
```javascript
facets: ir.facets && (ir.facets.type === "wrap" || ir.facets.type === "grid") ? {
  type: ir.facets.type,
  nrow: ir.facets.nrow,
  ncol: ir.facets.ncol,
  layout: ir.facets.layout,
  strips: ir.facets.strips || null,        // facet_wrap
  row_strips: ir.facets.row_strips || null, // facet_grid
  col_strips: ir.facets.col_strips || null, // facet_grid
  scales: ir.facets.scales || "fixed",
  spacing: ir.facets.spacing || 7.3
} : null
```

**2. Update isFaceted detection** (around line 198):
```javascript
const isFaceted = layout.panels && layout.panels.length > 1;
const isFacetGrid = ir.facets && ir.facets.type === "grid";
```

**3. Multi-panel rendering** already works via layout.panels.forEach + renderPanel. No changes needed for the panel rendering loop since renderPanel already handles per-panel data filtering.

**4. Render column strips** (for facet_grid — on top of each column):
After the existing strip rendering for facet_wrap, add facet_grid column strip rendering:
```javascript
if (isFacetGrid && layout.colStrips && layout.colStrips.length > 0) {
  const stripTheme = window.gg2d3.layout.getStripTheme(theme);
  layout.colStrips.forEach(function(strip) {
    const stripGroup = root.append("g").attr("class", "strip strip-col-" + strip.COL);
    // Background rect
    stripGroup.append("rect")
      .attr("x", strip.x).attr("y", strip.y)
      .attr("width", strip.w).attr("height", strip.h)
      .attr("fill", stripTheme.bgFill)
      .attr("stroke", stripTheme.bgColour || "none")
      .attr("stroke-width", stripTheme.bgLinewidth);
    // Label text (horizontal, centered)
    stripGroup.append("text")
      .attr("x", strip.x + strip.w / 2)
      .attr("y", strip.y + strip.h / 2)
      .attr("text-anchor", "middle")
      .attr("dominant-baseline", "central")
      .style("font-size", stripTheme.fontSize + "px")
      .style("fill", stripTheme.fontColour)
      .style("font-weight", stripTheme.fontFace === "bold" ? "bold" : "normal")
      .style("font-family", stripTheme.fontFamily)
      .text(strip.label);
  });
}
```

**5. Render row strips** (for facet_grid — on right of each row, with rotated text):
```javascript
if (isFacetGrid && layout.rowStrips && layout.rowStrips.length > 0) {
  const stripTheme = window.gg2d3.layout.getStripTheme(theme);
  layout.rowStrips.forEach(function(strip) {
    const stripGroup = root.append("g").attr("class", "strip strip-row-" + strip.ROW);
    // Background rect
    stripGroup.append("rect")
      .attr("x", strip.x).attr("y", strip.y)
      .attr("width", strip.w).attr("height", strip.h)
      .attr("fill", stripTheme.bgFill)
      .attr("stroke", stripTheme.bgColour || "none")
      .attr("stroke-width", stripTheme.bgLinewidth);
    // Label text (rotated -90 degrees, centered in strip area)
    var cx = strip.x + strip.w / 2;
    var cy = strip.y + strip.h / 2;
    stripGroup.append("text")
      .attr("x", cx).attr("y", cy)
      .attr("text-anchor", "middle")
      .attr("dominant-baseline", "central")
      .attr("transform", "rotate(-90," + cx + "," + cy + ")")
      .style("font-size", stripTheme.fontSize + "px")
      .style("fill", stripTheme.fontColour)
      .style("font-weight", stripTheme.fontFace === "bold" ? "bold" : "normal")
      .style("font-family", stripTheme.fontFamily)
      .text(strip.label);
  });
}
```

**6. Update axis rendering for facet_grid**:
The existing faceted axis rendering (around line 354) works for both wrap and grid since it uses `ir.facets.layout` to find bottom-row and left-column panels. However, verify it handles grid correctly:
- Bottom row panels: `ROW === maxRow` (works for both wrap and grid)
- Left column panels: `COL === 1` (works for both wrap and grid)
- For fixed scales (Phase 9 plan 02 scope): axes shared, same scales for all panels

No changes should be needed for axis rendering if it already reads from `ir.facets.layout`. Verify this works and fix if needed.

**IMPORTANT:** The existing facet_wrap strip rendering (`layout.strips.forEach`) should only fire for facet_wrap, not facet_grid. Guard with: `if (!isFacetGrid && isFaceted && layout.strips && layout.strips.length > 0)`.
  </action>
  <verify>
```r
pkgload::load_all()
library(ggplot2)

# Basic facet_grid
p1 <- ggplot(mtcars, aes(wt, mpg)) + geom_point() + facet_grid(cyl ~ am)
gg2d3(p1)
# Expected: 3x2 grid, column strips "0"/"1" on top, row strips "4"/"6"/"8" on right

# facet_grid with color
p2 <- ggplot(mtcars, aes(wt, mpg, color = factor(gear))) +
  geom_point() + facet_grid(cyl ~ am)
gg2d3(p2)
# Expected: same grid with colored points

# facet_wrap still works
p3 <- ggplot(mtcars, aes(wt, mpg)) + geom_point() + facet_wrap(~ cyl)
gg2d3(p3)
# Expected: unchanged from Phase 8

# Non-faceted still works
p4 <- ggplot(mtcars, aes(wt, mpg)) + geom_point()
gg2d3(p4)
# Expected: single panel, no strips
```
  </verify>
  <done>facet_grid renders 2D grid with column strips on top (horizontal text), row strips on right (rotated text), axes on outer edges, correct data per panel. facet_wrap and non-faceted rendering unchanged.</done>
</task>

</tasks>

<verification>
1. `pkgload::load_all()` succeeds
2. `gg2d3(ggplot(mtcars, aes(wt, mpg)) + geom_point() + facet_grid(cyl ~ am))` renders 3x2 grid
3. Column strips appear above panels with "0" and "1" labels
4. Row strips appear right of panels with "4", "6", "8" labels (rotated text)
5. X-axes on bottom row only, Y-axes on left column only
6. facet_wrap rendering unchanged
7. Non-faceted rendering unchanged
</verification>

<success_criteria>
- facet_grid(cyl ~ am) renders correctly as 3-row x 2-column grid
- Column strips positioned above panels with horizontal text
- Row strips positioned right of panels with -90 degree rotated text
- Panel spacing matches ggplot2 defaults
- Data correctly partitioned by PANEL into each panel
</success_criteria>

<output>
After completion, create `.planning/phases/09-advanced-faceting/09-02-SUMMARY.md`
</output>
