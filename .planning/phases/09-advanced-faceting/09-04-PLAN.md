---
phase: 09-advanced-faceting
plan: 04
type: execute
wave: 4
depends_on: ["09-03"]
files_modified:
  - tests/testthat/test-facet-grid.R
autonomous: false

must_haves:
  truths:
    - "Unit tests verify facet_grid IR extraction for basic, free, multi-variable cases"
    - "Unit tests verify backward compatibility with facet_wrap and non-faceted"
    - "Visual verification confirms facet_grid rendering matches ggplot2"
    - "Visual verification confirms free scales render per-panel axes correctly"
    - "Missing row x col combinations render as blank panels"
  artifacts:
    - path: "tests/testthat/test-facet-grid.R"
      provides: "Comprehensive unit tests for facet_grid IR and rendering"
      contains: "test_that"
  key_links:
    - from: "tests/testthat/test-facet-grid.R"
      to: "R/as_d3_ir.R"
      via: "Tests call as_d3_ir() on facet_grid plots"
      pattern: "as_d3_ir"
---

<objective>
Comprehensive testing and visual verification for all Phase 9 features: facet_grid with fixed and free scales, multi-variable faceting, missing combinations, and backward compatibility.

Purpose: Validate that facet_grid implementation matches ggplot2 output and catch edge cases before shipping.

Output: Test file with 10+ test cases covering facet_grid IR structure, free scales, multi-variable strips, backward compatibility.
</objective>

<execution_context>
@/Users/davidzenz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davidzenz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-advanced-faceting/09-01-SUMMARY.md
@.planning/phases/09-advanced-faceting/09-02-SUMMARY.md
@.planning/phases/09-advanced-faceting/09-03-SUMMARY.md
@tests/testthat/test-facet-grid.R
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write comprehensive facet_grid unit tests</name>
  <files>tests/testthat/test-facet-grid.R</files>
  <action>
Create `tests/testthat/test-facet-grid.R` with the following test cases using testthat:

**1. facet_grid basic structure:**
```r
test_that("facet_grid produces correct IR structure", {
  p <- ggplot(mtcars, aes(wt, mpg)) + geom_point() + facet_grid(cyl ~ am)
  ir <- as_d3_ir(p)
  expect_equal(ir$facets$type, "grid")
  expect_equal(ir$facets$rows, "cyl")
  expect_equal(ir$facets$cols, "am")
  expect_equal(ir$facets$nrow, 3L)
  expect_equal(ir$facets$ncol, 2L)
  expect_equal(ir$facets$scales, "fixed")
  expect_equal(length(ir$facets$layout), 6)  # 3 rows x 2 cols
  expect_equal(length(ir$panels), 6)
})
```

**2. Row and column strip labels:**
```r
test_that("facet_grid row_strips and col_strips are correct", {
  p <- ggplot(mtcars, aes(wt, mpg)) + geom_point() + facet_grid(cyl ~ am)
  ir <- as_d3_ir(p)
  expect_equal(length(ir$facets$row_strips), 3)  # 3 cyl values
  expect_equal(length(ir$facets$col_strips), 2)  # 2 am values
  # Check ROW/COL indices
  row_indices <- sapply(ir$facets$row_strips, function(s) s$ROW)
  col_indices <- sapply(ir$facets$col_strips, function(s) s$COL)
  expect_equal(sort(row_indices), 1:3)
  expect_equal(sort(col_indices), 1:2)
})
```

**3. Layout entries with SCALE_X/SCALE_Y:**
```r
test_that("facet_grid layout includes SCALE_X and SCALE_Y", {
  p <- ggplot(mtcars, aes(wt, mpg)) + geom_point() + facet_grid(cyl ~ am)
  ir <- as_d3_ir(p)
  layout <- ir$facets$layout
  for (entry in layout) {
    expect_true("SCALE_X" %in% names(entry))
    expect_true("SCALE_Y" %in% names(entry))
    expect_true(is.integer(entry$SCALE_X))
    expect_true(is.integer(entry$SCALE_Y))
  }
})
```

**4. Free scales mode detection:**
```r
test_that("facet_grid detects free scale modes correctly", {
  p_free <- ggplot(mtcars, aes(wt, mpg)) + geom_point() + facet_grid(cyl ~ am, scales = "free")
  ir_free <- as_d3_ir(p_free)
  expect_equal(ir_free$facets$scales, "free")

  p_fx <- ggplot(mtcars, aes(wt, mpg)) + geom_point() + facet_grid(cyl ~ am, scales = "free_x")
  ir_fx <- as_d3_ir(p_fx)
  expect_equal(ir_fx$facets$scales, "free_x")

  p_fy <- ggplot(mtcars, aes(wt, mpg)) + geom_point() + facet_grid(cyl ~ am, scales = "free_y")
  ir_fy <- as_d3_ir(p_fy)
  expect_equal(ir_fy$facets$scales, "free_y")

  p_fixed <- ggplot(mtcars, aes(wt, mpg)) + geom_point() + facet_grid(cyl ~ am)
  ir_fixed <- as_d3_ir(p_fixed)
  expect_equal(ir_fixed$facets$scales, "fixed")
})
```

**5. Per-panel ranges vary with free scales:**
```r
test_that("free scales produce per-panel specific ranges", {
  p <- ggplot(mtcars, aes(wt, mpg)) + geom_point() + facet_grid(cyl ~ am, scales = "free")
  ir <- as_d3_ir(p)
  # With free scales, at least some panels should have different ranges
  x_ranges <- lapply(ir$panels, function(pan) pan$x_range)
  y_ranges <- lapply(ir$panels, function(pan) pan$y_range)
  # Not all x_ranges should be identical
  expect_false(all(sapply(x_ranges, function(r) identical(r, x_ranges[[1]]))))
})
```

**6. Multi-variable faceting:**
```r
test_that("multi-variable facet_grid produces correct strips", {
  p <- ggplot(mtcars, aes(wt, mpg)) + geom_point() + facet_grid(cyl ~ am + vs)
  ir <- as_d3_ir(p)
  expect_equal(ir$facets$type, "grid")
  expect_equal(length(ir$facets$cols), 2)  # am and vs
  expect_equal(length(ir$facets$rows), 1)  # cyl only
  # Column strips should have concatenated labels
  col_labels <- sapply(ir$facets$col_strips, function(s) s$label)
  expect_true(all(grepl(",", col_labels)))  # Labels contain comma separator
})
```

**7. Missing combinations produce blank panels:**
```r
test_that("facet_grid handles missing combinations", {
  # Create dataset with missing combination
  df <- data.frame(
    x = c(1, 2, 3, 4),
    y = c(1, 2, 3, 4),
    row_var = c("A", "A", "B", "B"),
    col_var = c("X", "Y", "X", "X")  # B,Y combination is missing
  )
  p <- ggplot(df, aes(x, y)) + geom_point() + facet_grid(row_var ~ col_var)
  ir <- as_d3_ir(p)
  # Should still have 4 panels (2x2 grid)
  expect_equal(length(ir$panels), 4)
  expect_equal(ir$facets$nrow, 2L)
  expect_equal(ir$facets$ncol, 2L)
})
```

**8. Backward compatibility with facet_wrap:**
```r
test_that("facet_wrap IR unchanged by Phase 9", {
  p <- ggplot(mtcars, aes(wt, mpg)) + geom_point() + facet_wrap(~ cyl)
  ir <- as_d3_ir(p)
  expect_equal(ir$facets$type, "wrap")
  expect_true(!is.null(ir$facets$strips))
  expect_true(is.null(ir$facets$row_strips))
  expect_true(is.null(ir$facets$col_strips))
})
```

**9. Non-faceted backward compatibility:**
```r
test_that("non-faceted IR unchanged by Phase 9", {
  p <- ggplot(mtcars, aes(wt, mpg)) + geom_point()
  ir <- as_d3_ir(p)
  expect_equal(ir$facets$type, "null")
  expect_equal(length(ir$panels), 1)
})
```

**10. Panel data has integer PANEL column:**
```r
test_that("facet_grid layer data has integer PANEL", {
  p <- ggplot(mtcars, aes(wt, mpg)) + geom_point() + facet_grid(cyl ~ am)
  ir <- as_d3_ir(p)
  panels <- unique(sapply(ir$layers[[1]]$data, function(d) d$PANEL))
  expect_true(all(is.integer(panels) | is.numeric(panels)))
})
```

**11. Per-panel breaks exist:**
```r
test_that("facet_grid panels have breaks", {
  p <- ggplot(mtcars, aes(wt, mpg)) + geom_point() + facet_grid(cyl ~ am)
  ir <- as_d3_ir(p)
  for (panel in ir$panels) {
    expect_true(length(panel$x_breaks) > 0)
    expect_true(length(panel$y_breaks) > 0)
  }
})
```

Run tests with `testthat::test_file("tests/testthat/test-facet-grid.R")`.
  </action>
  <verify>
```r
pkgload::load_all()
testthat::test_file("tests/testthat/test-facet-grid.R")
# All tests should pass
```
  </verify>
  <done>All unit tests pass covering facet_grid structure, strips, SCALE_X/SCALE_Y, free scales, multi-variable facets, missing combinations, and backward compatibility.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Visual verification of facet_grid rendering</name>
  <files>test_output</files>
  <action>
Generate 7 test plots to visually verify facet_grid rendering. Save each as HTML and present to user for verification.

```r
pkgload::load_all()
library(ggplot2)

# 1. Basic facet_grid (fixed scales)
p1 <- ggplot(mtcars, aes(wt, mpg)) + geom_point() + facet_grid(cyl ~ am)
htmlwidgets::saveWidget(gg2d3(p1), "/tmp/facet_grid_1_basic.html")

# 2. facet_grid with free scales
p2 <- ggplot(mtcars, aes(wt, mpg)) + geom_point() + facet_grid(cyl ~ am, scales = "free")
htmlwidgets::saveWidget(gg2d3(p2), "/tmp/facet_grid_2_free.html")

# 3. facet_grid free_x
p3 <- ggplot(mtcars, aes(wt, mpg)) + geom_point() + facet_grid(cyl ~ am, scales = "free_x")
htmlwidgets::saveWidget(gg2d3(p3), "/tmp/facet_grid_3_free_x.html")

# 4. facet_grid with bars (categorical x)
p4 <- ggplot(mtcars, aes(factor(gear))) + geom_bar() + facet_grid(cyl ~ am)
htmlwidgets::saveWidget(gg2d3(p4), "/tmp/facet_grid_4_bars.html")

# 5. Multi-variable faceting
p5 <- ggplot(mtcars, aes(wt, mpg)) + geom_point() + facet_grid(cyl ~ am + vs)
htmlwidgets::saveWidget(gg2d3(p5), "/tmp/facet_grid_5_multivar.html")

# 6. Missing combinations
df <- data.frame(x = 1:4, y = 1:4,
                 r = c("A","A","B","B"), c = c("X","Y","X","X"))
p6 <- ggplot(df, aes(x, y)) + geom_point() + facet_grid(r ~ c)
htmlwidgets::saveWidget(gg2d3(p6), "/tmp/facet_grid_6_missing.html")

# 7. facet_wrap backward compatibility
p7 <- ggplot(mtcars, aes(wt, mpg)) + geom_point() + facet_wrap(~ cyl)
htmlwidgets::saveWidget(gg2d3(p7), "/tmp/facet_grid_7_wrap_compat.html")
```

Present each HTML to user for visual comparison with ggplot2 reference.
  </action>
  <verify>
User confirms visual output matches ggplot2 for all 7 test cases:
1. 3x2 grid, col strips "0"/"1" on top, row strips "4"/"6"/"8" on right
2. Per-panel axes with different ranges
3. X-axes on every panel, y-axes on left column only
4. Bars render correctly per panel
5. Multi-variable column strips with concatenated labels
6. Missing combo panel blank, grid stays rectangular
7. facet_wrap unchanged from Phase 8
  </verify>
  <done>
User approves visual rendering of facet_grid plots. All 7 test cases pass visual inspection. Backward compatibility confirmed.
  </done>
</task>

</tasks>

<verification>
1. All unit tests pass: `testthat::test_file("tests/testthat/test-facet-grid.R")`
2. Visual verification by user confirms rendering matches ggplot2
3. No regressions in existing facet_wrap or non-faceted plots
</verification>

<success_criteria>
- 11+ unit tests pass covering all facet_grid features
- Visual output matches ggplot2 for basic grid, free scales, multi-variable, missing combos
- User approves visual verification checkpoint
</success_criteria>

<output>
After completion, create `.planning/phases/09-advanced-faceting/09-04-SUMMARY.md`
</output>
