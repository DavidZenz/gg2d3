---
phase: 09-advanced-faceting
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - R/as_d3_ir.R
  - R/validate_ir.R
autonomous: true

must_haves:
  truths:
    - "facet_grid(cyl ~ am) produces IR with type='grid', rows=['cyl'], cols=['am']"
    - "facet_grid IR includes row_strips and col_strips arrays with correct labels"
    - "facet_grid IR panels contain per-panel x_range, y_range, x_breaks, y_breaks"
    - "facet_grid IR layout entries include SCALE_X/SCALE_Y indices"
    - "facet_grid with scales='free' extracts panel-specific ranges from panel_params"
    - "Multi-variable facet_grid(a + b ~ c) concatenates strip labels correctly"
    - "Missing row x col combinations still appear in layout (blank panels)"
    - "facet_wrap plots continue to work unchanged (backward compatible)"
  artifacts:
    - path: "R/as_d3_ir.R"
      provides: "facet_grid IR extraction with row/col vars, strips, scales mode"
      contains: "FacetGrid"
    - path: "R/validate_ir.R"
      provides: "Validation for facet_grid IR structure"
      contains: "grid"
  key_links:
    - from: "R/as_d3_ir.R"
      to: "IR JSON output"
      via: "facets_ir with type='grid', rows, cols, scales, row_strips, col_strips"
      pattern: "type.*grid"
---

<objective>
Extract facet_grid metadata from ggplot_build() into the IR, extending the Phase 8 facet_wrap extraction to support 2D row x column grids with free scale metadata.

Purpose: Provide the JavaScript rendering layer with all data needed to render facet_grid plots: grid dimensions, row/column strip labels, per-panel scale ranges (for free scales), and the scales mode (fixed/free/free_x/free_y).

Output: Extended as_d3_ir() and validate_ir() supporting facet_grid plots with all scale modes.
</objective>

<execution_context>
@/Users/davidzenz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davidzenz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-advanced-faceting/09-RESEARCH.md
@.planning/phases/08-basic-faceting/08-01-SUMMARY.md
@R/as_d3_ir.R
@R/validate_ir.R
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract facet_grid metadata into IR</name>
  <files>R/as_d3_ir.R</files>
  <action>
In the facet extraction section of as_d3_ir() (around line 766), add a new branch for FacetGrid alongside the existing FacetWrap branch. Detect with `inherits(b$layout$facet, "FacetGrid")`.

Extract the following into facets_ir:
- `type = "grid"`
- `rows = names(b$layout$facet$params$rows)` (character vector of row facet variables)
- `cols = names(b$layout$facet$params$cols)` (character vector of col facet variables)
- `scales` field: Derive from `b$layout$facet$params$free`. This is a list with `$x` and `$y` booleans. Map to: both FALSE = "fixed", x TRUE only = "free_x", y TRUE only = "free_y", both TRUE = "free".
- `nrow = max(layout_df$ROW)`, `ncol = max(layout_df$COL)`
- `spacing` = panel.spacing in pixels (reuse existing extraction pattern from facet_wrap)
- `layout` array: Same as facet_wrap but from facet_grid's layout_df. Each entry: PANEL, ROW, COL, SCALE_X, SCALE_Y, plus faceting variable values as character.

Build `row_strips` array: For each unique ROW in layout_df, extract the row facet variable values. Concatenate multiple variables with ", " separator. Structure: `[{ROW: 1, label: "4"}, {ROW: 2, label: "6"}, ...]`

Build `col_strips` array: For each unique COL in layout_df, extract the col facet variable values. Concatenate multiple variables with ", " separator. Structure: `[{COL: 1, label: "0"}, {COL: 2, label: "1"}, ...]`

For panels_ir, reuse the existing pattern from facet_wrap: iterate over `b$layout$panel_params` and extract per-panel x_range, y_range, x_breaks, y_breaks. Apply coord_flip un-swap logic (same as facet_wrap). For free scales, each panel will have different ranges; for fixed scales, they'll be identical but the structure supports both.

IMPORTANT: Do NOT use `facets_ir$strips` for facet_grid (that's the facet_wrap pattern). Instead use `facets_ir$row_strips` and `facets_ir$col_strips`.

IMPORTANT: Missing row x col combinations are automatically handled by ggplot2 â€” `b$layout$layout` includes all combinations in the rectangular grid even if some have no data. The data filtering by PANEL in JS (Phase 8) already handles empty panels gracefully.

The facet_grid branch should be `else if (inherits(b$layout$facet, "FacetGrid"))` after the `if (is_facet_wrap)` check, before the `else` (non-faceted) fallback.

Also add facet_grid support to the `facet_wrap` case for `scales = "free"` on facet_wrap. Currently facet_wrap extraction doesn't capture the scales mode. Add `scales = "fixed"` to the existing facet_wrap IR (facet_wrap supports free scales too, though Phase 8 only handled fixed). Check `b$layout$facet$params$free` for facet_wrap as well.
  </action>
  <verify>
```r
pkgload::load_all()
library(ggplot2)

# Test facet_grid basic
p <- ggplot(mtcars, aes(wt, mpg)) + geom_point() + facet_grid(cyl ~ am)
ir <- as_d3_ir(p)
stopifnot(ir$facets$type == "grid")
stopifnot(identical(ir$facets$rows, "cyl"))
stopifnot(identical(ir$facets$cols, "am"))
stopifnot(ir$facets$scales == "fixed")
stopifnot(ir$facets$nrow == 3)
stopifnot(ir$facets$ncol == 2)
stopifnot(length(ir$facets$row_strips) == 3)
stopifnot(length(ir$facets$col_strips) == 2)
stopifnot(length(ir$panels) == 6)
cat("facet_grid basic: PASS\n")

# Test free scales
p2 <- ggplot(mtcars, aes(wt, mpg)) + geom_point() + facet_grid(cyl ~ am, scales = "free")
ir2 <- as_d3_ir(p2)
stopifnot(ir2$facets$scales == "free")
# Panels should have different ranges
cat("facet_grid free: PASS\n")

# Test multi-variable
p3 <- ggplot(mtcars, aes(wt, mpg)) + geom_point() + facet_grid(cyl ~ am + vs)
ir3 <- as_d3_ir(p3)
stopifnot(length(ir3$facets$cols) == 2)  # am and vs
cat("facet_grid multi-var: PASS\n")

# Test backward compat
p4 <- ggplot(mtcars, aes(wt, mpg)) + geom_point() + facet_wrap(~ cyl)
ir4 <- as_d3_ir(p4)
stopifnot(ir4$facets$type == "wrap")
cat("facet_wrap compat: PASS\n")

# Test non-faceted
p5 <- ggplot(mtcars, aes(wt, mpg)) + geom_point()
ir5 <- as_d3_ir(p5)
stopifnot(ir5$facets$type == "null")
cat("non-faceted compat: PASS\n")
```
  </verify>
  <done>facet_grid plots produce IR with type="grid", correct rows/cols, row_strips/col_strips, scales mode, and per-panel ranges. facet_wrap and non-faceted plots unaffected.</done>
</task>

<task type="auto">
  <name>Task 2: Update validate_ir for facet_grid</name>
  <files>R/validate_ir.R</files>
  <action>
Extend the facets validation section in validate_ir.R (around line 110) to handle `type = "grid"`:

```r
if (ir$facets$type == "grid") {
  if (is.null(ir$facets$layout) || length(ir$facets$layout) == 0) {
    stop("facet_grid IR must have non-empty layout", call. = FALSE)
  }
  if (is.null(ir$facets$rows) && is.null(ir$facets$cols)) {
    warning("facet_grid IR has neither rows nor cols", call. = FALSE)
  }
  if (is.null(ir$facets$row_strips) && is.null(ir$facets$col_strips)) {
    warning("facet_grid IR has no strip labels", call. = FALSE)
  }
  if (is.null(ir$facets$nrow) || is.null(ir$facets$ncol)) {
    warning("facet_grid IR missing nrow/ncol", call. = FALSE)
  }
  if (!is.null(ir$facets$scales) && !ir$facets$scales %in% c("fixed", "free", "free_x", "free_y")) {
    warning(sprintf("Unrecognized facet scales mode '%s'", ir$facets$scales), call. = FALSE)
  }
}
```

Run `devtools::test()` or `pkgload::load_all()` to confirm no regressions.
  </action>
  <verify>
```r
pkgload::load_all()
library(ggplot2)
# Validation should pass for all facet types
p1 <- ggplot(mtcars, aes(wt, mpg)) + geom_point() + facet_grid(cyl ~ am)
ir1 <- as_d3_ir(p1)  # validate_ir called internally
cat("facet_grid validation: PASS\n")

p2 <- ggplot(mtcars, aes(wt, mpg)) + geom_point() + facet_wrap(~ cyl)
ir2 <- as_d3_ir(p2)
cat("facet_wrap validation: PASS\n")

p3 <- ggplot(mtcars, aes(wt, mpg)) + geom_point()
ir3 <- as_d3_ir(p3)
cat("non-faceted validation: PASS\n")
```
  </verify>
  <done>validate_ir accepts facet_grid IR with type="grid" and validates rows, cols, row_strips, col_strips, scales mode. Existing facet_wrap and non-faceted validation unaffected.</done>
</task>

</tasks>

<verification>
1. `pkgload::load_all()` succeeds without errors
2. facet_grid plots produce IR with type="grid", correct metadata
3. Free scale modes (free, free_x, free_y) are correctly detected
4. Multi-variable facets produce concatenated strip labels
5. facet_wrap plots continue to produce type="wrap" IR
6. Non-faceted plots continue to produce type="null" IR
7. All validate_ir checks pass for grid, wrap, and null types
</verification>

<success_criteria>
- facet_grid(cyl ~ am) produces IR with type="grid", rows=["cyl"], cols=["am"], 6 panels, 3 row_strips, 2 col_strips
- facet_grid(cyl ~ am, scales="free") produces IR with scales="free" and per-panel different ranges
- Multi-variable facet_grid(a + b ~ c) produces correct strip labels
- Backward compatibility: facet_wrap and non-faceted plots unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/09-advanced-faceting/09-01-SUMMARY.md`
</output>
