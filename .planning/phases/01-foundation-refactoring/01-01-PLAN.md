---
phase: 01-foundation-refactoring
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - inst/htmlwidgets/modules/constants.js
  - inst/htmlwidgets/modules/scales.js
autonomous: true

must_haves:
  truths:
    - "Unit conversion constants are defined once with documented W3C source"
    - "All conversion functions (mm to px radius, mm to px linewidth, pt to px) are exported from constants module"
    - "Scale factory creates correct D3 scale object for every type in the current codebase (continuous, categorical, log, sqrt, pow, symlog, time, utc, band, point, quantize, quantile, threshold)"
    - "Scale factory handles edge cases: missing descriptor, empty domain, mixed type guessing"
  artifacts:
    - path: "inst/htmlwidgets/modules/constants.js"
      provides: "Unit conversion constants and helper functions"
      contains: "PX_PER_MM"
    - path: "inst/htmlwidgets/modules/scales.js"
      provides: "Scale factory for D3 scale creation from IR descriptors"
      contains: "createScale"
  key_links:
    - from: "inst/htmlwidgets/modules/scales.js"
      to: "inst/htmlwidgets/modules/constants.js"
      via: "reads PX_PER_MM, PX_PER_PT from constants namespace"
      pattern: "gg2d3\\.constants"
---

<objective>
Create the constants module (centralized unit conversions) and scale factory module as standalone JS files that will be loaded by htmlwidgets. These are the foundational utilities that all other modules depend on.

Purpose: Eliminate scattered magic numbers (3.78, 1.89, 0.945, etc.) and duplicated scale creation logic. Establish the shared namespace pattern (`window.gg2d3`) that all modules will use.
Output: Two new JS files in `inst/htmlwidgets/modules/` ready to be wired into the widget.
</objective>

<execution_context>
@/Users/davidzenz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davidzenz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-refactoring/01-RESEARCH.md
@inst/htmlwidgets/gg2d3.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create constants module with unit conversions and ggplot2 defaults</name>
  <files>inst/htmlwidgets/modules/constants.js</files>
  <action>
Create directory `inst/htmlwidgets/modules/` if it does not exist.

Create `constants.js` that establishes the shared namespace pattern and defines all unit conversion constants. This file MUST be loaded first by htmlwidgets (before all other modules).

**Namespace pattern:**
```javascript
window.gg2d3 = window.gg2d3 || {};
window.gg2d3.constants = { ... };
```

Do NOT use ES6 `import`/`export` syntax -- htmlwidgets loads scripts via regular `<script>` tags without `type="module"`. All modules communicate through `window.gg2d3` namespace.

**Constants to define (with documented sources):**
- `DPI = 96` (W3C CSS Values spec)
- `MM_PER_INCH = 25.4`
- `PT_PER_INCH = 72`
- `PX_PER_MM = DPI / MM_PER_INCH` (3.7795275591)
- `PX_PER_PT = DPI / PT_PER_INCH` (1.3333...)

**Conversion functions to define:**
- `mmToPxRadius(sizeMm)` -- converts ggplot2 size (mm diameter) to SVG radius (px). Formula: `(sizeMm * PX_PER_MM) / 2`
- `mmToPxLinewidth(linewidthMm)` -- converts ggplot2 linewidth (mm) to SVG stroke-width (px). Formula: `linewidthMm * PX_PER_MM`
- `ptToPx(sizePt)` -- converts point size to pixels. Formula: `sizePt * PX_PER_PT`

**ggplot2 defaults object (from theme_gray):**
```javascript
GGPLOT_DEFAULTS: {
  linewidth: 0.5,            // mm
  pointSize: 1.5,            // mm (diameter)
  textSize: 11,              // pt (axis title)
  textSizeSmall: 8.8,        // pt (axis text, converted: 11 * 0.8)
  gridMajorLinewidth: 0.5,   // mm (theme_gray default)
  gridMinorLinewidth: 0.25,  // mm (theme_gray default)
  panelBackground: "#EBEBEB",
  gridColor: "white",
  axisTextColor: "#4D4D4D",
  strokeWidth: 0.5           // default stroke-width for points
}
```

Verify the conversion values match what currently exists in gg2d3.js by searching for all instances of `3.78`, `3.7795275591`, `1.89`, `0.945`, `8.8`, `0.5`. Every hardcoded conversion value currently in gg2d3.js must have a corresponding constant or function here.
  </action>
  <verify>
Open `inst/htmlwidgets/modules/constants.js` in a browser console (or Node.js):
- `gg2d3.constants.PX_PER_MM` should equal approximately 3.7795275591
- `gg2d3.constants.PX_PER_PT` should equal approximately 1.3333
- `gg2d3.constants.mmToPxRadius(1.5)` should equal approximately 2.835 (the default point radius)
- `gg2d3.constants.mmToPxLinewidth(0.5)` should equal approximately 1.89 (the default line width)
- `gg2d3.constants.ptToPx(11)` should equal approximately 14.67
  </verify>
  <done>
constants.js exists with all unit conversion constants, conversion functions, and ggplot2 defaults. Every magic number currently scattered across gg2d3.js has a named constant equivalent. The `window.gg2d3.constants` namespace is established.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create scale factory module extracting makeScale logic</name>
  <files>inst/htmlwidgets/modules/scales.js</files>
  <action>
Create `scales.js` that extracts the `makeScale()` function (lines 40-175 of current gg2d3.js) into the shared namespace as `window.gg2d3.scales.createScale()`.

**Key implementation details:**

1. The function signature stays the same: `createScale(descriptor, range)` returns a D3 scale object.

2. Extract the entire `makeScale` function logic exactly as-is from gg2d3.js. This is a pure extraction -- do NOT change any behavior, domain handling, padding defaults, or fallback logic. The goal is identical output.

3. The function handles these scale types (all must be preserved):
   - continuous/linear/identity -> d3.scaleLinear()
   - log/logarithmic/log10/log2 -> d3.scaleLog() with base
   - sqrt/square-root -> d3.scaleSqrt()
   - pow/power -> d3.scalePow() with exponent
   - symlog/sym-log -> d3.scaleSymlog()
   - time/date/datetime -> d3.scaleTime()
   - utc/time-utc -> d3.scaleUtc()
   - band/categorical/ordinal/discrete -> d3.scaleBand() with padding
   - point -> d3.scalePoint()
   - quantize, quantile, threshold -> respective D3 scales
   - Fallback: guess from domain (numeric -> linear, string -> band with paddingInner(0.2).paddingOuter(0.6))

4. Also extract `convertColor()` function into this module as `window.gg2d3.scales.convertColor()` -- it handles R grey0-grey100 to hex conversion and is used across all modules. (It logically belongs with scales/color handling.)

5. Register on namespace:
```javascript
window.gg2d3 = window.gg2d3 || {};
window.gg2d3.scales = {
  createScale: function(descriptor, range) { ... },
  convertColor: function(color) { ... }
};
```

**Critical: Do NOT change any default values.** The band padding defaults (0.1 for explicit band, 0.2/0.6 for guessed), domain expansion logic, and all fallback behaviors must be byte-for-byte identical to the current makeScale() implementation.
  </action>
  <verify>
Compare the extracted createScale() against the original makeScale() in gg2d3.js:
- Both should produce identical scale objects for the same inputs
- Test with: `createScale({type: "continuous", domain: [0, 10]}, [0, 400])` -- should return linear scale
- Test with: `createScale({type: "categorical", domain: ["A", "B", "C"]}, [0, 400])` -- should return band scale with padding 0.1
- Test with: `createScale(null, [0, 400])` -- should return linear [0,1] -> [0,400]
- Test convertColor("grey50") returns "#808080" (or close)
  </verify>
  <done>
scales.js exists with createScale() and convertColor() that are functionally identical to the current makeScale() and convertColor() in gg2d3.js. No behavior changes -- pure extraction into the `window.gg2d3.scales` namespace.
  </done>
</task>

</tasks>

<verification>
1. Both files exist in `inst/htmlwidgets/modules/`
2. Both files use `window.gg2d3` namespace pattern (no ES6 import/export)
3. constants.js defines PX_PER_MM = 96/25.4 and all conversion functions
4. scales.js createScale() handles all 15+ scale type strings from original makeScale()
5. No ES6 module syntax used (no import/export statements)
</verification>

<success_criteria>
- `inst/htmlwidgets/modules/constants.js` contains all unit conversion constants with W3C source documentation
- `inst/htmlwidgets/modules/scales.js` contains createScale() equivalent to current makeScale()
- convertColor() is extracted to scales module
- Both use `window.gg2d3` namespace for cross-module access
- Existing gg2d3.js is NOT modified yet (that happens in Plan 05)
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-refactoring/01-01-SUMMARY.md`
</output>
