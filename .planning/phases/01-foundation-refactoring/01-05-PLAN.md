---
phase: 01-foundation-refactoring
plan: 05
type: execute
wave: 3
depends_on: ["01-01", "01-02", "01-03"]
files_modified:
  - inst/htmlwidgets/gg2d3.js
  - inst/htmlwidgets/gg2d3.yaml
autonomous: false

must_haves:
  truths:
    - "All 8 existing geoms render identically to pre-refactor output"
    - "gg2d3.js draw() function dispatches through geom registry instead of inline if/else"
    - "htmlwidgets loads all module scripts in correct dependency order"
    - "Adding a new geom requires only a new file + register call, zero changes to gg2d3.js"
  artifacts:
    - path: "inst/htmlwidgets/gg2d3.js"
      provides: "Refactored widget entry point using modular components"
      contains: "gg2d3.geomRegistry.render"
    - path: "inst/htmlwidgets/gg2d3.yaml"
      provides: "Updated htmlwidgets config loading all module scripts"
      contains: "modules/constants.js"
  key_links:
    - from: "inst/htmlwidgets/gg2d3.js"
      to: "inst/htmlwidgets/modules/geom-registry.js"
      via: "draw() calls gg2d3.geomRegistry.render() for each layer"
      pattern: "gg2d3\\.geomRegistry\\.render"
    - from: "inst/htmlwidgets/gg2d3.js"
      to: "inst/htmlwidgets/modules/theme.js"
      via: "draw() calls gg2d3.theme.createTheme() for theme resolution"
      pattern: "gg2d3\\.theme\\.createTheme"
    - from: "inst/htmlwidgets/gg2d3.js"
      to: "inst/htmlwidgets/modules/scales.js"
      via: "draw() calls gg2d3.scales.createScale() for axis scales"
      pattern: "gg2d3\\.scales\\.createScale"
    - from: "inst/htmlwidgets/gg2d3.yaml"
      to: "inst/htmlwidgets/modules/*.js"
      via: "script array loads modules before main widget JS"
      pattern: "modules/"
---

<objective>
Wire all extracted modules into the main gg2d3.js widget and update the htmlwidgets YAML to load the module scripts. This is the integration plan that replaces the monolithic draw() function with modular dispatch. Includes a human verification checkpoint to confirm visual output is unchanged.

Purpose: Complete the refactoring by connecting the extracted modules (constants, scales, theme, geom registry, geom renderers) back into the widget entry point. The draw() function shrinks from ~450 lines to ~80 lines of orchestration code.
Output: Refactored gg2d3.js + updated gg2d3.yaml + verified visual parity.
</objective>

<execution_context>
@/Users/davidzenz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davidzenz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-refactoring/01-RESEARCH.md
@.planning/phases/01-foundation-refactoring/01-01-SUMMARY.md
@.planning/phases/01-foundation-refactoring/01-02-SUMMARY.md
@.planning/phases/01-foundation-refactoring/01-03-SUMMARY.md
@inst/htmlwidgets/gg2d3.js
@inst/htmlwidgets/gg2d3.yaml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update gg2d3.yaml to load module scripts in dependency order</name>
  <files>inst/htmlwidgets/gg2d3.yaml</files>
  <action>
Update the htmlwidgets YAML configuration to load all module scripts BEFORE the main gg2d3.js widget file. Scripts are loaded as separate `<script>` tags in the order listed, sharing the global scope.

**Load order matters:**
1. constants.js (establishes `window.gg2d3` namespace + helpers)
2. scales.js (needs constants for convertColor)
3. theme.js (needs scales for convertColor)
4. geom-registry.js (needs helpers namespace to exist)
5. geoms/point.js (needs registry + constants + helpers)
6. geoms/line.js (needs registry + constants + helpers)
7. geoms/bar.js (needs registry + constants + helpers)
8. geoms/rect.js (needs registry + constants + helpers)
9. geoms/text.js (needs registry + constants + helpers)
10. gg2d3.js (main widget - needs everything above)

The YAML `script` field accepts an array:

```yaml
name: gg2d3
version: 0.0.1
src: htmlwidgets
script:
  - modules/constants.js
  - modules/scales.js
  - modules/theme.js
  - modules/geom-registry.js
  - modules/geoms/point.js
  - modules/geoms/line.js
  - modules/geoms/bar.js
  - modules/geoms/rect.js
  - modules/geoms/text.js
  - gg2d3.js

dependencies:
  - name: d3
    version: "7"
    src: htmlwidgets/lib/d3
    script: d3.v7.min.js
```

Note: The `src: htmlwidgets` directive means paths are relative to `inst/htmlwidgets/`. So `modules/constants.js` resolves to `inst/htmlwidgets/modules/constants.js`.

**IMPORTANT FALLBACK:** If htmlwidgets does not support the script array format (unlikely but possible), the fallback is to list the modules as additional dependencies:

```yaml
dependencies:
  - name: d3
    version: "7"
    src: htmlwidgets/lib/d3
    script: d3.v7.min.js
  - name: gg2d3-modules
    version: "0.0.1"
    src: htmlwidgets/modules
    script:
      - constants.js
      - scales.js
      - theme.js
      - geom-registry.js
      - geoms/point.js
      - geoms/line.js
      - geoms/bar.js
      - geoms/rect.js
      - geoms/text.js
```

Try the primary approach first. Test by running `devtools::load_all()` and `gg2d3(ggplot2::ggplot(mtcars, ggplot2::aes(wt, mpg)) + ggplot2::geom_point())` in R. Check the browser developer console for script loading errors. If modules fail to load, switch to the dependency-based approach.
  </action>
  <verify>
Run in R:
```r
devtools::load_all()
library(ggplot2)
p <- ggplot(mtcars, aes(wt, mpg)) + geom_point()
w <- gg2d3(p)
htmlwidgets::saveWidget(w, "/tmp/test_modules.html", selfcontained = FALSE)
```
Then open `/tmp/test_modules.html` in a browser. Check:
1. No JavaScript errors in browser console
2. All module script tags present in HTML source
3. `window.gg2d3` namespace exists with constants, scales, theme, geomRegistry, helpers
  </verify>
  <done>
gg2d3.yaml loads all module scripts in correct dependency order before gg2d3.js. htmlwidgets generates HTML with all script tags. No JavaScript loading errors in browser console.
  </done>
</task>

<task type="auto">
  <name>Task 2: Refactor gg2d3.js draw() to use modular dispatch</name>
  <files>inst/htmlwidgets/gg2d3.js</files>
  <action>
Rewrite gg2d3.js to use the extracted modules instead of inline implementations. The file should shrink from ~717 lines to ~120-150 lines of orchestration code.

**What to REMOVE from gg2d3.js:**
- Inline helper functions: val(), num(), isHexColor(), isValidColor(), asRows() (now in gg2d3.helpers)
- makeScale() function (now in gg2d3.scales.createScale)
- convertColor() function (now in gg2d3.scales.convertColor)
- applyAxisStyle() function (now in gg2d3.theme.applyAxisStyle)
- defaultTheme object (now in gg2d3.theme.DEFAULT_THEME)
- getTheme() closure (now in gg2d3.theme.createTheme().get())
- All geom rendering blocks inside the layers forEach (now dispatched via registry)
- Grid drawing code (now in gg2d3.theme.drawGrid)
- Padding calculation code (now in gg2d3.theme.calculatePadding)

**What to KEEP in gg2d3.js (the orchestration):**
The HTMLWidgets.widget factory with a draw() function that:

1. Clears existing SVG
2. Sets up dimensions (innerW, innerH)
3. Creates theme accessor: `var themeCtx = gg2d3.theme.createTheme(ir.theme);`
4. Calculates padding: `var pad = gg2d3.theme.calculatePadding(themeCtx, ir.padding);`
5. Calculates panel w/h
6. Creates SVG root and panel group (g)
7. Draws plot background using themeCtx
8. Draws panel background using themeCtx
9. Sets up coord flip
10. Creates scales: `var xScale = gg2d3.scales.createScale(ir.scales.x, ...);`
11. Draws grids: `gg2d3.theme.drawGrid(g, xScale, "vertical", ...);`
12. Draws title
13. Sets up color scale
14. **Dispatches layers through registry:**
```javascript
var drawn = 0;
(ir.layers || []).forEach(function(layer) {
  var layerG = g.append("g").attr("class", "layer layer-" + layer.geom);
  var count = gg2d3.geomRegistry.render(layer.geom, layer, layerG, xScale, yScale, {
    colorScale: colorScale,
    helpers: gg2d3.helpers,
    constants: gg2d3.constants,
    convertColor: gg2d3.scales.convertColor,
    w: w,
    h: h
  });
  drawn += count;
});
```
15. Draws axes using themeCtx
16. Handles "no marks drawn" warning

**CRITICAL behavioral details to preserve:**
- Axis rendering happens AFTER data layers (lines 665-689) -- the `.append("g").attr("class", "axis")` calls must remain after the layer loop
- The x-axis position calculation (lines 676-685): when y-domain includes 0, x-axis is at yScale(0), not at bottom. This logic stays in draw().
- Color scale setup (lines 389-394): the ternary for continuous vs ordinal color scale stays in draw()
- The coord flip logic (line 316-318): swap ranges for xScale/yScale when flip is true. This stays in draw().
- The "no marks drawn" fallback (lines 691-694): red circle indicator stays in draw()
- Title rendering (lines 376-386): stays in draw(), uses themeCtx.get("text.title")

**IMPORTANT NOTE on geom renderers:** The current code wraps each geom's D3 selections in a new `g.append("g")` for some geoms (point line 455, bar line 561) but not all. In the refactored version, the main loop creates a wrapper `<g>` per layer and passes it to the renderer. The individual geom renderers should append directly to this group. Review each geom file from Plan 03 to ensure they append to the provided `g` parameter correctly (not creating an extra wrapping group if the orchestrator already does).

Actually -- look at the current code more carefully:
- Point: `g.append("g").selectAll("circle").data(pts)` -- creates a wrapping group
- Line: `g.append("path")` -- appends directly to panel g
- Bar: `g.append("g").selectAll("rect").data(bars)` -- creates a wrapping group
- Rect: `g.append("g").selectAll("rect").data(rects)` -- creates a wrapping group
- Text: `g.append("g").selectAll("text").data(txt)` -- creates a wrapping group

The geom renderers from Plan 03 should each create their own inner group structure on the `g` selection they receive. The orchestrator in draw() should pass the per-layer `<g>` group to the renderer. The renderer handles its own internal structure.

**Testing after refactoring:**
After rewriting, run:
```r
devtools::load_all()
library(ggplot2)

# Test all 8 geom types
p1 <- ggplot(mtcars, aes(wt, mpg)) + geom_point()
p2 <- ggplot(mtcars, aes(wt, mpg)) + geom_line()
p3 <- ggplot(mtcars, aes(wt, mpg)) + geom_path()
p4 <- ggplot(mtcars, aes(factor(cyl), mpg)) + geom_col()
p5 <- ggplot(mtcars, aes(factor(cyl), mpg)) + geom_bar(stat = "identity")
p6 <- ggplot(mtcars, aes(wt, mpg, label = rownames(mtcars))) + geom_text()
# rect/tile need special data setup

for (i in seq_along(list(p1, p2, p3, p4, p5, p6))) {
  w <- gg2d3(list(p1, p2, p3, p4, p5, p6)[[i]])
  htmlwidgets::saveWidget(w, sprintf("/tmp/test_geom_%d.html", i), selfcontained = FALSE)
}
```

Open each HTML file and verify rendering. Also run `devtools::test()` to verify the R test suite still passes.
  </action>
  <verify>
1. `devtools::test()` -- all R tests pass
2. Open test HTML files in browser -- no JS console errors
3. Each geom type renders visible SVG elements
4. Check browser console: `gg2d3.geomRegistry.list()` returns all 8 geom names
5. Inspect SVG DOM: layers are wrapped in `<g class="layer layer-point">` etc.
6. Line count of gg2d3.js is under 200 lines (was 717)
  </verify>
  <done>
gg2d3.js is refactored to use modular dispatch. draw() is ~120-150 lines of orchestration. All inline helpers, scale creation, theme logic, and geom rendering are replaced with namespace calls to the extracted modules. gg2d3.yaml loads all scripts. The widget renders correctly.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Visual regression verification</name>
  <what-built>
Complete modular refactoring of gg2d3.js. The monolithic renderer has been split into:
- constants.js (unit conversions)
- scales.js (scale factory)
- theme.js (theme defaults + styling)
- geom-registry.js (dispatch registry)
- 5 geom renderer files (point, line, bar, rect, text)
- Refactored gg2d3.js (orchestration only)

All rendering logic should produce identical SVG output to before the refactoring.
  </what-built>
  <how-to-verify>
Claude will generate comparison HTML files before this checkpoint. Verify:

1. Open each test HTML file in a browser
2. Compare against the same ggplot rendered via R's standard graphics (or against pre-refactor screenshots if available)
3. Check specifically:
   - Point sizes look correct (not too large, not too small)
   - Line widths match ggplot2 output
   - Bar chart fills and outlines render correctly
   - Grid lines appear with correct color (white) and thickness
   - Panel background is light gray (#EBEBEB)
   - Axis text and titles are positioned correctly
   - No JavaScript errors in browser console

4. Run this in R to generate side-by-side comparison:
```r
library(ggplot2)
devtools::load_all()
p <- ggplot(mtcars, aes(wt, mpg, color = factor(cyl))) + geom_point() + ggtitle("Test Plot")
# D3 version
htmlwidgets::saveWidget(gg2d3(p), "/tmp/refactor_test.html", selfcontained = FALSE)
# ggplot2 version
ggsave("/tmp/refactor_test.png", p, width = 6.67, height = 4.17)
```

5. Open both files and visually compare. Key things to check:
   - Points are in the same positions
   - Colors match between ggplot and D3
   - Theme styling (background, grids) matches
  </how-to-verify>
  <resume-signal>Type "approved" if visual output matches pre-refactor, or describe any differences</resume-signal>
</task>

</tasks>

<verification>
1. gg2d3.yaml lists all module scripts in correct load order
2. gg2d3.js draw() uses gg2d3.geomRegistry.render() for layer dispatch
3. gg2d3.js draw() uses gg2d3.theme.createTheme() for theme resolution
4. gg2d3.js draw() uses gg2d3.scales.createScale() for axis scales
5. All 8 geom types render without JavaScript errors
6. devtools::test() passes all R tests
7. Visual output matches pre-refactor rendering
</verification>

<success_criteria>
- gg2d3.js is under 200 lines (from 717)
- All module scripts load successfully via htmlwidgets
- draw() function is pure orchestration -- no inline geom logic
- Human has verified visual output matches pre-refactor
- No JavaScript console errors on any test case
- R test suite passes completely
- A new geom can be added by creating one file and calling register() -- zero changes to gg2d3.js needed
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-refactoring/01-05-SUMMARY.md`
</output>
