---
phase: 01-foundation-refactoring
plan: 03
type: execute
wave: 2
depends_on: ["01-01", "01-02"]
files_modified:
  - inst/htmlwidgets/modules/geom-registry.js
  - inst/htmlwidgets/modules/geoms/point.js
  - inst/htmlwidgets/modules/geoms/line.js
  - inst/htmlwidgets/modules/geoms/bar.js
  - inst/htmlwidgets/modules/geoms/rect.js
  - inst/htmlwidgets/modules/geoms/text.js
autonomous: true

must_haves:
  truths:
    - "Each geom renderer is a standalone function with consistent signature: function(layer, g, xScale, yScale, options)"
    - "Geom registry maps geom name strings to renderer functions via registerGeom/renderGeom pattern"
    - "All 8 existing geom types (point, line, path, bar, col, rect, tile, text) are registered"
    - "Adding a new geom requires only: creating a renderer function and calling registerGeom()"
  artifacts:
    - path: "inst/htmlwidgets/modules/geom-registry.js"
      provides: "Central registry mapping geom names to renderer functions"
      contains: "registerGeom"
    - path: "inst/htmlwidgets/modules/geoms/point.js"
      provides: "Point geom renderer"
      contains: "renderPoint"
    - path: "inst/htmlwidgets/modules/geoms/line.js"
      provides: "Line and path geom renderer"
      contains: "renderLine"
    - path: "inst/htmlwidgets/modules/geoms/bar.js"
      provides: "Bar and col geom renderer"
      contains: "renderBar"
    - path: "inst/htmlwidgets/modules/geoms/rect.js"
      provides: "Rect and tile geom renderer"
      contains: "renderRect"
    - path: "inst/htmlwidgets/modules/geoms/text.js"
      provides: "Text geom renderer"
      contains: "renderText"
  key_links:
    - from: "inst/htmlwidgets/modules/geom-registry.js"
      to: "inst/htmlwidgets/modules/geoms/*.js"
      via: "geom files call gg2d3.geomRegistry.register()"
      pattern: "gg2d3\\.geomRegistry\\.register"
    - from: "inst/htmlwidgets/modules/geoms/point.js"
      to: "inst/htmlwidgets/modules/constants.js"
      via: "uses gg2d3.constants.mmToPxRadius for point sizing"
      pattern: "gg2d3\\.constants\\.mmToPxRadius"
    - from: "inst/htmlwidgets/modules/geoms/bar.js"
      to: "inst/htmlwidgets/modules/constants.js"
      via: "uses gg2d3.constants.PX_PER_MM for linewidth conversion"
      pattern: "gg2d3\\.constants\\.PX_PER_MM"
---

<objective>
Extract all geom rendering logic from the monolithic draw() function into individual renderer files with a central registry for dispatch. This is the core architectural change that enables adding new geoms without modifying core rendering code.

Purpose: The current draw() function has ~230 lines of if/else geom rendering. Extracting each geom into a standalone renderer with a consistent interface makes the codebase scalable for Phase 4-5 geom additions and testable per-geom.
Output: geom-registry.js + 5 geom renderer files (point, line, bar, rect, text) covering all 8 geom types.
</objective>

<execution_context>
@/Users/davidzenz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davidzenz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-refactoring/01-RESEARCH.md
@.planning/phases/01-foundation-refactoring/01-01-SUMMARY.md
@.planning/phases/01-foundation-refactoring/01-02-SUMMARY.md
@inst/htmlwidgets/gg2d3.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create geom registry with register/render dispatch</name>
  <files>inst/htmlwidgets/modules/geom-registry.js</files>
  <action>
Create `inst/htmlwidgets/modules/geom-registry.js` that provides the central dispatch mechanism for geom rendering.

Register on namespace:
```javascript
window.gg2d3 = window.gg2d3 || {};
window.gg2d3.geomRegistry = {
  _registry: {},

  register: function(name, renderFn) {
    this._registry[name] = renderFn;
  },

  render: function(geomName, layer, g, xScale, yScale, options) {
    var renderer = this._registry[geomName];
    if (!renderer) {
      console.warn("gg2d3: unknown geom '" + geomName + "'");
      return 0;
    }
    return renderer(layer, g, xScale, yScale, options);
  },

  has: function(geomName) {
    return geomName in this._registry;
  },

  list: function() {
    return Object.keys(this._registry);
  }
};
```

The registry stores renderer functions keyed by geom name string. The `render()` method dispatches to the appropriate renderer. Unknown geoms log a warning and return 0 (drawn count).

**Renderer interface contract** (document in a comment at the top of the file):
```
/**
 * Geom Renderer Interface
 * -----------------------
 * Every geom renderer function has this signature:
 *
 * function(layer, g, xScale, yScale, options) -> number
 *
 * @param {Object} layer - IR layer: { geom, data, aes, params }
 * @param {d3.Selection} g - D3 selection (panel <g> element) to append to
 * @param {d3.Scale} xScale - X axis scale
 * @param {d3.Scale} yScale - Y axis scale
 * @param {Object} options - Shared rendering context:
 *   options.colorScale - D3 color scale (from IR scales.color)
 *   options.helpers - { val, num, asRows, isValidColor } from gg2d3.helpers
 *   options.constants - gg2d3.constants (conversion functions)
 *   options.convertColor - gg2d3.scales.convertColor function
 *   options.w - panel width in pixels
 *   options.h - panel height in pixels
 *
 * @returns {number} Count of SVG elements drawn (for debug logging)
 *
 * Conventions:
 * - Always append to g, never replace
 * - Use options.helpers.val/num for data access
 * - Use options.constants for unit conversions
 * - Return 0 if no elements drawn
 */
```

This file must load BEFORE the individual geom files (so the registry exists when they try to register).
  </action>
  <verify>
After loading:
- `gg2d3.geomRegistry._registry` is an empty object
- `gg2d3.geomRegistry.register("test", function() { return 0; })` succeeds
- `gg2d3.geomRegistry.has("test")` returns true
- `gg2d3.geomRegistry.has("unknown")` returns false
- `gg2d3.geomRegistry.render("unknown", ...)` logs warning and returns 0
  </verify>
  <done>
geom-registry.js exists with register(), render(), has(), and list() methods. The renderer interface contract is documented. Ready for geom files to register themselves.
  </done>
</task>

<task type="auto">
  <name>Task 2: Extract all 5 geom renderers into individual files</name>
  <files>
    inst/htmlwidgets/modules/geoms/point.js
    inst/htmlwidgets/modules/geoms/line.js
    inst/htmlwidgets/modules/geoms/bar.js
    inst/htmlwidgets/modules/geoms/rect.js
    inst/htmlwidgets/modules/geoms/text.js
  </files>
  <action>
Create directory `inst/htmlwidgets/modules/geoms/` and extract each geom renderer from the draw() function in gg2d3.js (lines 436-662).

Each file follows the same pattern:
1. Define the renderer function
2. Register it with the geom registry
3. Access shared utilities via `window.gg2d3.*` namespace

**CRITICAL:** The rendering logic must be IDENTICAL to the current implementation. Copy the logic exactly, only changing how utilities are accessed (from closure variables to namespace references).

**Mapping of namespace references:**
- `val(x)` -> `gg2d3.helpers.val(x)`
- `num(x)` -> `gg2d3.helpers.num(x)`
- `asRows(data)` -> `gg2d3.helpers.asRows(data)`
- `isValidColor(s)` -> `gg2d3.helpers.isValidColor(s)`
- `convertColor(c)` -> `gg2d3.scales.convertColor(c)`
- `mmToPxRadius(size)` -> `gg2d3.constants.mmToPxRadius(size)`
- Hardcoded `3.78` or `3.7795275591` -> `gg2d3.constants.PX_PER_MM`
- Hardcoded `1.89` (linewidth) -> `gg2d3.constants.mmToPxLinewidth(0.5)` or use `options.constants.PX_PER_MM * value`

---

**point.js** - Extract from lines 436-493 of gg2d3.js:
```javascript
(function() {
  function renderPoint(layer, g, xScale, yScale, options) {
    var helpers = gg2d3.helpers;
    var constants = gg2d3.constants;
    var dat = helpers.asRows(layer.data);
    var aes = layer.aes || {};
    // ... exact logic from current point rendering ...
    // Use constants.mmToPxRadius() instead of inline mmToPxRadius()
    // Build strokeColor/fillColor/opa helpers using options pattern
  }
  gg2d3.geomRegistry.register("point", renderPoint);
})();
```

Each geom renderer needs to build its own strokeColor/fillColor/opa helper functions internally, since these depend on layer-specific aes mappings. Extract the pattern from the current code (lines 403-434 in gg2d3.js) into a shared helper within each renderer OR add a color resolution utility.

Actually, the color/fill/opacity logic (lines 403-434) is repeated identically for each geom. Create a shared color resolution utility at the top of each geom file OR better yet, add it to `gg2d3.helpers`:

Add to constants.js (in the helpers section):
```javascript
// Color resolution helpers - create per-layer color accessors
makeColorAccessors: function(layer, colorScale) {
  var helpers = gg2d3.helpers;
  var convertColor = gg2d3.scales.convertColor;
  var aes = layer.aes || {};
  var get = function(d, k) { return (k && d != null) ? d[k] : null; };

  return {
    strokeColor: function(d) {
      if (aes.color) {
        var v = helpers.val(get(d, aes.color));
        if (helpers.isValidColor(v)) return convertColor(v);
        var mapped = colorScale(v);
        return mapped || (layer.params && layer.params.colour) || "currentColor";
      }
      return (layer.params && layer.params.colour) || "currentColor";
    },
    fillColor: function(d) {
      if (aes.fill) {
        var v = helpers.val(get(d, aes.fill));
        if (helpers.isValidColor(v)) return convertColor(v);
        var mapped = colorScale(v);
        return mapped || (layer.params && layer.params.fill) || "grey35";
      }
      return (layer.params && layer.params.fill) || "grey35";
    },
    opacity: function(d) {
      if (aes.alpha) {
        var v = helpers.val(get(d, aes.alpha));
        return (v == null ? 1 : +v);
      }
      return 1;
    },
    get: get
  };
}
```

Wait -- this should NOT go in constants.js during Plan 01 execution since Plan 01 runs in Wave 1 before this plan. Instead, add `makeColorAccessors` to the geom-registry.js file as a utility, since it is specifically needed by geom renderers:

```javascript
gg2d3.geomRegistry.makeColorAccessors = function(layer, colorScale) { ... };
```

---

**Specific extraction for each geom:**

**point.js:** Lines 436-493. Key details:
- Handles both band and continuous x/y scales (isXBand/isYBand checks)
- Uses mmToPxRadius for sizing with aes.size support
- Special fill logic: if fill is NA, uses strokeColor (ggplot2 solid point behavior)
- Stroke logic: if fill is NA, stroke is "none"
- Returns pts.length

**line.js:** Lines 495-529. Handles both "line" and "path" geoms. Key details:
- Groups data by `group` column using d3.group()
- For "line" geom only: sorts by x (ascending) if x is not band
- For "path" geom: preserves data order (no sort)
- Linewidth conversion: `linewidthVal * 3.78` -> use `linewidthVal * gg2d3.constants.PX_PER_MM`
- Default linewidth: 1.89px (= 0.5mm * PX_PER_MM)
- Returns 1 per path drawn
- Register BOTH "line" AND "path" geom names to this renderer

**bar.js:** Lines 531-599. Handles both "bar" and "col" geoms. Key details:
- Band width from bandwidth() or calculated fallback
- Handles stacked bars (ymin/ymax present in data)
- Baseline calculation: 0 if in domain, else domain min
- Bar stroke default: colour=NA means no outline (stroke: "none")
- Linewidth conversion same as line geom
- Register BOTH "bar" AND "col" geom names

**rect.js:** Lines 601-633. Key details:
- Uses xmin/xmax/ymin/ymax aesthetics
- Handles both band and continuous scales for width/height calculation
- No stroke rendering (only fill + opacity)
- Register BOTH "rect" AND "tile" geom names (tile maps to rect in IR)

**text.js:** Lines 636-661. Key details:
- Uses label aesthetic for text content
- Fixed font-size "10px" (hardcoded -- preserve this)
- dominant-baseline: "middle", text-anchor: "middle"
- Uses strokeColor for text fill (not fillColor)
- Register "text" geom name

---

**For each geom file, the structure is:**
```javascript
(function() {
  var helpers = gg2d3.helpers;
  var constants = gg2d3.constants;

  function renderXxx(layer, g, xScale, yScale, options) {
    var dat = helpers.asRows(layer.data);
    var aes = layer.aes || {};
    var colors = gg2d3.geomRegistry.makeColorAccessors(layer, options.colorScale);
    // ... exact rendering logic ...
    return count;
  }

  gg2d3.geomRegistry.register("xxx", renderXxx);
})();
```
  </action>
  <verify>
After all files are loaded:
1. `gg2d3.geomRegistry.list()` returns ["point", "line", "path", "bar", "col", "rect", "tile", "text"] (8 entries)
2. `gg2d3.geomRegistry.has("point")` returns true
3. `gg2d3.geomRegistry.has("line")` returns true
4. `gg2d3.geomRegistry.has("path")` returns true
5. `gg2d3.geomRegistry.has("bar")` returns true
6. `gg2d3.geomRegistry.has("col")` returns true
7. `gg2d3.geomRegistry.has("rect")` returns true
8. `gg2d3.geomRegistry.has("tile")` returns true (alias for rect)
9. `gg2d3.geomRegistry.has("text")` returns true
10. Each renderer function has the documented 5-parameter signature
  </verify>
  <done>
All 5 geom renderer files exist in `inst/htmlwidgets/modules/geoms/`. Each renderer:
- Follows the documented interface (layer, g, xScale, yScale, options) -> number
- Is self-registering via gg2d3.geomRegistry.register()
- Uses namespace references (gg2d3.helpers.*, gg2d3.constants.*) instead of closure variables
- Contains logic IDENTICAL to the current inline implementation in gg2d3.js draw()
- All 8 geom type strings are registered (point, line, path, bar, col, rect, tile, text)
  </done>
</task>

</tasks>

<verification>
1. geom-registry.js defines register/render/has/list + makeColorAccessors utility
2. All 5 geom files exist in modules/geoms/ and self-register
3. 8 geom type strings registered covering all current geom support
4. Each renderer uses the consistent interface and returns element count
5. Color/fill/opacity resolution logic matches current per-geom implementations
6. Unit conversions use gg2d3.constants instead of hardcoded values
7. No ES6 import/export syntax
</verification>

<success_criteria>
- geom-registry.js provides register() and render() dispatch pattern
- 5 geom files cover all 8 geom types via aliases (line=path, bar=col, rect=tile)
- Every line of geom rendering logic from draw() is accounted for in the extracted files
- Renderer interface documented with JSDoc comment
- Files are ready to be loaded by htmlwidgets YAML configuration
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-refactoring/01-03-SUMMARY.md`
</output>
