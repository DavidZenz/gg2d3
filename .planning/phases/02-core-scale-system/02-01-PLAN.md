---
phase: 02-core-scale-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - R/as_d3_ir.R
autonomous: true

must_haves:
  truths:
    - "Scale domains extracted from panel_params include ggplot2's pre-computed expansion"
    - "Transformation metadata (type, base, exponent) passes through IR to JavaScript"
    - "Continuous scales emit breaks and minor_breaks from panel_params"
    - "Bar charts no longer touch axis edges (expansion is correct, not hardcoded 5%)"
  artifacts:
    - path: "R/as_d3_ir.R"
      provides: "Rewritten get_scale_info() using panel_params extraction"
      contains: "panel_params"
  key_links:
    - from: "R/as_d3_ir.R"
      to: "inst/htmlwidgets/modules/scales.js"
      via: "IR JSON with transform field"
      pattern: "transform.*=.*trans"
---

<objective>
Rewrite R-side scale extraction to use ggplot2's pre-computed panel_params instead of hardcoded 5% expansion, and emit transformation metadata (log, sqrt, pow, reverse, symlog) in the IR.

Purpose: The current `get_scale_info()` in `as_d3_ir.R` hardcodes `range_span * 0.05` for expansion and ignores scale transformations entirely. ggplot2's `ggplot_build()` already computes the correct expanded domain in `panel_params$x$range` and stores transformation info in `scale_obj$trans`. Extracting these pre-computed values ensures pixel-perfect fidelity and respects user-customized `expand = expansion(...)` settings.

Output: Updated `R/as_d3_ir.R` with new `get_scale_info()` and `get_scale_transform()` functions that produce extended IR scale descriptors.
</objective>

<execution_context>
@/Users/davidzenz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davidzenz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-scale-system/02-RESEARCH.md
@R/as_d3_ir.R
@inst/htmlwidgets/modules/scales.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite get_scale_info() to extract from panel_params</name>
  <files>R/as_d3_ir.R</files>
  <action>
Rewrite the `get_scale_info()` function in `as_d3_ir.R` to accept `panel_params_axis` (the panel_params entry for x or y) and the `scale_obj`, instead of the current `(scale_obj, data_values)` signature.

For CONTINUOUS scales:
- Extract the already-expanded domain from `panel_params_axis$range` (this is `b$layout$panel_params[[1]]$x$range` or `$y$range`) -- this domain ALREADY includes ggplot2's expansion computation, so do NOT apply any additional 5% expansion.
- Remove the hardcoded `range_span * 0.05` expansion calculation entirely.
- Remove the zero-clamping logic (`if (scale_range[1] >= 0 && expanded_range[1] < 0)`).
- Keep breaks and minor_breaks extraction from panel_params (already done correctly at lines 282-291).
- Add a `get_scale_transform()` helper function that extracts transformation metadata from `scale_obj$trans`:
  - Map ggplot2 trans names to D3 equivalents: "identity" -> NULL, "log-10" -> "log10", "log-2" -> "log2", "log" -> "log", "sqrt" -> "sqrt", "reverse" -> "reverse", "pseudo_log" -> "symlog"
  - Extract `base` for log scales (10 for log-10, 2 for log-2, exp(1) for natural log)
  - Extract `exponent` for power scales if available
  - Return NULL for identity transform (no transform field in IR)
- Merge transform info into the scale descriptor list.

For DISCRETE scales:
- Continue using `scale_obj$get_limits()` for domain (already correct).
- No transform support needed for discrete scales.

Update the call sites where `get_scale_info()` is invoked (around lines 293-301) to pass `panel_params_axis` from `b$layout$panel_params[[1]]$x` and `$y` respectively, instead of `allx`/`ally`.

Remove the `allx` and `ally` collection code (lines 271-272) since it's no longer needed for scale domain computation. Keep `allc` for color scale domain.

Important: The `panel_params` structure may vary by ggplot2 version. Access `panel_params[[1]]$x` and check for `$range` field. If `panel_params[[1]]$x` is a `ViewScale` object, the range is in `$range$range`. Test both access patterns:
- Try `b$layout$panel_params[[1]]$x.range` first
- If that's NULL, try `b$layout$panel_params[[1]]$x$range$range`
- Log a warning if neither works and fall back to `scale_obj$get_limits()` with manual expansion as last resort.
  </action>
  <verify>
Run `devtools::load_all()` and `devtools::test()` in R to confirm existing tests still pass. Then create a test ggplot with `scale_x_log10()` and inspect the IR output:
```r
library(ggplot2)
p <- ggplot(mtcars, aes(wt, mpg)) + geom_point() + scale_x_log10()
ir <- as_d3_ir(p)
cat("transform:", ir$scales$x$transform, "\n")
cat("domain:", ir$scales$x$domain, "\n")
cat("breaks:", ir$scales$x$breaks, "\n")
```
Verify: `transform` is "log10", `domain` is the expanded range from panel_params (not hardcoded 5%), and `breaks` are present.

Also test a simple linear plot and verify the domain is different from the old hardcoded 5% approach:
```r
p2 <- ggplot(mtcars, aes(wt, mpg)) + geom_point()
ir2 <- as_d3_ir(p2)
cat("domain:", ir2$scales$x$domain, "\n")
# Should be panel_params range, not just range(wt) +/- 5%
```
  </verify>
  <done>
- get_scale_info() uses panel_params for domain extraction (no hardcoded 5%)
- get_scale_transform() extracts transform name and parameters from scale_obj$trans
- IR output includes `transform`, `base`/`exponent` fields when scale has transformation
- All existing tests pass
- Log scale IR includes transform: "log10" and correct domain
  </done>
</task>

<task type="auto">
  <name>Task 2: Add scale transform test cases</name>
  <files>tests/testthat/test-ir.R</files>
  <action>
Add test cases to the existing `test-ir.R` file that verify the new scale extraction behavior:

1. Test that a basic continuous scale extracts domain from panel_params (not hardcoded):
   - Create `ggplot(mtcars, aes(wt, mpg)) + geom_point()`
   - Extract IR, verify `ir$scales$x$type == "continuous"`
   - Verify domain is not exactly `range(mtcars$wt) * 1.05` (the old hardcoded approach)

2. Test log10 transformation extraction:
   - Create `ggplot(mtcars, aes(wt, mpg)) + geom_point() + scale_x_log10()`
   - Verify `ir$scales$x$transform == "log10"`
   - Verify `ir$scales$x$base == 10`
   - Verify domain values are strictly positive

3. Test sqrt transformation:
   - Create `ggplot(mtcars, aes(wt, mpg)) + geom_point() + scale_x_sqrt()`
   - Verify `ir$scales$x$transform == "sqrt"`

4. Test reverse transformation:
   - Create `ggplot(mtcars, aes(wt, mpg)) + geom_point() + scale_x_reverse()`
   - Verify `ir$scales$x$transform == "reverse"`

5. Test that discrete scales still work correctly:
   - Create `ggplot(mtcars, aes(factor(cyl), mpg)) + geom_point()`
   - Verify `ir$scales$x$type == "categorical"`
   - Verify domain contains the factor levels

6. Test that identity (no transform) produces no transform field:
   - Create standard linear plot
   - Verify `ir$scales$x$transform` is NULL
  </action>
  <verify>
Run `devtools::test()` and confirm all new tests pass. Run `testthat::test_file("tests/testthat/test-ir.R")` for focused output.
  </verify>
  <done>
- 6+ new test cases covering log10, sqrt, reverse, identity transforms
- Test confirms panel_params domain extraction (not hardcoded 5%)
- Test confirms discrete scales still work
- All tests pass
  </done>
</task>

</tasks>

<verification>
1. `devtools::test()` passes all existing and new tests
2. IR output for `scale_x_log10()` plot contains `transform: "log10"` and `base: 10`
3. IR domain values come from panel_params (compare with `b$layout$panel_params[[1]]$x$range`)
4. Bar chart IR has correct expansion (data does not start at axis edge)
</verification>

<success_criteria>
- The hardcoded 5% expansion in get_scale_info() is completely removed
- Scale transformation metadata flows from R to IR JSON
- All test cases pass for log10, sqrt, reverse, and identity transforms
- Discrete scale behavior is unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-scale-system/02-01-SUMMARY.md`
</output>
