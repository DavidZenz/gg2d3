---
phase: 02-core-scale-system
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - inst/htmlwidgets/modules/scales.js
  - inst/htmlwidgets/gg2d3.js
autonomous: true

must_haves:
  truths:
    - "Log-scale axes show correctly spaced ticks (1, 10, 100 evenly spaced in pixel space)"
    - "Reverse scales flip data direction while keeping axis at correct position"
    - "Sqrt and power scales position data points with correct non-linear spacing"
    - "Axis tick labels format correctly for transformed scales (no scientific notation for log)"
  artifacts:
    - path: "inst/htmlwidgets/modules/scales.js"
      provides: "Transform-aware scale factory with proper tick formatting"
      contains: "transform"
    - path: "inst/htmlwidgets/gg2d3.js"
      provides: "Axis rendering that uses custom tick values from IR breaks"
      contains: "tickValues"
  key_links:
    - from: "inst/htmlwidgets/gg2d3.js"
      to: "inst/htmlwidgets/modules/scales.js"
      via: "createScale with transform field"
      pattern: "createScale"
    - from: "inst/htmlwidgets/gg2d3.js"
      to: "IR breaks"
      via: "tickValues from ir.scales.x.breaks"
      pattern: "tickValues.*breaks"
---

<objective>
Update the D3 scale factory to robustly handle transformation fields from the new IR format, and update axis rendering to use IR-provided breaks for tick positions on transformed scales.

Purpose: The scale factory in scales.js already has basic log/sqrt/pow/symlog/reverse support, but it dispatches on `type` first and only falls back to `transform`. After Plan 02-01 updates the IR to include explicit `transform` fields, the factory must prioritize `transform` for continuous scales. Additionally, axis rendering in gg2d3.js currently lets D3 auto-generate tick positions, which produces wrong ticks for transformed scales (D3's log scale generates its own ticks that may not match ggplot2's). The axes must use the pre-computed breaks from the IR.

Output: Updated scales.js with transform-first dispatch, and updated gg2d3.js axis rendering to use IR breaks as tick values.
</objective>

<execution_context>
@/Users/davidzenz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davidzenz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-scale-system/02-RESEARCH.md
@inst/htmlwidgets/modules/scales.js
@inst/htmlwidgets/gg2d3.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor scale factory for transform-first dispatch</name>
  <files>inst/htmlwidgets/modules/scales.js</files>
  <action>
Refactor the `createScale()` function in scales.js to use transform-first dispatch when both `type` and `transform` are present.

Current behavior: checks `type` first via `buildScale(type)`, then falls back to `transform`. This means a descriptor with `{type: "continuous", transform: "log10"}` creates a LINEAR scale because "continuous" matches first.

New behavior:
1. If `transform` is present and is NOT "identity", dispatch on `transform` first.
2. If `transform` is "identity" or absent, dispatch on `type` (existing behavior).
3. Keep all existing scale types and edge case handling intact.

Specific changes to `createScale()`:
- After extracting `type` and `transform` variables (already done), add logic:
  ```javascript
  // Transform takes priority over type for continuous scales
  if (transform && transform !== 'identity') {
    const fromTransform = buildScale(transform);
    if (fromTransform) return fromTransform;
  }
  ```
- Move this BEFORE the `const fromType = buildScale(type)` call.
- Remove the old transform fallback block at the bottom (lines 197-199) since transform is now checked first.

Also add a "reverse" case to the `buildScale` switch statement if not already handling it properly. Currently "reverse" is not in the switch. Add:
```javascript
case 'reverse':
  // Reverse flips the domain direction; still a linear scale
  return d3.scaleLinear().domain([...numericDomain].reverse()).range(rng);
```

Ensure that the `buildScale` switch covers these transform names that the R side will emit:
- "log" -> d3.scaleLog() with base e
- "log10" -> d3.scaleLog().base(10)
- "log2" -> d3.scaleLog().base(2)
- "sqrt" -> d3.scaleSqrt()
- "pow" / "power" -> d3.scalePow()
- "symlog" -> d3.scaleSymlog()
- "reverse" -> d3.scaleLinear() with reversed domain

Do NOT change the `convertColor` function or the export structure.
  </action>
  <verify>
Open the modified scales.js and verify:
1. Transform dispatch happens before type dispatch
2. All transform cases are in the switch statement including "reverse"
3. Export structure unchanged (window.gg2d3.scales still has createScale and convertColor)

Test by creating a minimal HTML file that loads D3 + the module and tests:
```javascript
var desc = {type: "continuous", transform: "log10", domain: [1, 100], base: 10};
var scale = window.gg2d3.scales.createScale(desc, [0, 400]);
console.log(scale(1));   // should be 0
console.log(scale(10));  // should be 200
console.log(scale(100)); // should be 400
```
  </verify>
  <done>
- Transform-first dispatch: {type: "continuous", transform: "log10"} creates log scale, not linear
- All 7 transform types handled: log, log10, log2, sqrt, pow, symlog, reverse
- Reverse creates linear scale with flipped domain
- Existing type-only descriptors (no transform field) still work unchanged
  </done>
</task>

<task type="auto">
  <name>Task 2: Update axis rendering to use IR breaks as tick values</name>
  <files>inst/htmlwidgets/gg2d3.js</files>
  <action>
Update the axis rendering section in gg2d3.js (approximately lines 117-141) to use the pre-computed breaks from the IR as tick values instead of letting D3 auto-generate ticks.

Why: D3's auto-generated ticks for log scales produce ticks at [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 20, 30, ...] which is too dense and doesn't match ggplot2's break positions. The IR already carries `ir.scales.x.breaks` and `ir.scales.y.breaks` computed by ggplot2.

Changes to axis creation (non-flip path, lines 127-141):
1. When creating `d3.axisBottom(xScale)`, chain `.tickValues(xBreaks)` where xBreaks comes from `ir.scales.x.breaks` (filter to only values within the scale domain).
2. When creating `d3.axisLeft(yScale)`, chain `.tickValues(yBreaks)` where yBreaks comes from `ir.scales.y.breaks`.
3. For categorical/band scales, do NOT set tickValues (D3 band scale generates ticks from domain automatically).
4. Only set tickValues when breaks are available AND the scale is continuous (check: `typeof xScale.bandwidth !== "function"`).

For the flip path (lines 122-126):
- Apply the same tickValues logic but with axes swapped (xScale gets yBreaks via axisLeft, yScale gets xBreaks via axisBottom).

Also add tick formatting for transformed scales:
- If `ir.scales.x.transform` is "log10" or "log2" or "log", use `.tickFormat(d3.format(".4~g"))` to avoid scientific notation and show clean numbers like "1", "10", "100" instead of "1e+0", "1e+1", "1e+2".
- For other transforms (sqrt, pow, reverse), use `.tickFormat(d3.format(".4~g"))` as well for clean numbers.

Extract break values near the top of the axis section:
```javascript
const xBreaks = ir.scales && ir.scales.x && ir.scales.x.breaks;
const yBreaks = ir.scales && ir.scales.y && ir.scales.y.breaks;
const xTransform = ir.scales && ir.scales.x && ir.scales.x.transform;
const yTransform = ir.scales && ir.scales.y && ir.scales.y.transform;
```

Note: The breaks/transform variables for grid drawing are already extracted earlier in the file. Reuse or reference those. Avoid duplicating the extraction.
  </action>
  <verify>
Verify in the code that:
1. axisBottom and axisLeft calls chain .tickValues() when breaks are available
2. Categorical scales (bandwidth function check) skip tickValues
3. Tick format applied for transformed scales

Then test with R:
```r
library(ggplot2)
p <- ggplot(mtcars, aes(wt, mpg)) + geom_point() + scale_x_log10()
gg2d3(p)
```
Open in browser and verify:
- X-axis ticks appear at ggplot2's break positions (not D3's default log ticks)
- Tick labels show clean numbers (not scientific notation)
  </verify>
  <done>
- Axis ticks positioned at IR-provided break values for continuous scales
- Categorical scales use D3's default tick generation (unchanged)
- Log/sqrt/pow scales show clean tick label formatting
- Flip path handles break assignment correctly
- No duplicate variable declarations
  </done>
</task>

</tasks>

<verification>
1. A log-scale ggplot renders in gg2d3 with correctly spaced, ggplot2-matching tick positions
2. A reverse-scale plot shows data in reversed direction with correct axis labels
3. A sqrt-scale plot shows non-linear tick spacing matching ggplot2
4. Standard linear plots continue to render identically to pre-Phase-2 output
5. Categorical/bar plots continue to render with correct band scale behavior
</verification>

<success_criteria>
- Transform-first dispatch in scale factory (log10 descriptor creates log scale, not linear)
- Axis ticks use IR breaks instead of D3 auto-generated ticks
- Clean tick label formatting for all transformed scales
- No regressions in existing linear and categorical scale rendering
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-scale-system/02-02-SUMMARY.md`
</output>
