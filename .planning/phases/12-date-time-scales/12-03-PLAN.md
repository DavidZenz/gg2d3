---
phase: 12-date-time-scales
plan: 03
type: execute
wave: 3
depends_on: ["12-02"]
files_modified:
  - tests/testthat/test-date-scales.R
autonomous: true

must_haves:
  truths:
    - "Unit tests verify Date scale IR has millisecond domain, breaks, transform, and format"
    - "Unit tests verify POSIXct scale IR has millisecond domain, breaks, transform, timezone, and format"
    - "Unit tests verify temporal data on y-axis and with coord_flip"
    - "Unit tests verify all geom types work with date x-axis"
    - "All existing tests still pass (no regressions)"
  artifacts:
    - path: "tests/testthat/test-date-scales.R"
      provides: "Comprehensive temporal scale test coverage"
      contains: "test_that"
  key_links:
    - from: "tests/testthat/test-date-scales.R"
      to: "R/as_d3_ir.R"
      via: "as_d3_ir() calls with temporal data"
      pattern: "as_d3_ir"
---

<objective>
Create comprehensive R-side unit tests and visual verification for temporal scale support.

Purpose: Verify that all temporal scale features work correctly: millisecond conversion, format extraction, timezone handling, coord_flip, and geom compatibility. Visual verification confirms D3 rendering produces correct output.

Output: New test file `tests/testthat/test-date-scales.R` with full temporal scale coverage. Visual test HTML for manual inspection.
</objective>

<execution_context>
@/Users/davidzenz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davidzenz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/12-date-time-scales/12-RESEARCH.md
@.planning/phases/12-date-time-scales/12-01-SUMMARY.md
@.planning/phases/12-date-time-scales/12-02-SUMMARY.md
@tests/testthat/test-ir.R
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create unit tests for temporal scale IR extraction</name>
  <files>tests/testthat/test-date-scales.R</files>
  <action>
Create a new test file `tests/testthat/test-date-scales.R` with comprehensive tests:

**1. Date scale basics:**
```r
test_that("Date x-axis produces temporal scale with ms domain", {
  df <- data.frame(date = as.Date(c('2024-01-01', '2024-06-01', '2024-12-31')), y = c(1, 5, 3))
  p <- ggplot(df, aes(date, y)) + geom_point()
  ir <- as_d3_ir(p)

  expect_equal(ir$scales$x$type, "continuous")
  expect_equal(ir$scales$x$transform, "date")
  # Domain should be in milliseconds (Date epoch = days * 86400000)
  expect_true(all(ir$scales$x$domain > 1e12))
  # Breaks should also be in ms
  expect_true(all(ir$scales$x$breaks > 1e12))
  # Data values should be in ms
  expect_true(ir$layers[[1]]$data[[1]]$x > 1e12)
})
```

**2. POSIXct scale basics:**
```r
test_that("POSIXct x-axis produces temporal scale with ms domain and timezone", {
  df <- data.frame(
    time = as.POSIXct(c('2024-01-01 10:00', '2024-01-01 14:00'), tz = 'UTC'),
    y = c(1, 2)
  )
  p <- ggplot(df, aes(time, y)) + geom_point()
  ir <- as_d3_ir(p)

  expect_equal(ir$scales$x$type, "continuous")
  expect_equal(ir$scales$x$transform, "time")
  expect_true(all(ir$scales$x$domain > 1e12))
  expect_true(all(ir$scales$x$breaks > 1e12))
})
```

**3. Timezone extraction:**
```r
test_that("timezone extracted from scale_x_datetime", {
  df <- data.frame(
    time = as.POSIXct(c('2024-01-01 10:00', '2024-01-01 14:00'), tz = 'America/New_York'),
    y = c(1, 2)
  )
  p <- ggplot(df, aes(time, y)) + geom_point() +
    scale_x_datetime(timezone = "America/New_York")
  ir <- as_d3_ir(p)

  expect_equal(ir$scales$x$timezone, "America/New_York")
})
```

**4. Format pattern extraction:**
```r
test_that("date_labels format pattern extracted", {
  df <- data.frame(date = as.Date(c('2024-01-01', '2024-06-01')), y = c(1, 2))
  p <- ggplot(df, aes(date, y)) + geom_point() +
    scale_x_date(date_labels = "%Y-%m-%d")
  ir <- as_d3_ir(p)

  expect_equal(ir$scales$x$format, "%Y-%m-%d")
})

test_that("default date scale has NULL format (auto-format)", {
  df <- data.frame(date = as.Date(c('2024-01-01', '2024-06-01')), y = c(1, 2))
  p <- ggplot(df, aes(date, y)) + geom_point()
  ir <- as_d3_ir(p)

  # Without explicit date_labels, format should be NULL
  expect_null(ir$scales$x$format)
})
```

**5. Date on y-axis:**
```r
test_that("Date on y-axis works", {
  df <- data.frame(x = c(1, 2, 3), date = as.Date(c('2024-01-01', '2024-06-01', '2024-12-31')))
  p <- ggplot(df, aes(x, date)) + geom_point()
  ir <- as_d3_ir(p)

  expect_equal(ir$scales$y$transform, "date")
  expect_true(all(ir$scales$y$domain > 1e12))
})
```

**6. coord_flip with temporal axis:**
```r
test_that("coord_flip with Date x-axis works", {
  df <- data.frame(date = as.Date(c('2024-01-01', '2024-06-01', '2024-12-31')), y = c(1, 5, 3))
  p <- ggplot(df, aes(date, y)) + geom_point() + coord_flip()
  ir <- as_d3_ir(p)

  # After coord_flip, original x (date) should still be on x scale in IR
  # (R-side un-swaps panel_params)
  expect_equal(ir$scales$x$transform, "date")
  expect_true(all(ir$scales$x$domain > 1e12))
})
```

**7. Multiple geoms with date axis:**
```r
test_that("geom_line with Date x-axis works", {
  df <- data.frame(date = as.Date('2024-01-01') + 0:11 * 30, y = cumsum(rnorm(12)))
  p <- ggplot(df, aes(date, y)) + geom_line() + geom_point()
  ir <- as_d3_ir(p)

  expect_equal(ir$scales$x$transform, "date")
  expect_length(ir$layers, 2)
  # Both layers should have ms timestamps for x
  expect_true(ir$layers[[1]]$data[[1]]$x > 1e12)
  expect_true(ir$layers[[2]]$data[[1]]$x > 1e12)
})

test_that("geom_col with Date x-axis works", {
  df <- data.frame(date = as.Date(c('2024-01-01', '2024-02-01', '2024-03-01')), y = c(3, 5, 2))
  p <- ggplot(df, aes(date, y)) + geom_col()
  ir <- as_d3_ir(p)

  expect_equal(ir$scales$x$transform, "date")
  # Bar data should have xmin/xmax in ms
  expect_true(ir$layers[[1]]$data[[1]]$xmin > 1e12)
  expect_true(ir$layers[[1]]$data[[1]]$xmax > 1e12)
})
```

**8. Pre-formatted labels fallback:**
```r
test_that("pre-formatted labels included for temporal scales", {
  df <- data.frame(date = as.Date(c('2024-01-01', '2024-06-01', '2024-12-31')), y = c(1, 5, 3))
  p <- ggplot(df, aes(date, y)) + geom_point()
  ir <- as_d3_ir(p)

  # Labels should be character strings (pre-formatted by ggplot2)
  expect_true(!is.null(ir$scales$x$labels))
  expect_true(is.character(ir$scales$x$labels))
  expect_true(length(ir$scales$x$labels) > 0)
})
```

**9. Non-temporal scales unaffected:**
```r
test_that("numeric scales unchanged by temporal support", {
  df <- data.frame(x = c(1, 2, 3), y = c(4, 5, 6))
  p <- ggplot(df, aes(x, y)) + geom_point()
  ir <- as_d3_ir(p)

  expect_null(ir$scales$x$format)
  expect_null(ir$scales$x$timezone)
  expect_null(ir$scales$x$labels)
})
```

Run all tests at the end to confirm no regressions in the full test suite.
  </action>
  <verify>
```r
# Run just the new test file
testthat::test_file("tests/testthat/test-date-scales.R")

# Run full test suite to confirm no regressions
devtools::test()
```
All tests should pass. Report total test count (should be ~500+ with new tests).
  </verify>
  <done>
New test file with 9+ test cases covering: Date and POSIXct IR extraction, millisecond conversion, format pattern extraction, timezone handling, y-axis dates, coord_flip, multiple geoms, pre-formatted labels, and regression check for non-temporal scales. Full test suite passes with no regressions.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create visual verification HTML for temporal scale rendering</name>
  <files>tests/testthat/test-date-scales.R</files>
  <action>
Add a visual test at the end of test-date-scales.R (or create a separate visual test script) that generates a comprehensive HTML file showing temporal scales in various configurations:

```r
test_that("visual test: date/time scales render correctly", {
  skip_on_ci()
  skip_if_not(interactive() || identical(Sys.getenv("GG2D3_VISUAL_TESTS"), "true"))

  dir.create("../../test_output", showWarnings = FALSE, recursive = TRUE)

  # Test 1: Date x-axis with points and line
  df1 <- data.frame(
    date = as.Date('2024-01-01') + seq(0, 365, by = 30),
    value = cumsum(rnorm(13))
  )
  p1 <- ggplot(df1, aes(date, value)) + geom_line() + geom_point() +
    scale_x_date(date_labels = "%b %Y") +
    ggtitle("Date X-Axis: Points + Line")

  # Test 2: POSIXct with hourly data
  df2 <- data.frame(
    time = as.POSIXct('2024-06-15 00:00', tz = 'UTC') + (0:23) * 3600,
    temp = 20 + 10 * sin(seq(0, 2*pi, length.out = 24)) + rnorm(24, sd = 1)
  )
  p2 <- ggplot(df2, aes(time, temp)) + geom_line() + geom_point() +
    scale_x_datetime(date_labels = "%H:%M") +
    ggtitle("POSIXct X-Axis: Hourly Data")

  # Test 3: Date on y-axis
  df3 <- data.frame(
    category = c("A", "B", "C"),
    date = as.Date(c('2024-01-15', '2024-06-20', '2024-11-10'))
  )
  p3 <- ggplot(df3, aes(category, date)) + geom_point(size = 3) +
    ggtitle("Date Y-Axis")

  # Test 4: coord_flip with date axis
  p4 <- ggplot(df1, aes(date, value)) + geom_point() + coord_flip() +
    ggtitle("Date X-Axis + coord_flip")

  # Test 5: Bar chart with date axis
  df5 <- data.frame(
    month = as.Date(paste0('2024-', 1:12, '-01')),
    sales = sample(50:200, 12)
  )
  p5 <- ggplot(df5, aes(month, sales)) + geom_col() +
    scale_x_date(date_labels = "%b") +
    ggtitle("Date X-Axis: Bar Chart")

  # Save each as widget, then combine into single HTML
  widgets <- list(
    gg2d3(p1) |> d3_tooltip(),
    gg2d3(p2) |> d3_tooltip(),
    gg2d3(p3) |> d3_tooltip(),
    gg2d3(p4) |> d3_tooltip(),
    gg2d3(p5) |> d3_tooltip()
  )

  # Save individual test
  htmlwidgets::saveWidget(widgets[[1]], "../../test_output/visual_test_date_scales.html", selfcontained = FALSE)

  expect_true(file.exists("../../test_output/visual_test_date_scales.html"))
})
```

The visual test generates plots that can be manually inspected to verify:
- Date labels are human-readable (not numeric timestamps)
- Points position correctly along the time axis
- Tooltip shows formatted date values
- coord_flip works with temporal axes
- Bar charts align with date axis positions
  </action>
  <verify>
```r
# Generate visual test output
Sys.setenv(GG2D3_VISUAL_TESTS = "true")
testthat::test_file("tests/testthat/test-date-scales.R")
```
Verify `test_output/visual_test_date_scales.html` exists and renders correctly in a browser.
  </verify>
  <done>
Visual test HTML generated showing 5 temporal scale scenarios. All unit tests pass. Visual output can be manually inspected for rendering correctness.
  </done>
</task>

</tasks>

<verification>
1. `testthat::test_file("tests/testthat/test-date-scales.R")` — all tests pass
2. `devtools::test()` — full suite passes, no regressions
3. Visual test HTML renders temporal plots correctly
4. Total test count increased by ~10+ tests
</verification>

<success_criteria>
- All temporal scale unit tests pass
- No regressions in existing test suite
- Visual verification HTML shows correctly formatted date/time axes
- Test coverage includes Date, POSIXct, format patterns, timezone, coord_flip, multiple geoms
</success_criteria>

<output>
After completion, create `.planning/phases/12-date-time-scales/12-03-SUMMARY.md`
</output>
