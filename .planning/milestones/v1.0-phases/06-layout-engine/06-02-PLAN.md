---
phase: 06-layout-engine
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - inst/htmlwidgets/gg2d3.js
  - inst/htmlwidgets/modules/theme.js
autonomous: true
user_setup: []

must_haves:
  truths:
    - "gg2d3.js calls calculateLayout() once at start of draw() and uses returned positions for ALL component placement"
    - "No hardcoded padding offsets remain in gg2d3.js (no +30, +20, +40, +50 magic numbers)"
    - "Title, subtitle, and caption render at layout-computed positions"
    - "Axis titles render at layout-computed positions (no pad.left - 35 magic numbers)"
    - "Panel background, grid, clip path, and axes use layout.panel dimensions"
    - "coord_fixed centering uses layout.panel.offsetX/offsetY"
    - "All existing geoms still render correctly within the layout-positioned panel"
    - "calculatePadding() in theme.js marked deprecated but still present for safety"
  artifacts:
    - path: "inst/htmlwidgets/gg2d3.js"
      provides: "Refactored draw() using calculateLayout() as single source of truth"
      contains: "calculateLayout"
    - path: "inst/htmlwidgets/modules/theme.js"
      provides: "calculatePadding marked deprecated"
  key_links:
    - from: "inst/htmlwidgets/gg2d3.js"
      to: "inst/htmlwidgets/modules/layout.js"
      via: "Calls calculateLayout() and destructures LayoutResult"
      pattern: "window\\.gg2d3\\.layout\\.calculateLayout"
    - from: "inst/htmlwidgets/gg2d3.js"
      to: "IR JSON from R"
      via: "Extracts titles, axes.tickLabels, legend.position, coord into layout config"
      pattern: "ir\\.axes.*tickLabels|ir\\.legend\\.position|ir\\.subtitle|ir\\.caption"
---

<objective>
Refactor gg2d3.js to use the layout engine as its single source of truth for all component positioning.

Purpose: Replace all ad-hoc layout calculations in draw() with positions from calculateLayout(). This eliminates magic numbers, hardcoded padding offsets, and scattered position computations. After this plan, every component (panel, axes, titles, clip path) gets its position from the LayoutResult object.

Output: Refactored gg2d3.js that calls calculateLayout() once and passes positions to all rendering code. Deprecated calculatePadding() in theme.js.
</objective>

<execution_context>
@/Users/davidzenz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davidzenz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-layout-engine/06-RESEARCH.md
@.planning/phases/06-layout-engine/06-01-SUMMARY.md
@inst/htmlwidgets/gg2d3.js
@inst/htmlwidgets/modules/layout.js
@inst/htmlwidgets/modules/theme.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor gg2d3.js draw() to consume LayoutResult</name>
  <files>inst/htmlwidgets/gg2d3.js</files>
  <action>
Rewrite the `draw(ir, elW, elH)` function in gg2d3.js to use `calculateLayout()` as the single source of truth. The refactoring follows this structure:

**Step 1: Build layout config from IR and call calculateLayout()**

Replace lines 48-79 (the current innerW/innerH/pad/availW/availH/panel computation block) with:

```javascript
const innerW = ir.width || elW || 640;
const innerH = ir.height || elH || 400;

const convertColor = window.gg2d3.scales.convertColor;
const theme = window.gg2d3.theme.createTheme(ir.theme);
const flip = !!(ir.coord && ir.coord.flip);

// Extract data ranges for coord_fixed
var xDataRange = 0, yDataRange = 0;
if (ir.coord && ir.coord.ratio) {
  var xs = ir.scales && ir.scales.x;
  var ys = ir.scales && ir.scales.y;
  if (xs && xs.domain && xs.domain.length === 2) {
    xDataRange = Math.abs(xs.domain[1] - xs.domain[0]);
  }
  if (ys && ys.domain && ys.domain.length === 2) {
    yDataRange = Math.abs(ys.domain[1] - ys.domain[0]);
  }
}

// Build layout configuration from IR
const layoutConfig = {
  width: innerW,
  height: innerH,
  theme: theme,
  titles: {
    title: ir.title || null,
    subtitle: ir.subtitle || null,
    caption: ir.caption || null
  },
  axes: {
    x: {
      label: (ir.axes && ir.axes.x && ir.axes.x.label) || null,
      tickLabels: (ir.axes && ir.axes.x && ir.axes.x.tickLabels) || []
    },
    y: {
      label: (ir.axes && ir.axes.y && ir.axes.y.label) || null,
      tickLabels: (ir.axes && ir.axes.y && ir.axes.y.tickLabels) || []
    },
    x2: (ir.axes && ir.axes.x2) || null,
    y2: (ir.axes && ir.axes.y2) || null
  },
  legend: {
    position: (ir.legend && ir.legend.position) || "none",
    width: 0,   // Phase 7 will provide actual dimensions
    height: 0
  },
  coord: {
    type: (ir.coord && ir.coord.type) || "cartesian",
    flip: flip,
    ratio: (ir.coord && ir.coord.ratio) || null,
    xRange: xDataRange,
    yRange: yDataRange
  }
};

const layout = window.gg2d3.layout.calculateLayout(layoutConfig);
const w = layout.panel.w;
const h = layout.panel.h;
```

**Step 2: Remove calculatePanelSize() from gg2d3.js**

Delete the `calculatePanelSize()` function (lines 13-42). This logic is now inside the layout engine. The `layout.panel` already has the coord_fixed-constrained dimensions and offsets.

**Step 3: Update SVG creation and plot background**

Keep the root SVG creation but use layout dimensions:
```javascript
const root = d3.select(el).append("svg").attr("width", innerW).attr("height", innerH);
```

Plot background rendering stays the same (fills full SVG).

**Step 4: Update clip-path to use layout.clipId**

Replace the clipId generation and clip-path rect:
```javascript
const clipId = layout.clipId;
root.append("defs").append("clipPath").attr("id", clipId)
  .append("rect").attr("width", w).attr("height", h);
```

**Step 5: Update main group transform to use layout.panel position**

Replace `translate(${pad.left + panel.offsetX},${pad.top + panel.offsetY})` with:
```javascript
const g = root.append("g").attr("transform",
  `translate(${layout.panel.x},${layout.panel.y})`);
```

**Step 6: Panel background, grid, and scales remain same**

Panel background uses w and h from layout. Grid rendering uses w and h. Scale creation uses [0, w] and [h, 0] as before. These are unchanged since they operate relative to the panel group.

**Step 7: Update title rendering**

Replace the current title rendering (around line 147-157) with layout-positioned version:
```javascript
// Title
const titleSpec = theme.get("text.title");
if (ir.title && layout.title.visible) {
  root.append("text")
    .attr("x", layout.title.x)
    .attr("y", layout.title.y)
    .attr("text-anchor", "middle")
    .style("font-size", titleSpec && titleSpec.size ? `${titleSpec.size}px` : "13.2px")
    .style("fill", convertColor(titleSpec && titleSpec.colour) || "black")
    .style("font-weight", titleSpec && titleSpec.face === "bold" ? "bold" : "normal")
    .style("font-family", titleSpec && titleSpec.family || "sans-serif")
    .text(ir.title);
}

// Subtitle
const subtitleSpec = theme.get("text.subtitle");
if (ir.subtitle && layout.subtitle.visible) {
  root.append("text")
    .attr("x", layout.subtitle.x)
    .attr("y", layout.subtitle.y)
    .attr("text-anchor", "middle")
    .style("font-size", subtitleSpec && subtitleSpec.size ? `${subtitleSpec.size}px` : "11px")
    .style("fill", convertColor(subtitleSpec && subtitleSpec.colour) || "#4D4D4D")
    .style("font-family", subtitleSpec && subtitleSpec.family || "sans-serif")
    .text(ir.subtitle);
}

// Caption
const captionSpec = theme.get("text.caption");
if (ir.caption && layout.caption.visible) {
  root.append("text")
    .attr("x", layout.caption.x)
    .attr("y", layout.caption.y)
    .attr("text-anchor", "middle")
    .style("font-size", captionSpec && captionSpec.size ? `${captionSpec.size}px` : "8.8px")
    .style("fill", convertColor(captionSpec && captionSpec.colour) || "#4D4D4D")
    .style("font-family", captionSpec && captionSpec.family || "sans-serif")
    .text(ir.caption);
}
```

**Step 8: Update axis title positions**

Replace the x-axis title positioning (around lines 271-280) with layout-computed position:
```javascript
const xTitle = ir.axes && ir.axes.x && ir.axes.x.label;
if (xTitle && layout.axisLabels.x.visible) {
  root.append("text")
    .attr("x", layout.axisLabels.x.x)
    .attr("y", layout.axisLabels.x.y)
    .attr("text-anchor", "middle")
    .style("font-size", axisTitleSpec && axisTitleSpec.size ? `${axisTitleSpec.size}px` : "11px")
    .style("fill", convertColor(axisTitleSpec && axisTitleSpec.colour) || "black")
    .style("font-family", axisTitleSpec && axisTitleSpec.family || "sans-serif")
    .text(xTitle);
}
```

Replace the y-axis title positioning (around lines 282-294) — remove the magic `pad.left + panel.offsetX - 35`:
```javascript
const yTitle = ir.axes && ir.axes.y && ir.axes.y.label;
if (yTitle && layout.axisLabels.y.visible) {
  root.append("text")
    .attr("x", layout.axisLabels.y.x)
    .attr("y", layout.axisLabels.y.y)
    .attr("text-anchor", "middle")
    .attr("transform", `rotate(${layout.axisLabels.y.rotation}, ${layout.axisLabels.y.x}, ${layout.axisLabels.y.y})`)
    .style("font-size", axisTitleSpec && axisTitleSpec.size ? `${axisTitleSpec.size}px` : "11px")
    .style("fill", convertColor(axisTitleSpec && axisTitleSpec.colour) || "black")
    .style("font-family", axisTitleSpec && axisTitleSpec.family || "sans-serif")
    .text(yTitle);
}
```

**Step 9: Verify no references to `pad` variable remain**

After refactoring, the `pad` variable (from calculatePadding) should not exist anywhere in draw(). Search and confirm no references to `pad.left`, `pad.top`, `pad.right`, `pad.bottom`, or `calculatePadding`. The `panel.offsetX`/`panel.offsetY` references should also be replaced with `layout.panel.x`/`layout.panel.y`.

**IMPORTANT CAUTION:** The `w` and `h` variables used throughout for scale creation, grid drawing, and geom rendering are now derived from `layout.panel.w` and `layout.panel.h`. These will produce DIFFERENT values than the old padding-based calculation. This is expected and correct — the layout engine computes content-aware dimensions rather than hardcoded offsets. Existing visual output will shift slightly (improved positioning, not regression).

**Note on theme.get("text.subtitle") and theme.get("text.caption"):** These may return null from the current theme module since DEFAULT_THEME doesn't include subtitle/caption entries. The rendering code handles this gracefully with fallback styles. In Task 2, we'll update DEFAULT_THEME to include these.
  </action>
  <verify>
```bash
# Check no references to calculatePadding in gg2d3.js
grep -c "calculatePadding" inst/htmlwidgets/gg2d3.js  # should be 0

# Check calculateLayout is called
grep -c "calculateLayout" inst/htmlwidgets/gg2d3.js  # should be >= 1

# Check no magic padding numbers remain
grep -c "pad\\.top\|pad\\.left\|pad\\.right\|pad\\.bottom" inst/htmlwidgets/gg2d3.js  # should be 0

# Check no magic offset numbers
grep -c "pad.left - 35\|pad.top \* 0.6" inst/htmlwidgets/gg2d3.js  # should be 0

# Check all layout.* references exist
grep -c "layout\\.panel\|layout\\.title\|layout\\.axisLabels" inst/htmlwidgets/gg2d3.js

# Load and verify R package still works
Rscript -e "devtools::load_all(); devtools::test()"
```
  </verify>
  <done>gg2d3.js draw() calls calculateLayout() once and uses LayoutResult for all positioning. No magic numbers or hardcoded offsets remain. calculatePanelSize() removed from gg2d3.js.</done>
</task>

<task type="auto">
  <name>Task 2: Update theme.js defaults and deprecate calculatePadding</name>
  <files>inst/htmlwidgets/modules/theme.js</files>
  <action>
Make two changes to theme.js:

**1. Add subtitle and caption to DEFAULT_THEME:**

In the DEFAULT_THEME object (around line 12), update the `text` section to include subtitle and caption entries matching ggplot2 theme_gray defaults:

```javascript
text: {
  title: { type: "text", colour: "black", size: 13.2 },
  subtitle: { type: "text", colour: "#4D4D4D", size: 11 },
  caption: { type: "text", colour: "#4D4D4D", size: 8.8 }
}
```

These sizes match ggplot2's defaults:
- plot.title: rel(1.2) * base_size = 1.2 * 11 = 13.2pt
- plot.subtitle: base_size = 11pt
- plot.caption: rel(0.8) * base_size = 0.8 * 11 = 8.8pt

**2. Add deprecation notice to calculatePadding:**

Add a console.warn on first call to calculatePadding:

```javascript
let _padDeprecated = false;
function calculatePadding(themeAccessor, irPadding) {
  if (!_padDeprecated) {
    console.warn('gg2d3: calculatePadding() is deprecated. Use window.gg2d3.layout.calculateLayout() instead.');
    _padDeprecated = true;
  }
  // ... existing implementation unchanged
}
```

Keep the function body unchanged for backward compatibility — other code or user extensions may still call it. The deprecation warning alerts developers to migrate.

Do NOT remove calculatePadding from exports. It must still be accessible at `window.gg2d3.theme.calculatePadding`.
  </action>
  <verify>
```bash
# Verify subtitle and caption in DEFAULT_THEME
grep "subtitle" inst/htmlwidgets/modules/theme.js
grep "caption" inst/htmlwidgets/modules/theme.js

# Verify deprecation warning exists
grep "deprecated" inst/htmlwidgets/modules/theme.js

# Verify calculatePadding still exported
grep "calculatePadding" inst/htmlwidgets/modules/theme.js
```
  </verify>
  <done>DEFAULT_THEME includes subtitle and caption entries. calculatePadding() has deprecation warning but remains functional.</done>
</task>

</tasks>

<verification>
1. `devtools::load_all()` succeeds and `devtools::test()` passes all existing tests
2. gg2d3.js has zero references to `calculatePadding`, `pad.left`, `pad.top * 0.6`, or `pad.left - 35`
3. gg2d3.js calls `calculateLayout()` exactly once in draw()
4. All positions (title, subtitle, caption, axis titles, panel group transform) derive from layout object
5. calculatePanelSize() no longer exists in gg2d3.js (moved to layout engine)
6. theme.js DEFAULT_THEME includes subtitle and caption
7. Generating a simple plot produces visible output (not broken)
</verification>

<success_criteria>
- draw() function uses calculateLayout() as single source of truth for ALL component positioning
- No hardcoded padding offsets or magic numbers remain in gg2d3.js
- Subtitle and caption render at layout-computed positions
- coord_fixed continues to work (panel constrains and centers)
- All geoms render within the layout-positioned panel
- Existing R tests pass without modification
</success_criteria>

<output>
After completion, create `.planning/phases/06-layout-engine/06-02-SUMMARY.md`
</output>
