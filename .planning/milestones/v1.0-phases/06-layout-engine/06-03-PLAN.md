---
phase: 06-layout-engine
plan: 03
type: execute
wave: 3
depends_on: ["06-02"]
files_modified:
  - tests/testthat/test-layout.R
autonomous: false
user_setup: []

must_haves:
  truths:
    - "IR layout metadata (tickLabels, subtitle, caption, legend.position) extracts correctly for various plot types"
    - "Layout engine produces reasonable panel dimensions (not negative, not zero, within widget bounds)"
    - "Plots with titles, subtitles, captions, and axis labels render with correct positioning"
    - "coord_fixed plots maintain aspect ratio with layout engine"
    - "Existing geom plots (point, line, bar, boxplot, etc.) render correctly after layout refactor"
    - "Resize behavior works correctly with layout engine"
  artifacts:
    - path: "tests/testthat/test-layout.R"
      provides: "Unit tests for IR layout metadata extraction"
      min_lines: 50
  key_links:
    - from: "tests/testthat/test-layout.R"
      to: "R/as_d3_ir.R"
      via: "Tests call as_d3_ir() and check layout metadata fields"
      pattern: "as_d3_ir.*tickLabels|legend.*position"
---

<objective>
Add unit tests for layout metadata extraction and perform visual verification of the layout engine integration.

Purpose: Verify that the R-side IR extraction produces correct layout metadata and that the JS layout engine integration doesn't break existing rendering. Test across multiple plot types: basic scatter, titled plots, coord_fixed, coord_flip, bar charts with categorical axes, and plots with long axis labels.

Output: Test file for layout metadata, visual confirmation that plots render correctly.
</objective>

<execution_context>
@/Users/davidzenz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davidzenz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-layout-engine/06-RESEARCH.md
@.planning/phases/06-layout-engine/06-01-SUMMARY.md
@.planning/phases/06-layout-engine/06-02-SUMMARY.md
@R/as_d3_ir.R
@tests/testthat/test-ir.R
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create unit tests for IR layout metadata extraction</name>
  <files>tests/testthat/test-layout.R</files>
  <action>
Create `tests/testthat/test-layout.R` with tests covering the new IR fields added in Plan 06-01. Follow the existing test patterns in `test-ir.R` and `test-geoms-phase4.R`.

**Test cases:**

1. **test "IR contains x-axis tick labels for continuous scale"**
   - Create: `ggplot(mtcars, aes(wt, mpg)) + geom_point()`
   - Assert: `ir$axes$x$tickLabels` is a character vector with length > 0
   - Assert: all values are non-NA character strings

2. **test "IR contains y-axis tick labels for continuous scale"**
   - Same plot as above
   - Assert: `ir$axes$y$tickLabels` is a character vector with length > 0

3. **test "IR contains tick labels for categorical scale"**
   - Create: `ggplot(mtcars, aes(factor(cyl), mpg)) + geom_boxplot()`
   - Assert: `ir$axes$x$tickLabels` contains "4", "6", "8"

4. **test "IR contains subtitle and caption"**
   - Create: `ggplot(mtcars, aes(wt, mpg)) + geom_point() + labs(title = "Title", subtitle = "Subtitle", caption = "Caption")`
   - Assert: `ir$subtitle == "Subtitle"`
   - Assert: `ir$caption == "Caption"`

5. **test "IR subtitle and caption default to empty string"**
   - Create: `ggplot(mtcars, aes(wt, mpg)) + geom_point()`
   - Assert: `ir$subtitle == ""`
   - Assert: `ir$caption == ""`

6. **test "IR legend position defaults to right"**
   - Create: `ggplot(mtcars, aes(wt, mpg)) + geom_point()`
   - Assert: `ir$legend$position == "right"`

7. **test "IR legend position extracted from theme"**
   - Create: `ggplot(mtcars, aes(wt, mpg)) + geom_point() + theme(legend.position = "bottom")`
   - Assert: `ir$legend$position == "bottom"`

8. **test "IR has no secondary axis by default"**
   - Create: `ggplot(mtcars, aes(wt, mpg)) + geom_point()`
   - Assert: `is.null(ir$axes$x2)`
   - Assert: `is.null(ir$axes$y2)`

9. **test "IR detects secondary y axis"**
   - Create: `ggplot(mtcars, aes(wt, mpg)) + geom_point() + scale_y_continuous(sec.axis = sec_axis(~. * 1.6, name = "km/l"))`
   - Assert: `ir$axes$y2$enabled == TRUE`
   - Note: Wrap in tryCatch in case secondary axis extraction has issues -- skip test with `skip()` if error occurs

10. **test "IR tick labels survive coord_flip"**
    - Create: `ggplot(mtcars, aes(factor(cyl), mpg)) + geom_boxplot() + coord_flip()`
    - Assert: `ir$axes$x$tickLabels` is a character vector with length > 0
    - Assert: `ir$axes$y$tickLabels` is a character vector with length > 0

All tests use `test_that()` blocks. Load ggplot2 at the top of the file. Each test creates a plot object `p`, calls `ir <- as_d3_ir(p)`, and checks the relevant fields.

Use `expect_true()`, `expect_equal()`, `expect_type()`, `expect_length()`, and `expect_null()` assertions as appropriate.
  </action>
  <verify>
```bash
Rscript -e "testthat::test_file('tests/testthat/test-layout.R')"
```
All tests pass.
  </verify>
  <done>test-layout.R has 10 test cases covering tick labels (continuous/categorical/flip), subtitle/caption, legend position, and secondary axis detection. All tests pass.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Visual verification of layout engine integration</name>
  <files>tests/testthat/test-layout.R</files>
  <action>
Generate test plots in R to visually verify the layout engine integration. The executor should generate the plots listed in how-to-verify and present the output to the user.
  </action>
  <verify>
User visually inspects the 6 test plots and confirms correct component positioning.
  </verify>
  <done>User approves all 6 test plots render with correct layout positioning.</done>
  <what-built>
Layout engine integration across the full stack:
1. R-side IR extraction of layout metadata (tick labels, subtitle, caption, legend position, secondary axes)
2. JavaScript layout.js module with calculateLayout() pure function
3. gg2d3.js refactored to use layout engine positions instead of hardcoded offsets
4. Unit tests for IR layout metadata

The layout engine replaces all magic numbers (pad.top * 0.6, pad.left - 35, +30/+20/+40/+50 offsets) with content-aware calculations.
  </what-built>
  <how-to-verify>
Generate test plots in R and visually compare D3 output. The positioning may differ slightly from before (improved, not regressed) since the layout engine computes content-aware dimensions rather than hardcoded offsets.

Run these tests:

```r
library(gg2d3)

# Test 1: Basic scatter with title
p1 <- ggplot(mtcars, aes(wt, mpg)) +
  geom_point() +
  labs(title = "Weight vs MPG", x = "Weight (1000 lbs)", y = "Miles per Gallon")
gg2d3(p1)
# CHECK: Title centered above panel. Axis labels visible. Points in panel.

# Test 2: Subtitle and caption
p2 <- ggplot(mtcars, aes(wt, mpg, color = factor(cyl))) +
  geom_point() +
  labs(title = "Motor Trend Cars", subtitle = "Weight vs fuel efficiency",
       caption = "Source: mtcars dataset")
gg2d3(p2)
# CHECK: Title, subtitle below title, caption at bottom. All visible.

# Test 3: Bar chart with categorical axis
p3 <- ggplot(mtcars, aes(factor(cyl))) +
  geom_bar() +
  labs(title = "Cylinder Count", x = "Cylinders", y = "Count")
gg2d3(p3)
# CHECK: Bars render. X-axis labels (4, 6, 8) visible. Y-axis labels visible.

# Test 4: coord_flip
p4 <- ggplot(mtcars, aes(factor(cyl), mpg)) +
  geom_boxplot() +
  coord_flip()
gg2d3(p4)
# CHECK: Boxplots horizontal. Axis labels correct.

# Test 5: coord_fixed
p5 <- ggplot(mtcars, aes(wt, mpg)) +
  geom_point() +
  coord_fixed(ratio = 1)
gg2d3(p5)
# CHECK: Panel maintains aspect ratio. Centered in widget.

# Test 6: Long axis labels
p6 <- ggplot(data.frame(x = c("Very Long Category Name A",
                                "Another Long Category B",
                                "Short C"),
                         y = c(100000, 200000, 300000)),
             aes(x, y)) +
  geom_col()
gg2d3(p6)
# CHECK: Y-axis labels (100000, etc.) have enough space. X labels visible.
```

Verify that:
- All components render within the SVG bounds (no clipping or overflow)
- Titles, subtitles, and captions are visible and properly positioned
- Axis labels are readable and not overlapping the panel
- Panel takes remaining space after all components are allocated
- coord_fixed maintains ratio and centers panel
  </how-to-verify>
  <resume-signal>Type "approved" if all plots render correctly, or describe any positioning issues.</resume-signal>
</task>

</tasks>

<verification>
1. `devtools::test()` passes all tests including new test-layout.R
2. Visual inspection confirms correct positioning across multiple plot types
3. No component overlap or clipping issues
4. coord_fixed and coord_flip continue to work correctly
5. Subtitle and caption render at appropriate positions
</verification>

<success_criteria>
- All 10+ unit tests pass for IR layout metadata
- Visual verification confirms layout engine produces correct component positioning
- No regressions in existing geom rendering
- coord_fixed aspect ratio works with layout engine
- Subtitle and caption visible when provided
</success_criteria>

<output>
After completion, create `.planning/phases/06-layout-engine/06-03-SUMMARY.md`
</output>
