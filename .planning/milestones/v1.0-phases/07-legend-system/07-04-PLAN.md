---
phase: 07-legend-system
plan: 04
type: execute
wave: 3
depends_on: ["07-03"]
files_modified:
  - tests/testthat/test-legends.R
autonomous: false

must_haves:
  truths:
    - "Color legend shows all mapped values with correct hex colors matching ggplot2"
    - "Fill legend shows correct fill colors for bar/area plots"
    - "Size legend displays representative point sizes"
    - "Shape legend shows correct shape symbols"
    - "Merged legend combines color+shape into single legend when mapped to same variable"
    - "Colorbar shows smooth gradient with labeled tick marks for continuous aesthetics"
    - "Legend position works for right, left, top, bottom"
    - "Plots with legend.position='none' show no legend"
  artifacts:
    - path: "tests/testthat/test-legends.R"
      provides: "Unit tests for legend IR extraction"
      contains: "test_that"
  key_links:
    - from: "tests/testthat/test-legends.R"
      to: "R/as_d3_ir.R"
      via: "IR guide extraction verification"
      pattern: "ir\\$guides"
---

<objective>
Test the complete legend system with unit tests for IR extraction and visual verification of rendered legends.

Purpose: Verify all 5 phase success criteria are met: color/fill legends, size legends, shape legends, merged legends, and colorbar gradients. Unit tests catch extraction bugs; visual verification confirms D3 rendering fidelity.

Output: Test file `tests/testthat/test-legends.R` with comprehensive guide extraction tests, plus visual verification of rendered legends across aesthetic types and positions.
</objective>

<execution_context>
@/Users/davidzenz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davidzenz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-legend-system/07-01-SUMMARY.md
@.planning/phases/07-legend-system/07-02-SUMMARY.md
@.planning/phases/07-legend-system/07-03-SUMMARY.md
@tests/testthat/test-layout.R
@R/as_d3_ir.R
</context>

<tasks>

<task type="auto">
  <name>Task 1: Unit tests for legend IR extraction</name>
  <files>tests/testthat/test-legends.R</files>
  <action>
Create `tests/testthat/test-legends.R` following the established test pattern from `test-layout.R` and `test-ir.R`.

**Test cases to implement:**

1. **Discrete colour legend structure**
   - Plot: `ggplot(iris, aes(Sepal.Length, Sepal.Width, color = Species)) + geom_point()`
   - Assert: `length(ir$guides) == 1`
   - Assert: `ir$guides[[1]]$type == "legend"`
   - Assert: `length(ir$guides[[1]]$keys) == 3` (setosa, versicolor, virginica)
   - Assert: Each key has `label` and `colour` fields
   - Assert: Colors are valid hex strings (start with "#")

2. **Discrete fill legend structure**
   - Plot: `ggplot(mtcars, aes(factor(cyl), fill = factor(cyl))) + geom_bar()`
   - Assert: Guide exists with fill values
   - Assert: Keys have `fill` field with hex colors

3. **Continuous colour legend (colorbar)**
   - Plot: `ggplot(iris, aes(Sepal.Length, Sepal.Width, color = Petal.Length)) + geom_point()`
   - Assert: `ir$guides[[1]]$type == "colorbar"`
   - Assert: `guide$colors` is character vector with length >= 20
   - Assert: Colors are hex strings

4. **Size legend**
   - Plot: `ggplot(iris, aes(Sepal.Length, Sepal.Width, size = Petal.Length)) + geom_point()`
   - Assert: Guide exists with type "legend" (discrete size breaks)
   - Assert: Keys have `size` field with numeric values

5. **Shape legend**
   - Plot: `ggplot(iris, aes(Sepal.Length, Sepal.Width, shape = Species)) + geom_point()`
   - Assert: Guide exists with keys having `shape` field

6. **Legend merging (colour + shape same variable)**
   - Plot: `ggplot(iris, aes(Sepal.Length, Sepal.Width, color = Species, shape = Species)) + geom_point()`
   - Assert: `length(ir$guides) == 1` (not 2 separate guides)
   - Assert: Guide has `aesthetics` containing both "colour" and "shape"

7. **No legend when no mapped aesthetics**
   - Plot: `ggplot(iris, aes(Sepal.Length, Sepal.Width)) + geom_point()`
   - Assert: `length(ir$guides) == 0`

8. **No legend when legend.position = "none"**
   - Plot: `ggplot(iris, aes(Sepal.Length, Sepal.Width, color = Species)) + geom_point() + theme(legend.position = "none")`
   - Assert: `length(ir$guides) == 0`

9. **Guide title from scale name**
   - Plot: `ggplot(iris, aes(Sepal.Length, Sepal.Width, color = Species)) + geom_point() + scale_color_discrete(name = "Flower Species")`
   - Assert: `ir$guides[[1]]$title == "Flower Species"`

10. **Multiple separate legends (different variables)**
    - Plot: `ggplot(iris, aes(Sepal.Length, Sepal.Width, color = Species, size = Petal.Length)) + geom_point()`
    - Assert: `length(ir$guides) == 2` (separate color and size legends)

11. **Legend position extraction**
    - Plot with `theme(legend.position = "bottom")`
    - Assert: `ir$legend$position == "bottom"`

12. **Alpha aesthetic legend**
    - Plot: `ggplot(iris, aes(Sepal.Length, Sepal.Width, alpha = Petal.Length)) + geom_point()`
    - Assert: Guide exists with alpha keys (or empty guides if ggplot2 doesn't generate guide for alpha by default)

Each test wrapped in `test_that()` with `library(ggplot2)` inside to match existing pattern.
  </action>
  <verify>
```bash
Rscript -e "library(testthat); library(gg2d3); test_file('tests/testthat/test-legends.R')"
```
All tests should pass. Report the PASS count.
  </verify>
  <done>
test-legends.R contains 12 test cases covering discrete color/fill, continuous colorbar, size, shape, merged legends, no-legend cases, title extraction, multiple legends, position, and alpha. All assertions verify IR guide structure correctness.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Visual verification of legend rendering</name>
  <files>test_output</files>
  <action>
Generate 7 HTML test plots to visually verify legend rendering across all aesthetic types and positions. Save each as HTML file and present to user for verification.

```r
library(ggplot2)
library(gg2d3)

# Test 1: Discrete color legend (right position, default)
p1 <- ggplot(iris, aes(Sepal.Length, Sepal.Width, color = Species)) +
  geom_point() + labs(title = "Color Legend Test")
htmlwidgets::saveWidget(gg2d3(p1), "test_legend_1_color.html")

# Test 2: Continuous colorbar
p2 <- ggplot(iris, aes(Sepal.Length, Sepal.Width, color = Petal.Length)) +
  geom_point() + labs(title = "Colorbar Test")
htmlwidgets::saveWidget(gg2d3(p2), "test_legend_2_colorbar.html")

# Test 3: Fill legend with bar chart
p3 <- ggplot(mtcars, aes(factor(cyl), fill = factor(cyl))) +
  geom_bar() + labs(title = "Fill Legend Test")
htmlwidgets::saveWidget(gg2d3(p3), "test_legend_3_fill.html")

# Test 4: Merged legend (color + shape)
p4 <- ggplot(iris, aes(Sepal.Length, Sepal.Width, color = Species, shape = Species)) +
  geom_point() + labs(title = "Merged Legend Test")
htmlwidgets::saveWidget(gg2d3(p4), "test_legend_4_merged.html")

# Test 5: Legend position = "bottom"
p5 <- ggplot(iris, aes(Sepal.Length, Sepal.Width, color = Species)) +
  geom_point() + theme(legend.position = "bottom") + labs(title = "Bottom Legend Test")
htmlwidgets::saveWidget(gg2d3(p5), "test_legend_5_bottom.html")

# Test 6: No legend
p6 <- ggplot(mtcars, aes(wt, mpg)) +
  geom_point() + labs(title = "No Legend Test")
htmlwidgets::saveWidget(gg2d3(p6), "test_legend_6_none.html")

# Test 7: Size legend
p7 <- ggplot(iris, aes(Sepal.Length, Sepal.Width, size = Petal.Length)) +
  geom_point() + labs(title = "Size Legend Test")
htmlwidgets::saveWidget(gg2d3(p7), "test_legend_7_size.html")
```

Verification checklist:
- Legends appear in correct positions (right/bottom)
- Colors match between legend and data points
- Labels are readable and correctly aligned
- No overlapping between legend and panel
- No empty space when no legend
- Colorbar gradient is smooth (not banded)
  </action>
  <verify>
Open each HTML file in browser and visually inspect. User approves or describes issues.
  </verify>
  <done>
User confirms all 7 test plots render correctly with proper legend appearance, positioning, and no visual regressions.
  </done>
</task>

</tasks>

<verification>
Phase 7 Success Criteria (from Roadmap):
1. Color and fill legends show all mapped values with correct colors -- Tests 1, 3
2. Size legends display representative point sizes from data range -- Test 7
3. Shape legends show all mapped shapes from scale -- Test 4 (merged)
4. Multiple aesthetics merge into single legend when appropriate -- Test 4
5. Continuous aesthetics show gradient colorbars with tick marks -- Test 2
</verification>

<success_criteria>
- All unit tests pass (12 test cases)
- All 7 visual test plots render correctly
- User approves visual output
- No regressions in existing test suite (`devtools::test()` passes)
</success_criteria>

<output>
After completion, create `.planning/phases/07-legend-system/07-04-SUMMARY.md`
</output>
