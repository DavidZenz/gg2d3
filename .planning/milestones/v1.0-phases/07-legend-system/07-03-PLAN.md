---
phase: 07-legend-system
plan: 03
type: execute
wave: 2
depends_on: ["07-01", "07-02"]
files_modified:
  - inst/htmlwidgets/gg2d3.js
autonomous: true

must_haves:
  truths:
    - "Layout engine receives actual legend dimensions (not zero) when guides exist"
    - "Legend renders in the space reserved by layout engine (right/left/top/bottom)"
    - "Panel dimensions shrink correctly to accommodate legend space"
    - "Plots without legends render identically to Phase 6 output (no regressions)"
    - "Legend renders after panel but positioned outside panel area"
  artifacts:
    - path: "inst/htmlwidgets/gg2d3.js"
      provides: "Legend integration in draw() function"
      contains: "renderLegends"
  key_links:
    - from: "inst/htmlwidgets/gg2d3.js"
      to: "window.gg2d3.legend.estimateLegendDimensions"
      via: "pre-render dimension calculation"
      pattern: "estimateLegendDimensions"
    - from: "inst/htmlwidgets/gg2d3.js"
      to: "window.gg2d3.legend.renderLegends"
      via: "post-panel legend rendering"
      pattern: "renderLegends"
    - from: "inst/htmlwidgets/gg2d3.js"
      to: "window.gg2d3.layout.calculateLayout"
      via: "legend dimensions in layout config"
      pattern: "legend.*width|legend.*height"
---

<objective>
Wire the legend system into the main rendering pipeline by connecting guide IR data to the legend module and layout engine.

Purpose: This is the integration plan that connects Plan 07-01 (R-side guide extraction) with Plan 07-02 (D3 legend renderers) through the existing layout engine and main draw function. After this plan, legends appear in rendered plots.

Output: Modified `gg2d3.js` that estimates legend dimensions for layout, then renders legends in reserved space.
</objective>

<execution_context>
@/Users/davidzenz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davidzenz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-legend-system/07-RESEARCH.md
@.planning/phases/07-legend-system/07-01-SUMMARY.md
@.planning/phases/07-legend-system/07-02-SUMMARY.md
@inst/htmlwidgets/gg2d3.js
@inst/htmlwidgets/modules/layout.js
@inst/htmlwidgets/modules/legend.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire legend dimensions into layout configuration</name>
  <files>inst/htmlwidgets/gg2d3.js</files>
  <action>
Modify the `draw()` function in `inst/htmlwidgets/gg2d3.js` to compute actual legend dimensions and pass them to the layout engine.

**Step 1: Compute legend dimensions (before layoutConfig)**

After the theme is created (line ~22) and before the layoutConfig is built (line ~38), add legend dimension computation:

```javascript
// Estimate legend dimensions from IR guides
const legendDims = (ir.guides && ir.guides.length > 0)
  ? window.gg2d3.legend.estimateLegendDimensions(ir.guides, theme)
  : { width: 0, height: 0 };
```

**Step 2: Update layoutConfig legend section**

Replace the existing hardcoded `width: 0, height: 0` in the legend config (lines 60-63) with the computed dimensions:

```javascript
legend: {
  position: (ir.legend && ir.legend.position) || "none",
  width: legendDims.width,
  height: legendDims.height
},
```

This replaces the Phase 6 placeholder that had the comment "Phase 7 will provide actual dimensions".

**Step 3: Render legends after axes (before fallback indicator)**

After the axis title rendering (around line 314) and before the "Fallback indicator if no marks drawn" section, add legend rendering:

```javascript
// Render legends (after panel content, using layout-computed positions)
if (ir.guides && ir.guides.length > 0 && layout.legend.position !== "none") {
  window.gg2d3.legend.renderLegends(root, ir.guides, layout, theme);
}
```

Legends are appended to `root` (the SVG element), NOT to `g` (the panel group), because legends are positioned outside the panel area using absolute coordinates from the layout engine.

**Important: Do NOT modify any other part of the draw function.** The layout engine already handles space reservation via `sliceSide()` -- passing non-zero dimensions is all that's needed for correct panel sizing.

**Summary of changes to gg2d3.js:**
1. Add ~3 lines for legend dimension estimation (after theme creation)
2. Change 2 lines in layoutConfig (width/height values)
3. Add ~3 lines for legend rendering (after axis titles)
4. Remove the comment about "Phase 7 will provide actual dimensions"

Total: ~8 lines changed/added. This is a surgical integration -- the heavy lifting is in legend.js and layout.js.
  </action>
  <verify>
```bash
# Verify legend dimension computation
grep -c "estimateLegendDimensions" inst/htmlwidgets/gg2d3.js

# Verify legend rendering call
grep -c "renderLegends" inst/htmlwidgets/gg2d3.js

# Verify no more "Phase 7" placeholder comment
grep -c "Phase 7" inst/htmlwidgets/gg2d3.js
# Should be 0

# Verify legendDims feeds into layoutConfig
grep "legendDims" inst/htmlwidgets/gg2d3.js

# Verify no hardcoded width: 0, height: 0 for legend
grep -n "width: 0.*Phase\|width: 0.*height: 0" inst/htmlwidgets/gg2d3.js
# Should return 0 matches
```

Then functional test in R:
```r
devtools::load_all()
library(ggplot2)

# Test: plot with color legend renders without error
p <- ggplot(iris, aes(Sepal.Length, Sepal.Width, color = Species)) +
  geom_point() +
  labs(title = "Iris Data")
gg2d3(p)
# Should render without console errors and show legend on right

# Test: plot without legend renders identically to Phase 6
p2 <- ggplot(mtcars, aes(wt, mpg)) + geom_point()
gg2d3(p2)
# Should render without changes (no legend space reserved)

# Test: plot with legend.position = "none"
p3 <- ggplot(iris, aes(Sepal.Length, Sepal.Width, color = Species)) +
  geom_point() +
  theme(legend.position = "none")
gg2d3(p3)
# Should render without legend, panel uses full width
```
  </verify>
  <done>
gg2d3.js draw() function estimates legend dimensions from IR guides and passes them to calculateLayout() for space reservation, then calls renderLegends() to draw legends in the reserved area. Plots without legends render identically to Phase 6 (zero dimensions, no rendering call).
  </done>
</task>

</tasks>

<verification>
1. Color legend appears on right side of scatter plot with mapped color aesthetic
2. Panel width shrinks to accommodate legend (not overlapping)
3. Plot without mapped aesthetics shows no legend and no empty space
4. legend.position = "none" suppresses legend entirely
5. No JavaScript console errors during rendering
6. Existing test suite passes without regressions
</verification>

<success_criteria>
- Legends render in correct position (right by default) with proper spacing from panel
- Panel dimensions adjust correctly via layout engine when legends are present
- No visual regressions for plots without legends
- Integration is minimal (~8 lines) -- bulk of logic in legend.js module
</success_criteria>

<output>
After completion, create `.planning/phases/07-legend-system/07-03-SUMMARY.md`
</output>
