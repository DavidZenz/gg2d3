---
phase: 01-foundation-refactoring
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - inst/htmlwidgets/modules/theme.js
autonomous: true

must_haves:
  truths:
    - "Theme defaults match ggplot2 theme_gray exactly (panel background #EBEBEB, grid white, axis text #4D4D4D)"
    - "User-provided theme elements override defaults via deep merge (nested objects merge, not replace)"
    - "getTheme() path lookup returns merged value or null -- never undefined"
    - "applyAxisStyle() produces identical axis styling to current implementation"
  artifacts:
    - path: "inst/htmlwidgets/modules/theme.js"
      provides: "Theme factory with defaults, deep merge, and axis styling"
      contains: "createTheme"
  key_links:
    - from: "inst/htmlwidgets/modules/theme.js"
      to: "inst/htmlwidgets/modules/constants.js"
      via: "reads gg2d3.constants for convertColor reference"
      pattern: "gg2d3\\.scales\\.convertColor"
---

<objective>
Extract the theme system (default theme object, getTheme() path resolver, applyAxisStyle() function, and grid drawing helpers) from the monolithic draw() function into a standalone theme module.

Purpose: The current draw() function has a 30-line defaultTheme object, an inline getTheme() closure, and applyAxisStyle() all embedded in the rendering path. Extracting these creates a single source of truth for theme defaults and makes the theme system testable and extensible for future phases.
Output: One new JS file `inst/htmlwidgets/modules/theme.js` with complete theme factory.
</objective>

<execution_context>
@/Users/davidzenz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davidzenz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-refactoring/01-RESEARCH.md
@inst/htmlwidgets/gg2d3.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create theme module with defaults, merge, and axis styling</name>
  <files>inst/htmlwidgets/modules/theme.js</files>
  <action>
Create `inst/htmlwidgets/modules/theme.js` that extracts all theme-related logic from gg2d3.js draw() function.

Register on namespace:
```javascript
window.gg2d3 = window.gg2d3 || {};
window.gg2d3.theme = { ... };
```

**Extract these components:**

**1. DEFAULT_THEME object** (from lines 232-254 of current gg2d3.js):
```javascript
DEFAULT_THEME: {
  panel: {
    background: { type: "rect", fill: "#EBEBEB", colour: null },
    border: { type: "blank" }
  },
  plot: {
    background: { type: "rect", fill: "white", colour: "white" },
    margin: { type: "margin", top: 7.3, right: 7.3, bottom: 7.3, left: 7.3 }
  },
  grid: {
    major: { type: "line", colour: "white", linewidth: 1.89 },
    minor: { type: "line", colour: "white", linewidth: 0.945 }
  },
  axis: {
    line: { type: "blank" },
    text: { type: "text", colour: "#4D4D4D", size: 8.8 },
    title: { type: "text", colour: "black", size: 11 },
    ticks: { type: "line", colour: "#333333", linewidth: 1.89 }
  },
  text: {
    title: { type: "text", colour: "black", size: 13.2 }
  }
}
```
These values MUST be identical to the current defaultTheme in draw(). Do not change any value.

**2. createTheme(userTheme) function:**
Returns an object with a `get(path)` method that does the same deep-merge path lookup as the current inline `getTheme` closure (lines 258-267). The logic:
- Split path by "."
- Walk both userTheme and DEFAULT_THEME simultaneously
- Return user value if present, else default value, else null

```javascript
createTheme: function(userTheme) {
  var theme = userTheme || {};
  return {
    get: function(path) {
      var parts = path.split(".");
      var val = theme;
      var def = gg2d3.theme.DEFAULT_THEME;
      for (var i = 0; i < parts.length; i++) {
        val = val && val[parts[i]];
        def = def && def[parts[i]];
      }
      return val || def || null;
    }
  };
}
```

**3. applyAxisStyle(axisGroup, textSpec, lineSpec, tickSpec) function:**
Extract lines 196-222 of current gg2d3.js exactly. This function uses `convertColor()` -- access it via `gg2d3.scales.convertColor()` (from Plan 01's scales module). The function:
- Styles axis text (fill, font-size, font-family, font-weight, font-style) from textSpec
- Hides/styles domain line from lineSpec (blank = stroke:none, line = stroke + stroke-width)
- Styles tick marks from tickSpec

**4. calculatePadding(themeAccessor, irPadding) function:**
Extract the padding calculation logic from lines 270-282:
```javascript
calculatePadding: function(themeAccessor, irPadding) {
  var plotMargin = themeAccessor.get("plot.margin");
  if (plotMargin && plotMargin.type === "margin") {
    return {
      top: plotMargin.top + 30,
      right: plotMargin.right + 20,
      bottom: plotMargin.bottom + 40,
      left: plotMargin.left + 50
    };
  }
  return irPadding || { top: 40, right: 20, bottom: 50, left: 60 };
}
```

**5. drawGrid(g, scale, orientation, gridSpec, breaks, w, h, convertColorFn) function:**
Extract the grid drawing helper from lines 324-353. This renders grid lines onto the panel. Parameters:
- g: D3 selection for the panel group
- scale: D3 scale for tick positions
- orientation: "vertical" or "horizontal"
- gridSpec: theme spec for grid line appearance
- breaks: array of break positions (from IR scales)
- w, h: panel width/height
- convertColorFn: reference to convertColor function

The function checks if gridSpec is blank, gets ticks from breaks or scale domain/ticks, and draws lines.

**CRITICAL:** All fallback values must exactly match current code. The hardcoded values `30`, `20`, `40`, `50` in padding calculation, the `0.8` opacity on grid lines, the fallback colors `"white"`, `"#4D4D4D"`, `"#333333"`, `"black"` -- all must be preserved byte-for-byte.

Do NOT use ES6 import/export. Use `window.gg2d3.theme` namespace.
  </action>
  <verify>
Verify the module by checking:
1. `gg2d3.theme.DEFAULT_THEME.panel.background.fill` === "#EBEBEB"
2. `gg2d3.theme.DEFAULT_THEME.grid.major.linewidth` === 1.89
3. `gg2d3.theme.DEFAULT_THEME.axis.text.size` === 8.8
4. `var t = gg2d3.theme.createTheme({panel: {background: {fill: "red"}}}); t.get("panel.background.fill")` === "red"
5. `var t = gg2d3.theme.createTheme({}); t.get("panel.background.fill")` === "#EBEBEB" (default)
6. `var t = gg2d3.theme.createTheme(null); t.get("axis.line.type")` === "blank"
  </verify>
  <done>
theme.js exists with DEFAULT_THEME, createTheme(), applyAxisStyle(), calculatePadding(), and drawGrid() -- all functionally identical to the current inline implementations in gg2d3.js draw(). Registered on `window.gg2d3.theme` namespace.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add shared helper utilities to constants module</name>
  <files>inst/htmlwidgets/modules/constants.js</files>
  <action>
Extend the constants module (created in Plan 01) to also include the shared helper functions that multiple modules need. Add these to `window.gg2d3.helpers`:

```javascript
window.gg2d3.helpers = {
  // Extract scalar from possible array (line 8 of current gg2d3.js)
  val: function(v) {
    return Array.isArray(v) ? (v.length ? v[0] : null) : v;
  },

  // Parse numeric value (line 9 of current gg2d3.js)
  num: function(v) {
    v = gg2d3.helpers.val(v);
    if (v == null || v === "") return null;
    var n = +v;
    return Number.isFinite(n) ? n : null;
  },

  // Check if string is hex color
  isHexColor: function(s) {
    return typeof s === "string" && /^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(s);
  },

  // Check if string is any valid CSS color (hex or named)
  isValidColor: function(s) {
    if (!s || typeof s !== "string") return false;
    if (gg2d3.helpers.isHexColor(s)) return true;
    var testElem = document.createElement("div");
    testElem.style.color = s;
    return testElem.style.color !== "";
  },

  // Convert column-oriented data to row array (lines 23-38 of current gg2d3.js)
  asRows: function(dat) {
    if (Array.isArray(dat)) return dat;
    if (dat && typeof dat === "object") {
      var keys = Object.keys(dat);
      if (!keys.length) return [];
      var len = (dat[keys[0]] || []).length;
      var rows = new Array(len);
      for (var i = 0; i < len; i++) {
        var r = {};
        for (var j = 0; j < keys.length; j++) {
          r[keys[j]] = dat[keys[j]] ? dat[keys[j]][i] : null;
        }
        rows[i] = r;
      }
      return rows;
    }
    return [];
  }
};
```

These are currently defined inside the factory closure of gg2d3.js and used by every geom renderer. Extracting them to the shared namespace allows geom modules to access them.

**IMPORTANT:** Add this to the EXISTING constants.js file (after the constants section). The constants.js file is loaded first and establishes the namespace, so it is the right place for these foundational helpers.

The implementations must be IDENTICAL to the current versions in gg2d3.js. Pay special attention to:
- `val()` returning `null` for empty arrays (not `undefined`)
- `num()` using `Number.isFinite` (not `isFinite`) to reject NaN/Infinity
- `asRows()` iterating keys by index (the `for (const k of keys)` pattern can be kept or converted to `for` loop -- both work)
  </action>
  <verify>
Test helper functions:
- `gg2d3.helpers.val([5])` === 5
- `gg2d3.helpers.val([])` === null
- `gg2d3.helpers.val("hello")` === "hello"
- `gg2d3.helpers.num("42")` === 42
- `gg2d3.helpers.num(null)` === null
- `gg2d3.helpers.num("abc")` === null
- `gg2d3.helpers.isHexColor("#FF0000")` === true
- `gg2d3.helpers.isHexColor("red")` === false
- `gg2d3.helpers.asRows({x: [1,2], y: [3,4]})` deep equals [{x:1,y:3},{x:2,y:4}]
  </verify>
  <done>
constants.js now also defines `window.gg2d3.helpers` with val(), num(), isHexColor(), isValidColor(), and asRows() -- all functionally identical to current gg2d3.js implementations. These are available to all other modules via the shared namespace.
  </done>
</task>

</tasks>

<verification>
1. theme.js exists and registers on `window.gg2d3.theme`
2. constants.js includes `window.gg2d3.helpers` with all 5 helper functions
3. DEFAULT_THEME values exactly match the defaultTheme in current gg2d3.js draw()
4. createTheme().get() path resolution works for nested paths
5. applyAxisStyle references convertColor via `gg2d3.scales.convertColor`
6. No ES6 import/export syntax in any file
</verification>

<success_criteria>
- theme.js contains DEFAULT_THEME, createTheme(), applyAxisStyle(), calculatePadding(), drawGrid()
- constants.js extended with helpers namespace (val, num, isHexColor, isValidColor, asRows)
- All extracted functions are behaviorally identical to their inline originals
- Theme path lookups return defaults when user theme is empty/null
- Grid drawing produces vertical and horizontal lines with correct opacity (0.8)
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-refactoring/01-02-SUMMARY.md`
</output>
