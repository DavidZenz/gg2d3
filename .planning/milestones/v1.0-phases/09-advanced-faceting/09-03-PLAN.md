---
phase: 09-advanced-faceting
plan: 03
type: execute
wave: 3
depends_on: ["09-02"]
files_modified:
  - inst/htmlwidgets/gg2d3.js
  - inst/htmlwidgets/modules/layout.js
autonomous: true

must_haves:
  truths:
    - "facet_grid(scales='free') renders each panel with its own x and y axis ranges"
    - "facet_grid(scales='free_x') shows per-panel x-axes but shared y-axes"
    - "facet_grid(scales='free_y') shows per-panel y-axes but shared x-axes"
    - "Free scale panels render data within their own panel-specific domain"
    - "Axis tick labels match per-panel breaks (not global breaks)"
    - "facet_wrap with scales='free' also works (extending Phase 8)"
    - "Fixed scale facets continue to work correctly"
  artifacts:
    - path: "inst/htmlwidgets/gg2d3.js"
      provides: "Per-panel axis rendering for free scales, conditional axis visibility"
      contains: "isFreeX"
    - path: "inst/htmlwidgets/modules/layout.js"
      provides: "Layout adjustments for per-panel axis space in free scale mode"
      contains: "free"
  key_links:
    - from: "inst/htmlwidgets/gg2d3.js"
      to: "renderPanel"
      via: "Panel-specific scale domains from panelData.x_range/y_range"
      pattern: "panelData.*range"
    - from: "inst/htmlwidgets/gg2d3.js"
      to: "Per-panel axis rendering"
      via: "isFreeX/isFreeY conditionals on axis rendering"
      pattern: "isFree"
---

<objective>
Implement free scale support for facet_grid (and facet_wrap), enabling per-panel axis ranges and conditional axis rendering based on scale mode (free, free_x, free_y, fixed).

Purpose: Match ggplot2's free scale behavior where each panel can have independent axis ranges, with axes rendered on every panel that needs them.

Output: Free scale rendering for both facet_grid and facet_wrap matching ggplot2's behavior.
</objective>

<execution_context>
@/Users/davidzenz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davidzenz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-advanced-faceting/09-RESEARCH.md
@.planning/phases/09-advanced-faceting/09-01-SUMMARY.md
@.planning/phases/09-advanced-faceting/09-02-SUMMARY.md
@inst/htmlwidgets/gg2d3.js
@inst/htmlwidgets/modules/layout.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Per-panel scale creation and data rendering with free scales</name>
  <files>inst/htmlwidgets/gg2d3.js</files>
  <action>
The existing `renderPanel()` function already creates per-panel scales using `panelData.x_range` and `panelData.y_range` (from Phase 8). For continuous scales, it overrides the domain with panel-specific ranges. This means free scales should already work for DATA RENDERING within panels, since each panel gets panel-specific domains from the IR.

Verify this by testing with a free scale plot. If the data renders correctly within each panel, this task focuses only on the AXIS rendering changes.

**Per-panel axis rendering for free scales:**

Currently, faceted axis rendering (around line 354 in gg2d3.js) renders:
- X-axes on bottom row panels only
- Y-axes on left column panels only
- Using SHARED scales (one axisXScale, one axisYScale for all panels)

For free scales, this must change:
- `scales = "free_x"`: x-axis on EVERY panel (each with its own scale/breaks), y-axis on left column only
- `scales = "free_y"`: y-axis on EVERY panel (each with its own scale/breaks), x-axis on bottom row only
- `scales = "free"`: both axes on EVERY panel

**Implementation:**

Replace the existing faceted axis rendering block with a new approach that:

1. Determine free mode:
```javascript
const scalesMode = (ir.facets && ir.facets.scales) || "fixed";
const isFreeX = scalesMode === "free" || scalesMode === "free_x";
const isFreeY = scalesMode === "free" || scalesMode === "free_y";
```

2. For each panel in `layout.panels`, determine if it should render x-axis and/or y-axis:
```javascript
layout.panels.forEach(function(panelBox) {
  const layoutEntry = ir.facets.layout.find(function(l) { return l.PANEL === panelBox.PANEL; });
  const panelData = (ir.panels || []).find(function(p) { return p.PANEL === panelBox.PANEL; }) || {};
  const isBottomRow = layoutEntry.ROW === maxRow;
  const isLeftCol = layoutEntry.COL === 1;
  const panelW = panelBox.w;
  const panelH = panelBox.h;

  // Render x-axis if bottom row OR free_x/free
  if (isBottomRow || isFreeX) {
    // Create per-panel x scale using this panel's domain
    const xScaleDesc = Object.assign({}, ir.scales.x);
    if (isFreeX && xScaleDesc.type === "continuous" && panelData.x_range) {
      xScaleDesc.domain = panelData.x_range;
    }
    const panelXScale = window.gg2d3.scales.createScale(xScaleDesc, flip ? [panelH, 0] : [0, panelW]);

    const ag = root.append("g").attr("transform", "translate(" + panelBox.x + "," + (panelBox.y + panelH) + ")");
    const xAxisGen = d3.axisBottom(panelXScale);

    // Use panel-specific breaks for free scales
    const panelXBreaks = (isFreeX && panelData.x_breaks) ? panelData.x_breaks :
                         (ir.scales.x && ir.scales.x.breaks);
    if (panelXBreaks && typeof panelXScale.bandwidth !== "function") {
      xAxisGen.tickValues(panelXBreaks);
    }
    if (xTransform && xTransform !== "identity" && typeof panelXScale.bandwidth !== "function") {
      xAxisGen.tickFormat(cleanFormat);
    }

    const xAxis = ag.append("g").attr("class", "axis").call(xAxisGen);
    window.gg2d3.theme.applyAxisStyle(xAxis, axisTextX, axisLineX, axisTicksX);
  }

  // Render y-axis if left column OR free_y/free
  if (isLeftCol || isFreeY) {
    const yScaleDesc = Object.assign({}, ir.scales.y);
    if (isFreeY && yScaleDesc.type === "continuous" && panelData.y_range) {
      yScaleDesc.domain = panelData.y_range;
    }
    const panelYScale = window.gg2d3.scales.createScale(yScaleDesc, flip ? [0, panelW] : [panelH, 0]);

    const ag = root.append("g").attr("transform", "translate(" + panelBox.x + "," + panelBox.y + ")");
    const yAxisGen = d3.axisLeft(panelYScale);

    const panelYBreaks = (isFreeY && panelData.y_breaks) ? panelData.y_breaks :
                         (ir.scales.y && ir.scales.y.breaks);
    if (panelYBreaks && typeof panelYScale.bandwidth !== "function") {
      yAxisGen.tickValues(panelYBreaks);
    }
    if (yTransform && yTransform !== "identity" && typeof panelYScale.bandwidth !== "function") {
      yAxisGen.tickFormat(cleanFormat);
    }

    const yAxis = ag.append("g").attr("class", "axis").call(yAxisGen);
    window.gg2d3.theme.applyAxisStyle(yAxis, axisTextY, axisLineY, axisTicksY);
  }
});
```

This replaces the existing separate "bottomPanels x-axis" and "col1Panels y-axis" blocks for faceted rendering. The new loop handles both fixed and free scales in a single pass.

**IMPORTANT — Categorical scales with free scales:** The `renderPanel()` function already preserves categorical scale domains (Phase 8 decision: categorical-scale-preservation). The axis rendering above also uses `Object.assign` to clone the scale descriptor, so categorical domains won't be overridden. Only continuous scales get panel-specific domains.

**IMPORTANT — facet_wrap free scales:** This implementation works for both facet_wrap and facet_grid since both have `ir.facets.scales`, `ir.facets.layout`, and per-panel `panelData`. facet_wrap free scales will also work with this change.
  </action>
  <verify>
```r
pkgload::load_all()
library(ggplot2)

# Free scales
p1 <- ggplot(mtcars, aes(wt, mpg)) + geom_point() + facet_grid(cyl ~ am, scales = "free")
gg2d3(p1)
# Expected: each panel has its own x and y axis with different ranges

# Free x only
p2 <- ggplot(mtcars, aes(wt, mpg)) + geom_point() + facet_grid(cyl ~ am, scales = "free_x")
gg2d3(p2)
# Expected: per-panel x-axes, shared y-axes on left column

# Free y only
p3 <- ggplot(mtcars, aes(wt, mpg)) + geom_point() + facet_grid(cyl ~ am, scales = "free_y")
gg2d3(p3)
# Expected: per-panel y-axes, shared x-axes on bottom row

# Fixed scales (unchanged)
p4 <- ggplot(mtcars, aes(wt, mpg)) + geom_point() + facet_grid(cyl ~ am)
gg2d3(p4)
# Expected: axes only on outer edges

# facet_wrap free scales
p5 <- ggplot(mtcars, aes(wt, mpg)) + geom_point() + facet_wrap(~ cyl, scales = "free")
gg2d3(p5)
# Expected: per-panel axes
```
  </verify>
  <done>All four scale modes (fixed, free, free_x, free_y) render correctly with per-panel axes and panel-specific scale domains. Both facet_grid and facet_wrap free scales work.</done>
</task>

<task type="auto">
  <name>Task 2: Layout engine adjustments for free scale axis space</name>
  <files>inst/htmlwidgets/modules/layout.js</files>
  <action>
When free scales are active, axes appear on more panels (potentially every panel). This means:
- For `free_y`: y-axis tick labels appear on every panel, not just the left column. The leftmost column still determines the y-axis space allocation, but inner panels need space too.
- For `free_x`: x-axis tick labels appear on every panel, not just the bottom row.

However, the current layout engine only reserves axis space on the outer edges (left side for y-axis, bottom for x-axis). For free scales, the inner axes render WITHIN the panel area overlapping panel content, which is acceptable since each axis is specific to that panel.

Actually, looking at ggplot2's behavior: with free scales, the axis tick labels for inner panels render within/adjacent to the panel, using the same panel spacing area. ggplot2 doesn't add extra spacing for inner panel axes. The panel.spacing serves as the visual gap where inner axes can render.

**Therefore, the layout engine needs minimal changes:**

1. Pass the `scales` mode through to calculateLayout so it can be used by the return object for the rendering layer to query.

2. In the return object, add `scalesMode`:
```javascript
scalesMode: facets ? (facets.scales || "fixed") : "fixed"
```

This allows gg2d3.js to access the scales mode from the layout result without re-reading from IR.

3. No additional spacing is needed for inner axes — the panel.spacing between panels provides visual separation, and inner axes render within the panel bounding box (before the grid/data, similar to outer axes).

If testing reveals that inner axes overlap with panel content or spacing is insufficient, consider adding extra spacing. But start minimal (matching ggplot2's approach) and adjust based on visual verification in Plan 09-04.
  </action>
  <verify>
```r
pkgload::load_all()
library(ggplot2)

# Verify layout returns scalesMode
p <- ggplot(mtcars, aes(wt, mpg)) + geom_point() + facet_grid(cyl ~ am, scales = "free")
gg2d3(p)
# Check browser dev tools: layout object should have scalesMode = "free"
```
  </verify>
  <done>Layout engine exposes scalesMode for rendering layer. Panel spacing handles inner axis visual separation matching ggplot2 behavior.</done>
</task>

</tasks>

<verification>
1. `pkgload::load_all()` succeeds
2. `facet_grid(cyl ~ am, scales = "free")` renders per-panel axes with different tick values
3. `facet_grid(cyl ~ am, scales = "free_x")` renders x-axis on every panel, y-axis on left only
4. `facet_grid(cyl ~ am, scales = "free_y")` renders y-axis on every panel, x-axis on bottom only
5. `facet_grid(cyl ~ am)` (fixed) renders axes on outer edges only (no regression)
6. `facet_wrap(~ cyl, scales = "free")` also works with per-panel axes
7. Data points render within correct panel-specific domains for free scales
</verification>

<success_criteria>
- All four scale modes render axes correctly matching ggplot2 behavior
- Per-panel scale domains are used for data rendering (points don't overflow panels)
- Per-panel breaks are used for axis tick positions (different ticks per panel)
- Categorical scales are NOT overridden by panel ranges (preserves labels)
- Both facet_grid and facet_wrap support free scales
</success_criteria>

<output>
After completion, create `.planning/phases/09-advanced-faceting/09-03-SUMMARY.md`
</output>
