---
phase: 10-interactivity-foundation
plan: 03
type: execute
wave: 3
depends_on: ["10-02"]
files_modified:
  - tests/testthat/test-interactivity.R
autonomous: false

must_haves:
  truths:
    - "gg2d3(p) |> d3_tooltip() produces a valid htmlwidget with tooltip config"
    - "gg2d3(p) |> d3_tooltip() |> d3_hover() chains both interactivity features"
    - "gg2d3(p) without pipe functions renders identically to pre-Phase-10"
    - "Hovering over data points displays tooltip with aesthetic values in browser"
    - "Tooltips reposition to avoid viewport edges"
  artifacts:
    - path: "tests/testthat/test-interactivity.R"
      provides: "Unit tests for pipe functions and interactivity config"
      contains: "test_that"
  key_links:
    - from: "R/d3_tooltip.R"
      to: "inst/htmlwidgets/modules/events.js"
      via: "onRender callback invokes event attachment"
      pattern: "window\\.gg2d3\\.events\\.attachTooltips"
    - from: "R/d3_hover.R"
      to: "inst/htmlwidgets/modules/events.js"
      via: "onRender callback invokes hover attachment"
      pattern: "window\\.gg2d3\\.events\\.attachHover"
---

<objective>
Write unit tests for the interactivity pipe functions and perform visual verification that tooltips work correctly in the browser.

Purpose: Ensures the full pipeline (R pipe API -> JS events -> tooltip rendering) works end-to-end and that static rendering is not broken.

Output: Test file with R-side unit tests + visual confirmation of tooltip functionality.
</objective>

<execution_context>
@/Users/davidzenz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davidzenz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-interactivity-foundation/10-01-SUMMARY.md
@.planning/phases/10-interactivity-foundation/10-02-SUMMARY.md
@R/d3_tooltip.R
@R/d3_hover.R
@tests/testthat/test-ir.R
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create unit tests for interactivity pipe functions</name>
  <files>tests/testthat/test-interactivity.R</files>
  <action>
Create `tests/testthat/test-interactivity.R` with comprehensive tests for the R pipe API.

**Test cases:**

1. **d3_tooltip() returns valid widget:**
   ```r
   p <- ggplot2::ggplot(mtcars, ggplot2::aes(x = wt, y = mpg)) + ggplot2::geom_point()
   w <- gg2d3(p) |> d3_tooltip()
   expect_s3_class(w, "gg2d3")
   expect_true(w$x$interactivity$tooltip$enabled)
   ```

2. **d3_tooltip() with fields parameter:**
   ```r
   w <- gg2d3(p) |> d3_tooltip(fields = c("x", "y"))
   expect_equal(w$x$interactivity$tooltip$fields, c("x", "y"))
   ```

3. **d3_tooltip() with formatter parameter:**
   ```r
   w <- gg2d3(p) |> d3_tooltip(formatter = "return field + ': ' + value.toFixed(1)")
   expect_equal(w$x$interactivity$tooltip$formatter, "return field + ': ' + value.toFixed(1)")
   ```

4. **d3_tooltip() rejects non-widget input:**
   ```r
   expect_error(d3_tooltip("not a widget"), "gg2d3 widget")
   expect_error(d3_tooltip(list(x = 1)), "gg2d3 widget")
   ```

5. **d3_hover() returns valid widget:**
   ```r
   w <- gg2d3(p) |> d3_hover()
   expect_s3_class(w, "gg2d3")
   expect_true(w$x$interactivity$hover$enabled)
   expect_equal(w$x$interactivity$hover$opacity, 0.7)
   ```

6. **d3_hover() with custom params:**
   ```r
   w <- gg2d3(p) |> d3_hover(opacity = 0.3, stroke = "red", stroke_width = 2)
   expect_equal(w$x$interactivity$hover$opacity, 0.3)
   expect_equal(w$x$interactivity$hover$stroke, "red")
   expect_equal(w$x$interactivity$hover$stroke_width, 2)
   ```

7. **d3_hover() rejects non-widget input:**
   ```r
   expect_error(d3_hover(42), "gg2d3 widget")
   ```

8. **Pipe chaining works (tooltip + hover):**
   ```r
   w <- gg2d3(p) |> d3_tooltip() |> d3_hover()
   expect_true(w$x$interactivity$tooltip$enabled)
   expect_true(w$x$interactivity$hover$enabled)
   ```

9. **Static rendering unaffected (backward compat):**
   ```r
   w <- gg2d3(p)
   expect_null(w$x$interactivity)
   expect_s3_class(w, "gg2d3")
   ```

10. **d3_tooltip() defaults: fields NULL, formatter NULL:**
    ```r
    w <- gg2d3(p) |> d3_tooltip()
    expect_null(w$x$interactivity$tooltip$fields)
    expect_null(w$x$interactivity$tooltip$formatter)
    ```

Run all tests: `devtools::test()` -- all existing + new tests must pass.
  </action>
  <verify>
`devtools::test()` passes with 0 failures. New test file has at least 10 test assertions covering both pipe functions and edge cases.
  </verify>
  <done>
Unit tests confirm d3_tooltip() and d3_hover() produce correct widget structures, validate input, support chaining, and don't affect static rendering.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Visual verification of tooltip and hover interactivity</name>
  <files>None (verification only)</files>
  <action>
Verify the complete interactivity pipeline in the browser. Run the following test scenarios in R:

1. Basic tooltip on scatter plot:
   `p <- ggplot(mtcars, aes(x = wt, y = mpg, color = factor(cyl))) + geom_point(size = 3)`
   `gg2d3(p) |> d3_tooltip()`
   EXPECTED: Hover over any point shows tooltip with x, y, colour values.

2. Tooltip with specific fields:
   `gg2d3(p) |> d3_tooltip(fields = c("x", "y"))`
   EXPECTED: Tooltip shows only x and y values (not colour).

3. Tooltip on bar chart:
   `p2 <- ggplot(mpg, aes(x = class)) + geom_bar(fill = "steelblue")`
   `gg2d3(p2) |> d3_tooltip()`
   EXPECTED: Hover over bars shows tooltip with bar values.

4. Tooltip + hover combined:
   `gg2d3(p) |> d3_tooltip() |> d3_hover(opacity = 0.3)`
   EXPECTED: Hover dims all other points, shows tooltip on hovered point.

5. Static rendering unbroken:
   `gg2d3(p)`
   EXPECTED: Same output as before Phase 10, no console errors.

6. Viewport edge positioning: hover over points near right/bottom edges.
   EXPECTED: Tooltip repositions to stay within viewport.
  </action>
  <verify>User visually confirms all 6 scenarios work correctly in the browser.</verify>
  <done>Tooltips display on hover with correct data values, hover dimming works, static rendering unchanged, viewport positioning correct.</done>
</task>

</tasks>

<verification>
1. `devtools::test()` passes with all existing and new tests
2. New test file has 10+ assertions covering both pipe functions
3. Tooltips display on hover for point, bar, and rect geoms
4. Tooltip content matches data values bound to elements
5. Hover dimming works when d3_hover() is piped
6. Static rendering (no pipe functions) is unchanged
7. No JavaScript console errors in browser
</verification>

<success_criteria>
- All unit tests pass
- Visual verification confirms tooltips display on hover with correct data
- Tooltip positions dynamically to avoid viewport edges
- d3_hover() dims non-hovered elements correctly
- Static rendering has zero regressions
</success_criteria>

<output>
After completion, create `.planning/phases/10-interactivity-foundation/10-03-SUMMARY.md`
</output>
