---
phase: 08-basic-faceting
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - inst/htmlwidgets/modules/layout.js
autonomous: true

must_haves:
  truths:
    - "calculateLayout() returns panels array with per-panel x/y/w/h positions for multi-panel grids"
    - "calculateLayout() returns strips array with per-strip x/y/w/h and label text"
    - "Panel spacing from theme is applied between panels in the grid"
    - "Strip height is reserved above each panel row, reducing panel height"
    - "Single-panel (non-faceted) layout still works unchanged"
  artifacts:
    - path: "inst/htmlwidgets/modules/layout.js"
      provides: "Multi-panel grid calculation in calculateLayout()"
      contains: "facets"
  key_links:
    - from: "inst/htmlwidgets/modules/layout.js"
      to: "config.facets"
      via: "facet configuration input"
      pattern: "config\\.facets"
    - from: "inst/htmlwidgets/modules/layout.js"
      to: "return"
      via: "panels and strips arrays in layout result"
      pattern: "panels:"
---

<objective>
Extend the layout engine to calculate multi-panel grid positions for facet_wrap.

Purpose: The layout engine must compute pixel positions for each panel in a grid, including strip label positions, panel spacing, and per-panel clip paths. This is a pure calculation with no rendering -- rendering happens in plan 08-03.

Output: Updated calculateLayout() that accepts facet config and returns panels[] and strips[] arrays alongside existing single-panel layout data.
</objective>

<execution_context>
@/Users/davidzenz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davidzenz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-basic-faceting/08-RESEARCH.md
@.planning/phases/06-layout-engine/06-01-SUMMARY.md
@inst/htmlwidgets/modules/layout.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add multi-panel grid calculation to calculateLayout()</name>
  <files>inst/htmlwidgets/modules/layout.js</files>
  <action>
  Extend calculateLayout() to handle faceted plots. The config object gains a new optional `facets` field:

  ```javascript
  config.facets = {
    type: "wrap",           // "null" or "wrap"
    nrow: 2,
    ncol: 2,
    layout: [{PANEL: 1, ROW: 1, COL: 1}, ...],
    strips: [{PANEL: 1, label: "4"}, ...],
    spacing: 7.3            // panel.spacing in pixels
  }
  ```

  **Modification points in calculateLayout():**

  **1. Accept facets in destructuring (line ~261):**
  Add `facets` to the destructured config: `const { width, height, theme, titles, axes, legend, coord, facets } = config;`

  **2. Determine if faceted:**
  ```javascript
  const isFaceted = facets && facets.type === "wrap" && facets.layout && facets.layout.length > 1;
  ```

  **3. Calculate strip dimensions (add after tickLength calculation, ~line 269):**
  ```javascript
  // Strip dimensions (for faceted plots)
  let stripHeight = 0;
  if (isFaceted) {
    const stripTextSize = getStripTextSize(theme);
    // Strip height = text height + top/bottom margin (4.4pt each = ~5.9px each)
    const stripMargin = ptToPx(4.4);
    stripHeight = estimateTextHeight(stripTextSize) + stripMargin * 2;
  }
  ```

  Add helper function `getStripTextSize(theme)`:
  ```javascript
  function getStripTextSize(theme) {
    const ptToPx = window.gg2d3.constants.ptToPx;
    const stripText = theme.get("strip.text");
    return stripText && stripText.size ? ptToPx(stripText.size) : ptToPx(8.8);
  }
  ```

  **4. After the existing panel calculation (after coord_fixed block, ~line 384), add the facet grid computation:**

  If `isFaceted`:
  ```javascript
  if (isFaceted) {
    const nrow = facets.nrow;
    const ncol = facets.ncol;
    const spacing = facets.spacing || 7.3;

    // Available space is the computed single-panel area
    const availX = panel.x;
    const availY = panel.y;
    const availW = panel.w;
    const availH = panel.h;

    // Total spacing between panels
    const totalSpacingX = (ncol - 1) * spacing;
    const totalSpacingY = (nrow - 1) * spacing;

    // Total strip height (one strip row per panel row)
    const totalStripHeight = nrow * stripHeight;

    // Panel dimensions after accounting for spacing and strips
    const panelW = (availW - totalSpacingX) / ncol;
    const panelH = (availH - totalSpacingY - totalStripHeight) / nrow;

    // Build panels array from layout data
    const panelsArr = facets.layout.map(function(item) {
      const col = item.COL - 1;  // 0-indexed
      const row = item.ROW - 1;

      // Each row occupies: stripHeight + panelH + spacing
      const rowBlockH = stripHeight + panelH;

      return {
        PANEL: item.PANEL,
        x: availX + col * (panelW + spacing),
        y: availY + row * (rowBlockH + spacing) + stripHeight,
        w: panelW,
        h: panelH,
        clipId: "panel-" + item.PANEL + "-clip-" + Math.random().toString(36).substr(2, 6)
      };
    });

    // Build strips array
    const stripsArr = facets.strips.map(function(strip) {
      // Find corresponding panel layout entry
      var panelLayout = panelsArr.find(function(p) { return p.PANEL === strip.PANEL; });
      if (!panelLayout) return null;

      return {
        PANEL: strip.PANEL,
        x: panelLayout.x,
        y: panelLayout.y - stripHeight,  // strip is above its panel
        w: panelLayout.w,
        h: stripHeight,
        label: strip.label
      };
    }).filter(Boolean);

    // Store in result (see step 5)
  }
  ```

  **5. Update the return object:**

  Currently `panels: null` and `strips: null` are returned at the bottom. Replace with the computed arrays when faceted:

  For faceted plots, set:
  - `panels`: the panelsArr computed above
  - `strips`: the stripsArr computed above
  - Keep the existing `panel` field as the FIRST panel's position (for backward compatibility and axis positioning reference)

  For non-faceted plots, keep `panels: null` and `strips: null` (unchanged).

  Also, update the `panel` field for faceted plots to reflect the bounding box of all panels (for axis label positioning):
  ```javascript
  // For axis label centering, panel should span the full grid
  // panel.x = leftmost panel x, panel.w = rightmost panel right edge - leftmost panel x
  if (isFaceted && panelsArr.length > 0) {
    const minX = Math.min(...panelsArr.map(p => p.x));
    const maxRight = Math.max(...panelsArr.map(p => p.x + p.w));
    const minY = Math.min(...panelsArr.map(p => p.y));
    const maxBottom = Math.max(...panelsArr.map(p => p.y + p.h));
    panel = {
      x: minX,
      y: minY,
      w: maxRight - minX,
      h: maxBottom - minY
    };
  }
  ```

  Then recompute axis label positions from updated panel dimensions.

  **6. Export stripHeight for rendering:**
  Add `stripHeight` to the return object so the renderer knows how tall strips are.

  **Important architectural notes:**
  - For fixed scales (Phase 8): axes render ONCE on the outer edges of the grid, not per-panel. The axis positioning code already computes based on `panel` bounding box, which is correct.
  - The `clipId` in the return object is for the single-panel case. For faceted plots, each panel has its own clipId in the `panels` array.
  - coord_fixed is NOT supported with facets in Phase 8 (ggplot2 ignores coord_fixed with facets). Skip the coord_fixed block when isFaceted.
  </action>
  <verify>
  Create a quick test in browser console or Node.js (if feasible). Since this is a pure function, verify by:

  1. Check that layout.js has no syntax errors:
  ```bash
  node -c inst/htmlwidgets/modules/layout.js
  ```

  2. Verify key patterns exist:
  ```bash
  grep -c "isFaceted" inst/htmlwidgets/modules/layout.js  # Should be > 0
  grep -c "panelsArr" inst/htmlwidgets/modules/layout.js  # Should be > 0
  grep -c "stripsArr" inst/htmlwidgets/modules/layout.js  # Should be > 0
  grep -c "stripHeight" inst/htmlwidgets/modules/layout.js  # Should be > 0
  grep -c "getStripTextSize" inst/htmlwidgets/modules/layout.js  # Should be > 0
  ```
  </verify>
  <done>
  calculateLayout() accepts facets config, computes per-panel positions in a grid with spacing, computes strip positions above each panel, and returns panels[] and strips[] arrays. Non-faceted plots return panels: null as before. No syntax errors in layout.js.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add getStripTextSize and getStripTheme helpers</name>
  <files>inst/htmlwidgets/modules/layout.js</files>
  <action>
  Add two helper functions in the "Theme Extraction Helpers" section of layout.js (after getLegendBoxSpacing, ~line 240):

  **1. getStripTextSize(theme):**
  ```javascript
  /**
   * Get strip text font size from theme
   * @param {Object} theme - Theme accessor
   * @returns {number} Font size in pixels
   */
  function getStripTextSize(theme) {
    var ptToPx = window.gg2d3.constants.ptToPx;
    var stripText = theme.get("strip.text");
    return stripText && stripText.size ? ptToPx(stripText.size) : ptToPx(8.8);
  }
  ```

  **2. getStripTheme(theme):**
  ```javascript
  /**
   * Get strip visual styling from theme
   * @param {Object} theme - Theme accessor
   * @returns {Object} Strip theme values for rendering
   */
  function getStripTheme(theme) {
    var ptToPx = window.gg2d3.constants.ptToPx;
    var convertColor = window.gg2d3.scales.convertColor;
    var stripText = theme.get("strip.text") || {};
    var stripBg = theme.get("strip.background") || {};

    return {
      fontSize: stripText.size ? ptToPx(stripText.size) : ptToPx(8.8),
      fontColour: convertColor(stripText.colour || "black"),
      fontFace: stripText.face || "normal",
      fontFamily: stripText.family || "sans-serif",
      bgFill: stripBg.fill ? convertColor(stripBg.fill) : convertColor("grey85"),
      bgColour: stripBg.colour ? convertColor(stripBg.colour) : null,
      bgLinewidth: stripBg.linewidth || 0
    };
  }
  ```

  **3. Export getStripTheme:**
  Add `getStripTheme` to the module exports at the bottom:
  ```javascript
  window.gg2d3.layout = {
    calculateLayout: calculateLayout,
    getStripTheme: getStripTheme,  // ADD THIS
    // ... existing exports
  };
  ```

  This keeps the strip theme retrieval in the layout module (which owns spatial concerns) and makes it available to the renderer in plan 08-03.
  </action>
  <verify>
  ```bash
  node -c inst/htmlwidgets/modules/layout.js  # No syntax errors
  grep "getStripTheme" inst/htmlwidgets/modules/layout.js  # Should appear 3+ times (definition, export, usage)
  grep "getStripTextSize" inst/htmlwidgets/modules/layout.js  # Should appear 2+ times
  ```
  </verify>
  <done>
  getStripTextSize() and getStripTheme() helpers exist in layout.js, exported on window.gg2d3.layout namespace. Strip text defaults to 8.8pt, background defaults to grey85.
  </done>
</task>

</tasks>

<verification>
- `node -c inst/htmlwidgets/modules/layout.js` succeeds (no syntax errors)
- calculateLayout with facets config returns panels array with correct PANEL, x, y, w, h, clipId
- calculateLayout with facets config returns strips array with correct PANEL, x, y, w, h, label
- calculateLayout without facets config returns panels: null and strips: null (backward compatible)
- getStripTheme returns strip styling from theme
</verification>

<success_criteria>
1. layout.js passes syntax check
2. calculateLayout handles both faceted and non-faceted configs
3. panels array positions panels in correct grid with spacing between them
4. strips array positions strip labels above corresponding panels
5. Backward compatibility: non-faceted layouts unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/08-basic-faceting/08-02-SUMMARY.md`
</output>
