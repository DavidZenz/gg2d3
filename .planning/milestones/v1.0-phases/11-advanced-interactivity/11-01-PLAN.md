---
phase: 11-advanced-interactivity
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - R/d3_zoom.R
  - inst/htmlwidgets/modules/zoom.js
  - inst/htmlwidgets/gg2d3.yaml
  - man/d3_zoom.Rd
  - NAMESPACE
autonomous: true

must_haves:
  truths:
    - "User can add zoom with gg2d3(p) |> d3_zoom() syntax"
    - "Mouse wheel zooms in/out on the plot"
    - "Click-drag pans the plot"
    - "Axes update to reflect zoomed domain"
    - "Double-click resets zoom to original view"
    - "Data elements stay within panel bounds during zoom"
  artifacts:
    - path: "R/d3_zoom.R"
      provides: "d3_zoom() R pipe function"
      exports: ["d3_zoom"]
    - path: "inst/htmlwidgets/modules/zoom.js"
      provides: "Zoom behavior module"
      min_lines: 80
    - path: "inst/htmlwidgets/gg2d3.yaml"
      provides: "zoom.js in module load order"
      contains: "zoom.js"
  key_links:
    - from: "R/d3_zoom.R"
      to: "inst/htmlwidgets/modules/zoom.js"
      via: "htmlwidgets::onRender callback calls window.gg2d3.zoom.attach()"
      pattern: "window\\.gg2d3\\.zoom\\.attach"
    - from: "inst/htmlwidgets/modules/zoom.js"
      to: "inst/htmlwidgets/gg2d3.js"
      via: "Reads scales and panel dimensions from rendered SVG"
      pattern: "d3\\.zoom\\("
---

<objective>
Implement d3_zoom() pipe function and zoom.js module enabling mouse-wheel zoom and drag-pan on gg2d3 plots.

Purpose: Zoom is the most fundamental exploration interaction for data visualization. It lets users drill into dense regions of scatter plots, time series, and other continuous-scale plots.

Output: R/d3_zoom.R pipe function, inst/htmlwidgets/modules/zoom.js D3 zoom behavior module, YAML wiring.
</objective>

<execution_context>
@/Users/davidzenz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davidzenz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-advanced-interactivity/11-RESEARCH.md
@.planning/phases/10-interactivity-foundation/10-01-SUMMARY.md
@.planning/phases/10-interactivity-foundation/10-02-SUMMARY.md
@R/d3_tooltip.R
@R/d3_hover.R
@inst/htmlwidgets/modules/events.js
@inst/htmlwidgets/gg2d3.js
@inst/htmlwidgets/gg2d3.yaml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create d3_zoom() R pipe function and zoom.js module</name>
  <files>R/d3_zoom.R, inst/htmlwidgets/modules/zoom.js, man/d3_zoom.Rd, NAMESPACE</files>
  <action>
Create R/d3_zoom.R following the exact pattern from R/d3_tooltip.R:
- Function signature: `d3_zoom(widget, scale_extent = c(1, 8), direction = c("both", "x", "y"))`
- `scale_extent`: numeric vector of length 2 for min/max zoom levels (default 1x to 8x)
- `direction`: which axes to zoom ("both" default, "x" for horizontal only, "y" for vertical only)
- Validate widget is gg2d3 class, validate scale_extent is numeric length 2 with min >= 1
- Store config in `widget$x$interactivity$zoom`
- Use `htmlwidgets::onRender()` with setTimeout(0) pattern (matches tooltip/hover pattern)
- onRender JS calls `window.gg2d3.zoom.attach(el, x.interactivity.zoom)`
- Add roxygen2 docs with @export, examples showing basic zoom and x-only zoom
- Run `roxygen2::roxygenise()` to generate man page and update NAMESPACE

Create inst/htmlwidgets/modules/zoom.js as IIFE module (same pattern as events.js):
- Register on `window.gg2d3.zoom` namespace
- Export `attach(el, config)` function
- Implementation:
  1. Find the SVG element and determine panel dimensions from the rendered DOM
  2. For single-panel plots: find `.panel` group, read its width/height from the panel background rect or clip-path rect
  3. Store references to the original x/y scales by reading the existing axis tick values and data element positions
  4. CRITICAL: Do NOT apply zoom transform to the clipped group. Instead, on zoom event, use `event.transform.rescaleX(originalXScale)` / `rescaleY(originalYScale)` to get new scales, then reposition data elements and redraw axes
  5. Create an invisible zoom overlay rect inside the panel group (fill: none, pointer-events: all) sized to panel dimensions. Call `d3.zoom()` on this overlay
  6. Configure `d3.zoom().scaleExtent(config.scale_extent).translateExtent([[0,0],[panelW,panelH]]).extent([[0,0],[panelW,panelH]])`
  7. On "zoom" event handler:
     - Get new scales via `event.transform.rescaleX/Y()`
     - If direction is "x": only rescale X, keep Y original
     - If direction is "y": only rescale Y, keep X original
     - Reposition all geom elements using new scales (circles: cx/cy, rects: x/y/width/height, paths: regenerate d attribute)
     - Redraw x-axis and y-axis with new scales using `d3.axisBottom(newXScale)` / `d3.axisLeft(newYScale)`
     - Redraw grid lines to match new scale positions
  8. Double-click reset: `.on("dblclick.zoom", null)` to disable D3's default, then `.on("dblclick", function() { svg.transition().duration(750).call(zoom.transform, d3.zoomIdentity); })` on the overlay rect
  9. Use event namespacing `.zoom` to avoid conflicts with Phase 10's `.tooltip` and `.hover` namespaces

IMPORTANT implementation details for repositioning geom elements on zoom:
- For `circle.geom-point`: update `cx` and `cy` attributes using new scales and bound data
- For `rect.geom-bar`: update `x`, `y`, `width`, `height` using new scales (handle both stacked and dodged)
- For `path` elements (line, area, density, smooth, ribbon, violin): regenerate the `d` attribute using d3.line()/d3.area() with new scales
- For `text.geom-text`: update `x` and `y` positions
- For `line.geom-segment`: update `x1`, `y1`, `x2`, `y2`
- Each geom type needs its own reposition logic based on bound data (d.x, d.y, etc.)

To reconstruct scales from the rendered DOM:
- Read the IR data that was passed to the widget via the `x` parameter in onRender callback
- The `x.ir.scales.x` and `x.ir.scales.y` contain scale descriptors
- Use `window.gg2d3.scales.createScale()` to create D3 scale objects matching the original rendering
- Get panel dimensions from the layout (or measure from DOM)

For faceted plots: Apply zoom to all panels simultaneously (synchronized zoom per research recommendation). Create a single zoom behavior that updates all panels. Use a shared overlay covering all panels, or apply same transform to each panel's scales independently.
  </action>
  <verify>
Run `Rscript -e "pkgload::load_all(); roxygen2::roxygenise()"` to verify R package loads and docs generate.
Run `node -c inst/htmlwidgets/modules/zoom.js` to verify JavaScript syntax.
Verify `d3_zoom` appears in NAMESPACE.
Verify `man/d3_zoom.Rd` exists.
  </verify>
  <done>
d3_zoom() R function validates input and stores zoom config.
zoom.js module attaches d3.zoom() behavior to panel overlay.
Zoom repositions data elements via scale rescaling (not SVG transform).
Double-click resets to identity transform.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire zoom.js into YAML and verify integration</name>
  <files>inst/htmlwidgets/gg2d3.yaml</files>
  <action>
Add `zoom.js` to the gg2d3.yaml script dependency array. Position it AFTER events.js and BEFORE geom-registry.js in the load order. The zoom module depends on scales.js (for createScale) and should be available before geom modules load.

Updated script order should be:
```
- constants.js
- scales.js
- theme.js
- layout.js
- legend.js
- tooltip.js
- events.js
- zoom.js          # NEW - after events, before geom-registry
- geom-registry.js
- geoms/...
```

After updating YAML, verify the full module loading chain works:
1. Run `Rscript -e "pkgload::load_all(); p <- ggplot2::ggplot(mtcars, ggplot2::aes(mpg, wt)) + ggplot2::geom_point(); w <- gg2d3(p) |> d3_zoom(); cat('Widget created successfully\n')"` to verify R side works end-to-end.
2. Check that zoom.js file size is reasonable (>80 lines of actual code).
  </action>
  <verify>
Run `Rscript -e "pkgload::load_all(); p <- ggplot2::ggplot(mtcars, ggplot2::aes(mpg, wt)) + ggplot2::geom_point(); w <- gg2d3(p) |> d3_zoom(); cat('SUCCESS\n')"` returns "SUCCESS".
YAML file has no duplicate entries and zoom.js is correctly positioned.
  </verify>
  <done>
zoom.js loads in correct order within htmlwidgets dependency chain.
R pipe function creates widget without errors.
Full rendering pipeline intact (static rendering unaffected).
  </done>
</task>

</tasks>

<verification>
1. `pkgload::load_all()` succeeds with no errors
2. `d3_zoom` exported in NAMESPACE
3. `node -c inst/htmlwidgets/modules/zoom.js` passes
4. `Rscript -e "pkgload::load_all(); w <- gg2d3(ggplot2::ggplot(mtcars, ggplot2::aes(mpg,wt)) + ggplot2::geom_point()) |> d3_zoom(); cat('OK\n')"` outputs OK
5. Static rendering (without d3_zoom()) unchanged
</verification>

<success_criteria>
- d3_zoom() pipe function works with same pattern as d3_tooltip()/d3_hover()
- zoom.js creates d3.zoom() behavior on panel overlay
- Mouse wheel zooms, drag pans, double-click resets
- Axes and grid lines update with zoom
- Data elements reposition via scale rescaling (not SVG transform on clipped group)
- Zoom respects panel clip-path (elements don't escape panel bounds)
</success_criteria>

<output>
After completion, create `.planning/phases/11-advanced-interactivity/11-01-SUMMARY.md`
</output>
